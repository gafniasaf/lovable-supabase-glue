{"level":30,"time":1755692097640,"pid":20,"hostname":"b479b09165e0","requestId":"9afb0f36-bbff-4d8c-ba9d-a217baba3135","ms":6,"msg":"route_success"}
{"level":30,"time":1755692097642,"pid":20,"hostname":"b479b09165e0","requestId":"69a5a60d-1c1d-4997-ba5e-2e62ee94d70b","ms":0,"msg":"route_success"}
{"level":30,"time":1755692097652,"pid":20,"hostname":"b479b09165e0","requestId":"fd836406-4abb-423c-8061-f3537b352d29","ms":9,"msg":"route_success"}
{"level":30,"time":1755692097662,"pid":20,"hostname":"b479b09165e0","requestId":"ab9017f6-2a30-43af-9752-fe60877a2cdf","ms":1,"msg":"route_success"}
{"level":30,"time":1755692097740,"pid":20,"hostname":"b479b09165e0","requestId":"16a63cb0-7f6e-4a57-bfdb-7385ab0d3988","ms":1,"msg":"route_success"}
{"level":30,"time":1755692097741,"pid":20,"hostname":"b479b09165e0","requestId":"ee2c8a45-9eaa-421b-b123-e595d2bd6765","ms":1,"msg":"route_success"}
{"level":30,"time":1755692097742,"pid":20,"hostname":"b479b09165e0","requestId":"709bed96-a382-4240-b86e-435396df0699","ms":0,"msg":"route_success"}
{"level":30,"time":1755692097742,"pid":20,"hostname":"b479b09165e0","requestId":"52fb9d7b-81bc-4778-8aa3-16ff5dd156c6","ms":0,"msg":"route_success"}
{"level":30,"time":1755692097743,"pid":20,"hostname":"b479b09165e0","requestId":"13571c9e-5d8a-40b5-b3f0-c2c000e11f61","ms":0,"msg":"route_success"}
{"level":30,"time":1755692097744,"pid":20,"hostname":"b479b09165e0","requestId":"862b1319-ec4f-4fed-8b0d-595ac35beab6","ms":1,"msg":"route_success"}
{"level":30,"time":1755692097745,"pid":20,"hostname":"b479b09165e0","requestId":"ac297972-a7df-4da8-bde4-f8de537e2e5d","ms":0,"msg":"route_success"}
{"level":30,"time":1755692097845,"pid":20,"hostname":"b479b09165e0","requestId":"c0f4a665-6fde-4e7c-a8c9-873f72de9835","ms":0,"msg":"route_success"}
{"level":30,"time":1755692097846,"pid":20,"hostname":"b479b09165e0","requestId":"f9f1306e-4145-4615-970f-da9662e56a5b","ms":1,"msg":"route_success"}
{"level":50,"time":1755692097848,"pid":20,"hostname":"b479b09165e0","requestId":"b7852233-9c8e-4ff6-aacd-b05c56828c1f","issues":[{"path":"updated","message":"Required"}],"msg":"dto_response_validation_failed"}
{"level":30,"time":1755692097848,"pid":20,"hostname":"b479b09165e0","requestId":"eea486d4-12bb-4b1f-9764-40aeac5bdd2a","ms":2,"msg":"route_success"}
{"level":30,"time":1755692097851,"pid":20,"hostname":"b479b09165e0","requestId":"1e39f28c-4e89-404f-b1c1-f92f602f0d06","ms":1,"msg":"route_success"}
{"level":30,"time":1755692097852,"pid":20,"hostname":"b479b09165e0","requestId":"ad0fc2bb-15e6-4f87-8306-a32603373c44","ms":1,"msg":"route_success"}
FAIL tests/unit/future.messaging.spec.ts
  ‚óè Epic E: Messaging (MVP) ‚Ä∫ lists only threads for the current user with unread counts

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      32 |     const rows = await res.json();
      33 |     expect(Array.isArray(rows)).toBe(true);
    > 34 |     expect(rows.every((r: any) => typeof r.unread === 'number')).toBe(true);
         |                                                                  ^
      35 |   });
      36 |
      37 |   test('sends a message into a thread and fans out notifications to participants', async () => {

      at Object.<anonymous> (unit/future.messaging.spec.ts:34:66)

  ‚óè Epic E: Messaging (MVP) ‚Ä∫ marks message as read for the current user and updates unread badge

    TypeError: Cannot read properties of undefined (reading 'unread')

      78 |     const listRes = await threads.GET(new Request('http://localhost/api/messages/threads', { headers: { 'x-test-auth': 'student' } }) as any);
      79 |     const list = await listRes.json();
    > 80 |     expect(list[0].unread).toBe(0);
         |                    ^
      81 |   });
      82 |   test('enforces permissions: unauthenticated yields 401', async () => {
      83 |     // clear test auth

      at Object.<anonymous> (unit/future.messaging.spec.ts:80:20)

  ‚óè Epic E: Messaging (MVP) ‚Ä∫ PATCH /api/messages/threads/[id]/read-all zeroes unread for current user

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

      107 |     globalThis.__TEST_HEADERS_STORE__.cookies.set('x-test-auth', 'student');
      108 |     const patch = await readAll.PATCH(new Request(`http://localhost/api/messages/threads/${thread.id}/read-all`, { method: 'PATCH', headers: { 'x-test-auth': 'student' } }) as any, { params: { id: thread.id } } as any);
    > 109 |     expect(patch.status).toBe(200);
          |                          ^
      110 |     const listRes = await threads.GET(new Request('http://localhost/api/messages/threads', { headers: { 'x-test-auth': 'student' } }) as any);
      111 |     const list = await listRes.json();
      112 |     expect(list[0].unread).toBe(0);

      at Object.<anonymous> (unit/future.messaging.spec.ts:109:26)

  ‚óè Epic E: Messaging (MVP) ‚Ä∫ messages list sorted by created_at and unread increments after new message

    TypeError: Cannot read properties of undefined (reading 'unread')

      138 |     const listThreads = await threads.GET(new Request('http://localhost/api/messages/threads', { headers: { 'x-test-auth': 'student' } }) as any);
      139 |     const ts = await listThreads.json();
    > 140 |     expect(ts[0].unread).toBeGreaterThan(0);
          |                  ^
      141 |   });
      142 |
      143 |   test('PATCH /api/messages without id returns 400 and unknown id returns 404', async () => {

      at Object.<anonymous> (unit/future.messaging.spec.ts:140:18)

FAIL tests/unit/api.runtime.v2.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.runtime.v2.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.runtime.v2.spec.ts:3:1)

FAIL tests/unit/api.flags.providers.users.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.flags.providers.users.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.flags.providers.users.spec.ts:6:1)

{"level":30,"time":1755692097856,"pid":20,"hostname":"b479b09165e0","requestId":"343155cb-69db-4554-b173-b9fc1e56f2ca","ms":0,"msg":"route_success"}
{"level":30,"time":1755692097857,"pid":20,"hostname":"b479b09165e0","requestId":"dc48ce99-4d6c-4a58-803d-fea5c95e714e","ms":1,"msg":"route_success"}
{"level":30,"time":1755692097858,"pid":20,"hostname":"b479b09165e0","requestId":"384cc731-42fb-4659-a897-5028a015a06e","ms":1,"msg":"route_success"}
{"level":30,"time":1755692097858,"pid":20,"hostname":"b479b09165e0","requestId":"913d6380-a41b-4399-a532-9ac28fe4bbf1","ms":0,"msg":"route_success"}
{"level":30,"time":1755692097859,"pid":20,"hostname":"b479b09165e0","requestId":"6d908810-5d2d-418d-ad97-6bccc4ee7d85","ms":0,"msg":"route_success"}
{"level":30,"time":1755692099060,"pid":20,"hostname":"b479b09165e0","requestId":"f7b9a410-7d34-4525-8ec5-72dc7b1188f1","ms":1,"msg":"route_success"}
{"level":30,"time":1755692099060,"pid":20,"hostname":"b479b09165e0","requestId":"2b508c3e-d0f2-44aa-9895-f70dd7ed8e56","ms":0,"msg":"route_success"}
{"level":30,"time":1755692099061,"pid":20,"hostname":"b479b09165e0","requestId":"3593ee6d-0b07-4373-b011-06d23bfc088c","ms":0,"msg":"route_success"}
{"level":30,"time":1755692099061,"pid":20,"hostname":"b479b09165e0","requestId":"cc6a7c7e-0abc-4fd2-9fc6-fc9b6ccd062a","ms":0,"msg":"route_success"}
{"level":30,"time":1755692099062,"pid":20,"hostname":"b479b09165e0","requestId":"54afc407-cded-4248-9bb9-1c3fc5204acc","ms":1,"msg":"route_success"}
{"level":30,"time":1755692099062,"pid":20,"hostname":"b479b09165e0","requestId":"aab4892e-123c-4a8d-8966-9f6ae2913a6e","ms":0,"msg":"route_success"}
{"level":30,"time":1755692099063,"pid":20,"hostname":"b479b09165e0","requestId":"d60cabac-b5d2-4e74-b1c9-fbab97f07504","ms":0,"msg":"route_success"}
{"level":30,"time":1755692099064,"pid":20,"hostname":"b479b09165e0","requestId":"e662cde6-bccd-41b1-bcd8-7faff41bdcd5","ms":0,"msg":"route_success"}
PASS tests/unit/api.reports.spec.ts
PASS tests/unit/lib.runtimeAuth.spec.ts
PASS tests/unit/api.pagination.headers.spec.ts
{"level":30,"time":1755692099937,"pid":20,"hostname":"b479b09165e0","requestId":"7308f62c-d2df-4d5d-a83f-3774472645ed","ms":1,"msg":"route_success"}
{"level":30,"time":1755692099938,"pid":20,"hostname":"b479b09165e0","requestId":"7a6f574f-c8a2-4e89-ac53-9ac280b964be","ms":1,"msg":"route_success"}
{"level":30,"time":1755692099939,"pid":20,"hostname":"b479b09165e0","requestId":"8325b382-eafa-4df1-a5c5-5cdafa25fb68","ms":0,"msg":"route_success"}
{"level":30,"time":1755692099940,"pid":20,"hostname":"b479b09165e0","requestId":"af88c347-ccc4-4dc7-8409-19537c482079","ms":1,"msg":"route_success"}
{"level":30,"time":1755692099940,"pid":20,"hostname":"b479b09165e0","requestId":"b9707946-510b-46fa-ad4f-2c34a8493ef3","ms":0,"msg":"route_success"}
{"level":30,"time":1755692099941,"pid":20,"hostname":"b479b09165e0","requestId":"fb0185cf-0b78-40ef-8d7b-774317ef834a","ms":0,"msg":"route_success"}
{"level":30,"time":1755692099941,"pid":20,"hostname":"b479b09165e0","requestId":"54d6077e-a69a-4b39-be12-9543a3d5f6d2","ms":0,"msg":"route_success"}
{"level":30,"time":1755692100315,"pid":20,"hostname":"b479b09165e0","requestId":"de74a4b9-b1c5-4e9e-87d8-de8e3400ef56","ms":1,"msg":"route_success"}
{"level":30,"time":1755692100316,"pid":20,"hostname":"b479b09165e0","requestId":"8d3ee011-c1c4-4ea8-8731-f24f8b472eb1","ms":1,"msg":"route_success"}
{"level":30,"time":1755692100316,"pid":20,"hostname":"b479b09165e0","requestId":"85858846-4b3a-4e87-b37f-ecc34242f38a","ms":0,"msg":"route_success"}
{"level":30,"time":1755692100317,"pid":20,"hostname":"b479b09165e0","requestId":"fe0b8685-358d-4b68-ac92-e93fed7f0f81","ms":0,"msg":"route_success"}
{"level":30,"time":1755692100318,"pid":20,"hostname":"b479b09165e0","requestId":"14654bdd-84bc-4a66-8e1f-4e04903e18cb","ms":1,"msg":"route_success"}
{"level":50,"time":1755692100422,"pid":20,"hostname":"b479b09165e0","requestId":"b701b979-5e3b-4daa-910c-350d4de4ca52","ms":0,"err":"schema.safeParse is not a function","msg":"route_error"}
FAIL tests/unit/future.notifications.spec.ts
  ‚óè Epic F: Notifications (MVP) ‚Ä∫ marks all notifications as read

    TypeError: schema.safeParse is not a function

      18 |   const { requestId } = opts;
      19 |   const status = typeof opts.status === 'number' ? opts.status : 200;
    > 20 |   const parsed = (schema as any).safeParse(data);
         |                                  ^
      21 |   if (!parsed.success) {
      22 |     try { getRequestLogger(requestId).error({ issues: redactIssues(parsed.error.issues) }, 'dto_response_validation_failed'); } catch {}
      23 |     return NextResponse.json({ error: { code: 'INTERNAL', message: 'Invalid response shape' }, requestId }, { status: 500, headers: { 'x-request-id': requestId } });

      at jsonDto (../apps/web/src/lib/jsonDto.ts:20:34)
      at PATCH (../apps/web/src/app/api/notifications/read-all/route.ts:14:19)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/future.notifications.spec.ts:43:17)

FAIL tests/unit/api.registry.mutations.ratelimit.spec.ts
  ‚óè registry mutations rate-limit headers ‚Ä∫ courses POST returns 429 headers when limited

    TypeError: supabase.from(...).insert is not a function

      106 |   if (!parsed.success) return NextResponse.json({ error: { code: "BAD_REQUEST", message: parsed.error.message }, requestId }, { status: 400, headers: { "x-request-id": requestId } });
      107 |   const supabase = getRouteHandlerSupabase();
    > 108 |   const { data, error } = await supabase.from("external_courses").insert(parsed.data as any).select().single();
          |                                                                   ^
      109 |   if (error) return NextResponse.json({ error: { code: "DB_ERROR", message: error.message }, requestId }, { status: 500, headers: { "x-request-id": requestId } });
      110 |   try { await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'registry.external.create', entity_type: 'external_course', entity_id: (data as any).id, details: parsed.data }); } catch {}
      111 |   try { return jsonDto(externalCourse.parse(data as any), externalCourse as any, { requestId, status: 201 }); } catch { return NextResponse.json({ error: { code: 'INTERNAL', message: 'Invalid external course shape' }, requestId }, { status: 500, headers: { 'x-request-id': requestId } }); }

      at POST (../apps/web/src/app/api/registry/courses/route.ts:108:67)
      at Object.POST (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.registry.mutations.ratelimit.spec.ts:16:17)

  ‚óè registry mutations rate-limit headers ‚Ä∫ courses PATCH returns 429 headers when limited

    TypeError: supabase.from(...).update is not a function

      138 |   if (!parsed.success) return NextResponse.json({ error: { code: "BAD_REQUEST", message: parsed.error.message }, requestId }, { status: 400, headers: { "x-request-id": requestId } });
      139 |   const supabase = getRouteHandlerSupabase();
    > 140 |   const { data, error } = await supabase.from("external_courses").update(parsed.data.data as any).eq("id", parsed.data.id).select().single();
          |                                                                   ^
      141 |   if (error) return NextResponse.json({ error: { code: "DB_ERROR", message: error.message }, requestId }, { status: 500, headers: { "x-request-id": requestId } });
      142 |   try { await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'registry.external.update', entity_type: 'external_course', entity_id: parsed.data.id, details: parsed.data.data }); } catch {}
      143 |   try { return jsonDto(externalCourse.parse(data as any), externalCourse as any, { requestId, status: 200 }); } catch { return NextResponse.json({ error: { code: 'INTERNAL', message: 'Invalid external course shape' }, requestId }, { status: 500, headers: { 'x-request-id': requestId } }); }

      at PATCH (../apps/web/src/app/api/registry/courses/route.ts:140:67)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.registry.mutations.ratelimit.spec.ts:25:17)

  ‚óè registry mutations rate-limit headers ‚Ä∫ courses DELETE returns 429 headers when limited

    TypeError: supabase.from(...).delete is not a function

      167 |   try { q = parseQuery(req, idSchema); } catch (e: any) { return NextResponse.json({ error: { code: 'BAD_REQUEST', message: e.message }, requestId }, { status: 400, headers: { 'x-request-id': requestId } }); }
      168 |   const supabase = getRouteHandlerSupabase();
    > 169 |   const { data, error } = await supabase.from("external_courses").delete().eq("id", q.id).select().single();
          |                                                                         ^
      170 |   if (error) return NextResponse.json({ error: { code: "DB_ERROR", message: error.message }, requestId }, { status: 500, headers: { "x-request-id": requestId } });
      171 |   try { await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'registry.external.delete', entity_type: 'external_course', entity_id: q.id, details: {} }); } catch {}
      172 |   const { jsonDto } = await import('@/lib/jsonDto');

      at DELETE (../apps/web/src/app/api/registry/courses/route.ts:169:73)
      at Object.DELETE (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.registry.mutations.ratelimit.spec.ts:34:17)

  ‚óè registry mutations rate-limit headers ‚Ä∫ versions POST returns 429 headers when limited

    TypeError: supabase.from(...).insert is not a function

      77 |   if (!parsed.success) return NextResponse.json({ error: { code: "BAD_REQUEST", message: parsed.error.message }, requestId }, { status: 400, headers: { "x-request-id": requestId } });
      78 |   const supabase = getRouteHandlerSupabase();
    > 79 |   const { data, error } = await supabase.from("course_versions").insert(parsed.data as any).select().single();
         |                                                                  ^
      80 |   if (error) return NextResponse.json({ error: { code: "DB_ERROR", message: error.message }, requestId }, { status: 500, headers: { "x-request-id": requestId } });
      81 |   try { await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'registry.version.create', entity_type: 'course_version', entity_id: (data as any).id, details: parsed.data }); } catch {}
      82 |   try { return jsonDto(courseVersion.parse(data as any), courseVersion as any, { requestId, status: 201 }); } catch { return NextResponse.json({ error: { code: 'INTERNAL', message: 'Invalid course version shape' }, requestId }, { status: 500, headers: { 'x-request-id': requestId } }); }

      at POST (../apps/web/src/app/api/registry/versions/route.ts:79:66)
      at Object.POST (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.registry.mutations.ratelimit.spec.ts:43:17)

  ‚óè registry mutations rate-limit headers ‚Ä∫ versions PATCH returns 429 headers when limited

    TypeError: supabase.from(...).update is not a function

      108 |   if (!parsed.success) return NextResponse.json({ error: { code: "BAD_REQUEST", message: parsed.error.message }, requestId }, { status: 400, headers: { "x-request-id": requestId } });
      109 |   const supabase = getRouteHandlerSupabase();
    > 110 |   const { data, error } = await supabase.from("course_versions").update(parsed.data as any).eq("id", q.id).select().single();
          |                                                                  ^
      111 |   if (error) return NextResponse.json({ error: { code: "DB_ERROR", message: error.message }, requestId }, { status: 500, headers: { "x-request-id": requestId } });
      112 |   try { await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'registry.version.update', entity_type: 'course_version', entity_id: q.id, details: parsed.data }); } catch {}
      113 |   try { return jsonDto(courseVersion.parse(data as any), courseVersion as any, { requestId, status: 200 }); } catch { return NextResponse.json({ error: { code: 'INTERNAL', message: 'Invalid course version shape' }, requestId }, { status: 500, headers: { 'x-request-id': requestId } }); }

      at PATCH (../apps/web/src/app/api/registry/versions/route.ts:110:66)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.registry.mutations.ratelimit.spec.ts:52:17)

{"level":50,"time":1755692101159,"pid":20,"hostname":"b479b09165e0","requestId":"ef3a5aa1-003c-4625-af19-4cf05fdb236e","ms":2,"err":"supabase.from(...).insert is not a function","msg":"route_error"}
{"level":50,"time":1755692101177,"pid":20,"hostname":"b479b09165e0","requestId":"419c7643-82d7-4eb0-a932-be8184fb3f0b","ms":1,"err":"supabase.from(...).update is not a function","msg":"route_error"}
{"level":50,"time":1755692101179,"pid":20,"hostname":"b479b09165e0","requestId":"8bb40b7b-3567-4ae6-a237-bbbc3d736a66","ms":1,"err":"supabase.from(...).delete is not a function","msg":"route_error"}
{"level":50,"time":1755692101180,"pid":20,"hostname":"b479b09165e0","requestId":"5740dffb-ea64-4103-a145-34955d328f24","ms":0,"err":"supabase.from(...).insert is not a function","msg":"route_error"}
{"level":50,"time":1755692101184,"pid":20,"hostname":"b479b09165e0","requestId":"fc3584a0-e989-469d-8596-7faf6b38fe5b","ms":1,"err":"supabase.from(...).update is not a function","msg":"route_error"}
{"level":30,"time":1755692102027,"pid":20,"hostname":"b479b09165e0","requestId":"09d41264-e8e3-4453-b36e-53b43b6499a5","ms":0,"msg":"route_success"}
{"level":30,"time":1755692102028,"pid":20,"hostname":"b479b09165e0","requestId":"18f73ac2-cd7a-4b04-86e0-e62d7069bb7f","ms":0,"msg":"route_success"}
{"level":30,"time":1755692102029,"pid":20,"hostname":"b479b09165e0","requestId":"73605dd8-ca7f-4d1a-8baf-f95ab82628ac","ms":1,"msg":"route_success"}
{"level":30,"time":1755692102029,"pid":20,"hostname":"b479b09165e0","requestId":"ba6a040c-ea11-4829-b4db-a20b7c3d150f","ms":0,"msg":"route_success"}
{"level":30,"time":1755692102030,"pid":20,"hostname":"b479b09165e0","requestId":"843a3999-3b0a-4a83-be70-19aa2c231625","ms":1,"msg":"route_success"}
{"level":30,"time":1755692102031,"pid":20,"hostname":"b479b09165e0","requestId":"72aeb61a-d941-4bc2-a559-6a3ada2ed52b","ms":1,"msg":"route_success"}
{"level":30,"time":1755692102031,"pid":20,"hostname":"b479b09165e0","requestId":"91e0685e-e03f-4e37-9f78-7b670b8dd472","ms":0,"msg":"route_success"}
PASS tests/unit/api.quizzes.spec.ts
PASS tests/unit/api.quiz-attempts.spec.ts
FAIL tests/unit/api.runtime.auth.exchange.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.runtime.auth.exchange.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.runtime.auth.exchange.spec.ts:2:1)

{"level":30,"time":1755692102659,"pid":20,"hostname":"b479b09165e0","requestId":"77e5b8c6-2beb-40c9-a8c7-6b039f517b78","ms":1,"msg":"route_success"}
{"level":30,"time":1755692102659,"pid":20,"hostname":"b479b09165e0","requestId":"bc122903-0a6a-4afd-ad9b-c8100ff92cfc","ms":0,"msg":"route_success"}
{"level":30,"time":1755692102660,"pid":20,"hostname":"b479b09165e0","requestId":"bf04caf9-4925-4f25-9814-4e7824b76009","ms":1,"msg":"route_success"}
{"level":30,"time":1755692102660,"pid":20,"hostname":"b479b09165e0","requestId":"2f52af8d-4c73-4d1f-90e8-b74d8c302010","ms":0,"msg":"route_success"}
{"level":30,"time":1755692102661,"pid":20,"hostname":"b479b09165e0","requestId":"9b0437e6-cb24-4271-845e-e0ba837e8752","ms":1,"msg":"route_success"}
{"level":30,"time":1755692102661,"pid":20,"hostname":"b479b09165e0","requestId":"f308602b-ccaf-42fc-bfad-ee091f122b64","ms":0,"msg":"route_success"}
{"level":30,"time":1755692102661,"pid":20,"hostname":"b479b09165e0","requestId":"e48fb15a-fbb1-481f-bcbe-842355054b28","ms":0,"msg":"route_success"}
{"level":30,"time":1755692102662,"pid":20,"hostname":"b479b09165e0","requestId":"722ef4d8-27cc-4b11-b1f6-f0561fd6b894","ms":0,"msg":"route_success"}
{"level":30,"time":1755692102662,"pid":20,"hostname":"b479b09165e0","requestId":"48ddebfa-d92a-4b08-8a34-15e6c9a52c0c","ms":0,"msg":"route_success"}
{"level":30,"time":1755692103924,"pid":20,"hostname":"b479b09165e0","requestId":"40b9386e-978c-4418-b86f-fc678b49ada2","ms":0,"msg":"route_success"}
{"level":30,"time":1755692103925,"pid":20,"hostname":"b479b09165e0","requestId":"b7c2bab6-f09f-4f7c-a9aa-a8901fdf1ccf","ms":0,"msg":"route_success"}
{"level":30,"time":1755692103926,"pid":20,"hostname":"b479b09165e0","requestId":"9174fab8-f08b-419d-8618-7e6d14298f1b","ms":0,"msg":"route_success"}
{"level":30,"time":1755692103926,"pid":20,"hostname":"b479b09165e0","requestId":"9e8419cf-0b7f-480c-94fc-95eb83bc485f","ms":0,"msg":"route_success"}
{"level":30,"time":1755692103927,"pid":20,"hostname":"b479b09165e0","requestId":"bc65da0e-e5d9-4af1-8eec-f40d503c0c90","ms":0,"msg":"route_success"}
{"level":30,"time":1755692103927,"pid":20,"hostname":"b479b09165e0","requestId":"158cb9b8-1206-4e57-a8e9-572d42ba8ec4","ms":0,"msg":"route_success"}
{"level":30,"time":1755692103928,"pid":20,"hostname":"b479b09165e0","requestId":"7007fd47-db73-45cd-8d87-8ea789b82d1b","ms":1,"msg":"route_success"}
{"level":30,"time":1755692103928,"pid":20,"hostname":"b479b09165e0","requestId":"9774ce2c-5dd6-4364-9c53-2961afe8c3fe","ms":0,"msg":"route_success"}
{"level":30,"time":1755692103929,"pid":20,"hostname":"b479b09165e0","requestId":"625aaa68-99df-4e73-9433-12fe047e8243","ms":1,"msg":"route_success"}
PASS tests/unit/api.runtime.guard.matrix.spec.ts
PASS tests/unit/api.validation.bad-request.matrix.spec.ts
{"level":30,"time":1755692104574,"pid":20,"hostname":"b479b09165e0","requestId":"d0bbf6ca-1a93-4386-ba2d-61212f0e0ef0","ms":1,"msg":"route_success"}
{"level":30,"time":1755692104576,"pid":20,"hostname":"b479b09165e0","requestId":"7932f6f7-694f-45f8-b7bf-b2c474a29892","ms":1,"msg":"route_success"}
{"level":30,"time":1755692104576,"pid":20,"hostname":"b479b09165e0","requestId":"489ea447-30ea-41b3-be84-74c922ff93f1","ms":0,"msg":"route_success"}
{"level":30,"time":1755692104577,"pid":20,"hostname":"b479b09165e0","requestId":"7a5835e4-0577-4ff6-944b-6429184d8d7b","ms":0,"msg":"route_success"}
{"level":30,"time":1755692104577,"pid":20,"hostname":"b479b09165e0","requestId":"45e7243b-6f02-4a56-9a29-10fe89320fc1","ms":0,"msg":"route_success"}
{"level":30,"time":1755692104578,"pid":20,"hostname":"b479b09165e0","requestId":"cfdf45f3-1858-4ba9-9676-6b7ae6ae2dd7","ms":0,"msg":"route_success"}
{"level":30,"time":1755692104579,"pid":20,"hostname":"b479b09165e0","requestId":"fe4f22a5-ead5-4c5b-a2e8-d87172e097cf","ms":0,"msg":"route_success"}
{"level":30,"time":1755692104580,"pid":20,"hostname":"b479b09165e0","requestId":"dad4bf27-d874-475b-bdba-7ab9ed3a488f","ms":1,"msg":"route_success"}
{"level":30,"time":1755692104580,"pid":20,"hostname":"b479b09165e0","requestId":"68551575-a6e0-4fec-9dda-a5d1da6cc3a9","ms":0,"msg":"route_success"}
{"level":30,"time":1755692104581,"pid":20,"hostname":"b479b09165e0","requestId":"a359880e-1342-4364-a43c-40d07a205e28","ms":1,"msg":"route_success"}
{"level":30,"time":1755692104838,"pid":20,"hostname":"b479b09165e0","requestId":"beba5b52-cd6e-47f0-a8ad-19dbd7a9d17a","ms":0,"msg":"route_success"}
{"level":30,"time":1755692104839,"pid":20,"hostname":"b479b09165e0","requestId":"75a1796c-1097-49da-a54e-7d1f372330b0","ms":1,"msg":"route_success"}
{"level":30,"time":1755692104839,"pid":20,"hostname":"b479b09165e0","requestId":"55970a03-4486-456c-a38e-09a4afb884eb","ms":0,"msg":"route_success"}
{"level":30,"time":1755692104840,"pid":20,"hostname":"b479b09165e0","requestId":"a7672852-59eb-4aa6-9e29-9befc7341360","ms":0,"msg":"route_success"}
{"level":30,"time":1755692104840,"pid":20,"hostname":"b479b09165e0","requestId":"38981309-9353-4974-96cd-a223856b2c08","ms":0,"msg":"route_success"}
{"level":30,"time":1755692104840,"pid":20,"hostname":"b479b09165e0","requestId":"6bfd3eb6-5e33-4b78-9dbd-7f26f900735e","ms":0,"msg":"route_success"}
{"level":30,"time":1755692104841,"pid":20,"hostname":"b479b09165e0","requestId":"4c860e52-63b2-4780-8670-ae01fa386b28","ms":0,"msg":"route_success"}
{"level":30,"time":1755692104841,"pid":20,"hostname":"b479b09165e0","requestId":"3a754be4-db96-4edd-9e1d-241473f1965f","ms":0,"msg":"route_success"}
{"level":30,"time":1755692104841,"pid":20,"hostname":"b479b09165e0","requestId":"7c4b6255-7607-420d-96d9-bb1352ef8632","ms":0,"msg":"route_success"}
FAIL tests/unit/api.parent-links.spec.ts
  ‚óè API /api/parent-links ‚Ä∫ GET unauth ‚Üí 401; missing parent_id ‚Üí 400; non-admin self allowed; non-self forbidden

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 204]

      58 |     globalThis.__TEST_HEADERS_STORE__?.cookies?.set?.('x-test-auth', 'parent');
      59 |     res = await (PLGet as any)(makeGet('http://localhost/api/parent-links?parent_id=test-parent-id'));
    > 60 |     expect([200, 204]).toContain(res.status);
         |                        ^
      61 |     // parent non-self forbidden
      62 |     res = await (PLGet as any)(makeGet('http://localhost/api/parent-links?parent_id=other-parent-id'));
      63 |     expect(res.status).toBe(403);

      at Object.<anonymous> (unit/api.parent-links.spec.ts:60:24)

FAIL tests/unit/ui/NotificationsDropdownClient.spec.tsx
  ‚óè Load more appends items

    expect(received).toBe(expected) // Object.is equality

    Expected: 2
    Received: 20

    Ignored nodes: comments, script, style
    [36m<html>[39m
      [36m<head />[39m
      [36m<body>[39m
        [36m<div>[39m
          [36m<div[39m
            [33mdata-testid[39m=[32m"notif-list"[39m
          [36m>[39m
            [36m<div[39m
              [33mclass[39m=[32m"flex items-center justify-between mb-2"[39m
            [36m>[39m
              [36m<span[39m
                [33mclass[39m=[32m"font-medium"[39m
              [36m>[39m
                [0mNotifications[0m
              [36m</span>[39m
              [36m<button[39m
                [33maria-label[39m=[32m"Mark all notifications as read"[39m
                [33mclass[39m=[32m"underline text-xs"[39m
                [33mdata-testid[39m=[32m"notif-mark-all"[39m
                [33mtitle[39m=[32m"Mark all read"[39m
              [36m>[39m
                [0mMark all[0m
              [36m</button>[39m
            [36m</div>[39m
            [36m<ul[39m
              [33mclass[39m=[32m"space-y-2"[39m
            [36m>[39m
              [36m<li[39m
                [33mclass[39m=[32m"flex items-center justify-between gap-2"[39m
                [33mdata-testid[39m=[32m"notif-item"[39m
              [36m>[39m
                [36m<div[39m
                  [33mclass[39m=[32m""[39m
                [36m>[39m
                  [36m<span>[39m
                    [0msubmission:graded[0m
                  [36m</span>[39m
                  [36m<span[39m
                    [33mclass[39m=[32m"ml-2"[39m
                  [36m>[39m
                    [0mScore: [0m
                    [0m80[0m
                  [36m</span>[39m
                [36m</div>[39m
                [36m<button[39m
                  [33maria-label[39m=[32m"Mark notification no-0000 as read"[39m
                  [33mclass[39m=[32m"underline text-xs"[39m
                  [33mdata-testid[39m=[32m"notif-read-btn"[39m
                [36m>[39m
                  [0mRead[0m
                [36m</button>[39m
              [36m</li>[39m
              [36m<li[39m
                [33mclass[39m=[32m"flex items-center justify-between gap-2"[39m
                [33mdata-testid[39m=[32m"notif-item"[39m
              [36m>[39m
                [36m<div[39m
                  [33mclass[39m=[32m"text-gray-500"[39m
                [36m>[39m
                  [36m<span>[39m
                    [0mmessage:new[0m
                  [36m</span>[39m
                  [36m<a[39m
                    [33mclass[39m=[32m"ml-2 underline"[39m
                    [33mhref[39m=[32m"/labs/system/inbox?thread=th-1"[39m
                  [36m>[39m
                    [0mOpen thread[0m
                  [36m</a>[39m
                [36m</div>[39m
              [36m</li>[39m
              [36m<li[39m
                [33mclass[39m=[32m"flex items-center justify-between gap-2"[39m
                [33mdata-testid[39m=[32m"notif-item"[39m
              [36m>[39m
                [36m<div[39m
                  [33mclass[39m=[32m"text-gray-500"[39m
                [36m>[39m
                  [36m<span>[39m
                    [0mannouncement:published[0m
                  [36m</span>[39m
                [36m</div>[39m
              [36m</li>[39m
              [36m<li[39m
                [33mclass[39m=[32m"flex items-center justify-between gap-2"[39m
                [33mdata-testid[39m=[32m"notif-item"[39m
              [36m>[39m
                [36m<div[39m
                  [33mclass[39m=[32m"text-gray-500"[39m
                [36m>[39m
                  [36m<span>[39m
                    [0msubmission:graded[0m
                  [36m</span>[39m
                  [36m<span[39m
                    [33mclass[39m=[32m"ml-2"[39m
                  [36m>[39m
                    [0mScore: [0m
                    [0m83[0m
                  [36m</span>[39m
                [36m</div>[39m
              [36m</li>[39m
              [36m<li[39m
                [33mclass[39m=[32m"flex items-center justify-between gap-2"[39m
                [33mdata-testid[39m=[32m"notif-item"[39m
              [36m>[39m
                [36m<div[39m
                  [33mclass[39m=[32m"text-gray-500"[39m
                [36m>[39m
                  [36m<span>[39m
                    [0mmessage:new[0m
                  [36m</span>[39m
                  [36m<a[39m
                    [33mclass[39m=[32m"ml-2 underline"[39m
                    [33mhref[39m=[32m"/labs/system/inbox?thread=th-4"[39m
                  [36m>[39m
                    [0mOpen thread[0m
                  [36m</a>[39m
                [36m</div>[39m
              [36m</li>[39m
              [36m<li[39m
                [33mclass[39m=[32m"flex items-center justify-between gap-2"[39m
                [33mdata-testid[39m=[32m"notif-item"[39m
              [36m>[39m
                [36m<div[39m
                  [33mclass[39m=[32m""[39m
                [36m>[39m
                  [36m<span>[39m
                    [0mannouncement:published[0m
                  [36m</span>[39m
                [36m</div>[39m
                [36m<button[39m
                  [33maria-label[39m=[32m"Mark notification no-0005 as read"[39m
                  [33mclass[39m=[32m"underline text-xs"[39m
                  [33mdata-testid[39m=[32m"notif-read-btn"[39m
                [36m>[39m
                  [0mRead[0m
                [36m</button>[39m
              [36m</li>[39m
              [36m<li[39m
                [33mclass[39m=[32m"flex items-center justify-between gap-2"[39m
                [33mdata-testid[39m=[32m"notif-item"[39m
              [36m>[39m
                [36m<div[39m
                  [33mclass[39m=[32m"text-gray-500"[39m
                [36m>[39m
                  [36m<span>[39m
                    [0msubmission:graded[0m
                  [36m</span>[39m
                  [36m<span[39m
                    [33mclass[39m=[32m"ml-2"[39m
                  [36m>[39m
                    [0mScore: [0m
                    [0m86[0m
                  [36m</span>[39m
                [36m</div>[39m
              [36m</li>[39m
              [36m<li[39m
                [33mclass[39m=[32m"flex items-center justify-between gap-2"[39m
                [33mdata-testid[39m=[32m"notif-item"[39m
              [36m>[39m
                [36m<div[39m
                  [33mclass[39m=[32m"text-gray-500"[39m
                [36m>[39m
                  [36m<span>[39m
                    [0mmessage:new[0m
                  [36m</span>[39m
                  [36m<a[39m
                    [33mclass[39m=[32m"ml-2 underline"[39m
                    [33mhref[39m=[32m"/labs/system/inbox?thread=th-7"[39m
                  [36m>[39m
                    [0mOpen thread[0m
                  [36m</a>[39m
                [36m</div>[39m
              [36m</li>[39m
              [36m<li[39m
                [33mclass[39m=[32m"flex items-center justify-between gap-2"[39m
                [33mdata-testid[39m=[32m"notif-item"[39m
              [36m>[39m
                [36m<div[39m
                  [33mclass[39m=[32m"text-gray-500"[39m
                [36m>[39m
                  [36m<span>[39m
                    [0mannouncement:published[0m
                  [36m</span>[39m
                [36m</div>[39m
              [36m</li>[39m
              [36m<li[39m
                [33mclass[39m=[32m"flex items-center justify-between gap-2"[39m
                [33mdata-testid[39m=[32m"notif-item"[39m
              [36m>[39m
                [36m<div[39m
                  [33mclass[39m=[32m"text-gray-500"[39m
                [36m>[39m
                  [36m<span>[39m
                    [0msubmission:graded[0m
                  [36m</span>[39m
                  [36m<span[39m
                    [33mclass[39m=[32m"ml-2"[39m
                  [36m>[39m
                    [0mScore: [0m
                    [0m89[0m
                  [36m</span>[39m
                [36m</div>[39m
              [36m</li>[39m
              [36m<li[39m
                [33mclass[39m=[32m"flex items-center justify-between gap-2"[39m
                [33mdata-testid[39m=[32m"notif-item"[39m
              [36m>[39m
                [36m<div[39m
                  [33mclass[39m=[32m""[39m
                [36m>[39m
                  [36m<span>[39m
                    [0mmessage:new[0m
                  [36m</span>[39m
                  [36m<a[39m
                    [33mclass[39m=[32m"ml-2 underline"[39m
                    [33mhref[39m=[32m"/labs/system/inbox?thread=th-10"[39m
                  [36m>[39m
                    [0mOpen thread[0m
                  [36m</a>[39m
                [36m</div>[39m
                [36m<button[39m
                  [33maria-label[39m=[32m"Mark notification no-0010 as read"[39m
                  [33mclass[39m=[32m"underline text-xs"[39m
                  [33mdata-testid[39m=[32m"notif-read-btn"[39m
                [36m>[39m
                  [0mRead[0m
                [36m</button>[39m
              [36m</li>[39m
              [36m<li[39m
                [33mclass[39m=[32m"flex items-center justify-between gap-2"[39m
                [33mdata-testid[39m=[32m"notif-item"[39m
              [36m>[39m
                [36m<div[39m
                  [33mclass[39m=[32m"text-gray-500"[39m
                [36m>[39m
                  [36m<span>[39m
                    [0mannouncement:published[0m
                  [36m</span>[39m
                [36m</div>[39m
              [36m</li>[39m
              [36m<li[39m
                [33mclass[39m=[32m"flex items-center justify-between gap-2"[39m
                [33mdata-testid[39m=[32m"notif-item"[39m
              [36m>[39m
                [36m<div[39m
                  [33mclass[39m=[32m"text-gray-500"[39m
                [36m>[39m
                  [36m<span>[39m
                    [0msubmission:graded[0m
                  [36m</span>[39m
                  [36m<span[39m
                    [33mclass[39m=[32m"ml-2"[39m
                  [36m>[39m
                    [0mScore: [0m
                    [0m92[0m
                  [36m</span>[39m
                [36m</div>[39m
              [36m</li>[39m
              [36m<li[39m
                [33mclass[39m=[32m"flex items-center justify-between gap-2"[39m
                [33mdata-testid[39m=[32m"notif-item"[39m
              [36m>[39m
                [36m<div[39m
                  [33mclass[39m=[32m"text-gray-500"[39m
                [36m>[39m
                  [36m<span>[39m
                    [0mmessage:new[0m
                  [36m</span>[39m
                  [36m<a[39m
                    [33mclass[39m=[32m"ml-2 underline"[39m
                    [33mhref[39m=[32m"/labs/system/inbox?thread=th-13"[39m
                  [36m>[39m
                    [0mOpen thread[0m
                  [36m</a>[39m
                [36m</div>[39m
              [36m</li>[39m
              [36m<li[39m
                [33mclass[39m=[32m"flex items-center justify-between gap-2"[39m
                [33mdata-testid[39m=[32m"notif-item"[39m
              [36m>[39m
                [36m<div[39m
                  [33mclass[39m=[32m"text-gray-500"[39m
                [36m>[39m
                  [36m<span>[39m
                    [0mannouncement:published[0m
                  [36m</span>[39m
                [36m</div>[39m
              [36m</li>[39m
              [36m<li[39m
                [33mclass[39m=[32m"flex items-center justify-between gap-2"[39m
                [33mdata-testid[39m=[32m"notif-item"[39m
              [36m>[39m
                [36m<div[39m
                  [33mclass[39m=[32m""[39m
                [36m>[39m
                  [36m<span>[39m
                    [0msubmission:graded[0m
                  [36m</span>[39m
                  [36m<span[39m
                    [33mclass[39m=[32m"ml-2"[39m
                  [36m>[39m
                    [0mScore: [0m
                    [0m95[0m
                  [36m</span>[39m
                [36m</div>[39m
                [36m<button[39m
                  [33maria-label[39m=[32m"Mark notification no-0015 as read"[39m
                  [33mclass[39m=[32m"underline text-xs"[39m
                  [33mdata-testid[39m=[32m"notif-read-btn"[39m
                [36m>[39m
                  [0mRead[0m
                [36m</button>[39m
              [36m</li>[39m
              [36m<li[39m
                [33mclass[39m=[32m"flex items-center justify-between gap-2"[39m
                [33mdata-testid[39m=[32m"notif-item"[39m
              [36m>[39m
                [36m<div[39m
                  [33mclass[39m=[32m"text-gray-500"[39m
                [36m>[39m
                  [36m<span>[39m
                    [0mmessage:new[0m
                  [36m</span>[39m
                  [36m<a[39m
                    [33mclass[39m=[32m"ml-2 underline"[39m
                    [33mhref[39m=[32m"/labs/system/inbox?thread=th-16"[39m
                  [36m>[39m
                    [0mOpen thread[0m
                  [36m</a>[39m
                [36m</div>[39m
              [36m</li>[39m
              [36m<li[39m
                [33mclass[39m=[32m"flex items-center justify-between gap-2"[39m
                [33mdata-testid[39m=[32m"notif-item"[39m
              [36m>[39m
                [36m<div[39m
                  [33mclass[39m=[32m"text-gray-500"[39m
                [36m>[39m
                  [36m<span>[39m
                    [0mannouncement:published[0m
                  [36m</span>[39m
                [36m</div>[39m
              [36m</li>[39m
              [36m<li[39m
                [33mclass[39m=[32m"flex items-center justify-between gap-2"[39m
                [33mdata-testid[39m=[32m"notif-item"[39m
              [36m>[39m
                [36m<div[39m
                  [33mclass[39m=[32m"text-gray-500"[39m
                [36m>[39m
                  [36m<span>[39m
                    [0msubmission:graded[0m
                  [36m</span>[39m
                  [36m<span[39m
                    [33mclass[39m=[32m"ml-2"[39m
                  [36m>[39m
                    [0mScore: [0m
                    [0m98[0m
                  [36m</span>[39m
                [36m</div>[39m
              [36m</li>[39m
              [36m<li[39m
                [33mclass[39m=[32m"flex items-center justify-between gap-2"[39m
                [33mdata-testid[39m=[32m"notif-item"[39m
              [36m>[39m
                [36m<div[39m
                  [33mclass[39m=[32m"text-gray-500"[39m
                [36m>[39m
                  [36m<span>[39m
                    [0mmessage:new[0m
                  [36m</span>[39m
                  [36m<a[39m
                    [33mclass[39m=[32m"ml-2 underline"[39m
                    [33mhref[39m=[32m"/labs/system/inbox?thread=th-19"[39m
                  [36m>[39m
                    [0mOpen thread[0m
                  [36m</a>[39m
                [36m</div>[39m
              [36m</li>[39m
            [36m</ul>[39m
            [36m<div[39m
              [33mclass[39m=[32m"mt-2 flex justify-end"[39m
            [36m>[39m
              [36m<button[39m
                [33mclass[39m=[32m"underline text-xs"[39m
                [33mdata-testid[39m=[32m"notif-load-more"[39m
              [36m>[39m
                [0mLoad more[0m
              [36m</button>[39m
            [36m</div>[39m
          [36m</div>[39m
        [36m</div>[39m
      [36m</body>[39m
    [36m</html>[39m

      55 |   render(<NotificationsDropdownClient initial={[]} />);
      56 |   await user.click(screen.getByTestId('notif-load-more'));
    > 57 |   await waitFor(() => expect(screen.getAllByTestId('notif-item').length).toBe(2));
         |                                                                          ^
      58 |   restore();
      59 | });
      60 |

      at unit/ui/NotificationsDropdownClient.spec.tsx:57:74
      at runWithExpensiveErrorDiagnosticsDisabled (../node_modules/@testing-library/dom/dist/config.js:47:12)
      at checkCallback (../node_modules/@testing-library/dom/dist/wait-for.js:124:77)
      at checkRealTimersCallback (../node_modules/@testing-library/dom/dist/wait-for.js:118:16)
      at Timeout.task [as _onTimeout] (../node_modules/jsdom/lib/jsdom/browser/Window.js:579:19)

FAIL tests/unit/api.runtime.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.runtime.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.runtime.spec.ts:5:1)

PASS tests/unit/lib.serverFetch.spec.ts
  ‚óè Console

    console.debug
      [serverFetch] 200 http://localhost:3333/api/ping 0ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:78:13)

    console.debug
      [serverFetch] 200 http://example.com/api/secure 0ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:78:13)

    console.debug
      [serverFetch] 200 http://localhost:3333/api/test 0ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:78:13)

FAIL tests/unit/api.runtime.outcomes.jwks.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.runtime.outcomes.jwks.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.runtime.outcomes.jwks.spec.ts:2:1)

PASS tests/unit/middleware.headers-and-guards.spec.ts
PASS tests/unit/api.announcements.spec.ts
{"level":30,"time":1755692108742,"pid":20,"hostname":"b479b09165e0","requestId":"f975f113-058d-464f-96c7-ed73135436ba","ms":1,"msg":"route_success"}
{"level":30,"time":1755692108742,"pid":20,"hostname":"b479b09165e0","requestId":"22d3c659-0760-46be-b217-bc4020025699","ms":0,"msg":"route_success"}
{"level":30,"time":1755692108743,"pid":20,"hostname":"b479b09165e0","requestId":"66582c66-fb61-4f72-ad64-7109ccf1cebe","ms":1,"msg":"route_success"}
{"level":30,"time":1755692108743,"pid":20,"hostname":"b479b09165e0","requestId":"10153d0a-517e-464c-aad0-3afc65e1643e","ms":0,"msg":"route_success"}
{"level":30,"time":1755692108744,"pid":20,"hostname":"b479b09165e0","requestId":"08a16a82-f775-4fb0-8235-ec5546c0a6ef","ms":1,"msg":"route_success"}
{"level":30,"time":1755692108744,"pid":20,"hostname":"b479b09165e0","requestId":"67a7beff-1b8d-48a2-bf4a-274365833747","ms":0,"msg":"route_success"}
{"level":30,"time":1755692108744,"pid":20,"hostname":"b479b09165e0","requestId":"3256c835-bbe1-401d-81fb-a73ed03c548f","ms":0,"msg":"route_success"}
{"level":30,"time":1755692108745,"pid":20,"hostname":"b479b09165e0","requestId":"a3542d78-7f7e-4302-98ba-bb459ad6c730","ms":0,"msg":"route_success"}
{"level":30,"time":1755692108745,"pid":20,"hostname":"b479b09165e0","requestId":"55412251-a61a-4cc3-97ad-61d997de0e6c","ms":0,"msg":"route_success"}
{"level":50,"time":1755692108976,"pid":20,"hostname":"b479b09165e0","requestId":"316f121c-46d7-468e-8082-cc9876ff64c7","issues":[{"path":"url","message":"Invalid url"}],"msg":"dto_response_validation_failed"}
{"level":30,"time":1755692108977,"pid":20,"hostname":"b479b09165e0","requestId":"7609998b-e783-4a33-b0cf-afc88047a9df","ms":1,"msg":"route_success"}
{"level":50,"time":1755692108980,"pid":20,"hostname":"b479b09165e0","requestId":"5f37ab00-62e3-4743-a24d-88cbed40cf70","issues":[{"path":"url","message":"Invalid url"}],"msg":"dto_response_validation_failed"}
{"level":30,"time":1755692108980,"pid":20,"hostname":"b479b09165e0","requestId":"fdcaede8-8d1c-4a0c-8c50-90b51a7d521e","ms":1,"msg":"route_success"}
{"level":30,"time":1755692108981,"pid":20,"hostname":"b479b09165e0","requestId":"dd187f2a-a999-4b34-af97-7f9dfd961e12","ms":0,"msg":"route_success"}
{"level":30,"time":1755692108989,"pid":20,"hostname":"b479b09165e0","requestId":"c3ea7f6b-002c-4dc5-b63a-b04c75e4a50b","ms":1,"msg":"route_success"}
{"level":30,"time":1755692108989,"pid":20,"hostname":"b479b09165e0","requestId":"d5dbd671-da42-4841-9d0c-b204b465f9d6","ms":0,"msg":"route_success"}
FAIL tests/unit/future.files.spec.ts
  ‚óè Epic H: Files and Media ‚Ä∫ issues an upload URL for a given owner and content type

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

       6 |     globalThis.__TEST_HEADERS_STORE__.cookies.set('x-test-auth', 'teacher');
       7 |     const res = await mod.POST(new Request('http://localhost/api/files/upload-url', { method: 'POST', headers: { 'content-type': 'application/json', 'x-test-auth': 'teacher' }, body: JSON.stringify({ owner_type: 'assignment', owner_id: 'a1', content_type: 'text/plain' }) }) as any);
    >  8 |     expect(res.status).toBe(200);
         |                        ^
       9 |     const json = await res.json();
      10 |     expect(json.url).toContain('/api/files/upload-url');
      11 |   });

      at Object.<anonymous> (unit/future.files.spec.ts:8:24)

  ‚óè Epic H: Files and Media ‚Ä∫ accepts PUT upload and returns a public download URL, then serves bytes

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

      17 |     globalThis.__TEST_HEADERS_STORE__.cookies.set('x-test-auth', 'teacher');
      18 |     const res = await mod.PUT(new Request('http://localhost/api/files/upload-url?owner_type=assignment&owner_id=a1&content_type=text/plain', { method: 'PUT', headers: { 'x-test-auth': 'teacher' }, body: new TextEncoder().encode('hello') }) as any);
    > 19 |     expect(res.status).toBe(200);
         |                        ^
      20 |     const { id, url } = await res.json();
      21 |     expect(id).toBeTruthy();
      22 |     const dl = await import('../../apps/web/src/app/api/files/download-url/route');

      at Object.<anonymous> (unit/future.files.spec.ts:19:24)

FAIL tests/unit/api.runtime.checkpoint.scopes.spec.ts
  ‚óè runtime checkpoint scopes ‚Ä∫ save requires progress.write; load requires progress.read

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 201, 204]

      35 |     token = makeJwt(['progress.write']);
      36 |     res = await (SavePOST as any)(post('http://localhost/api/runtime/checkpoint/save', { key: 'k', state: { a: 1 } }, { authorization: `Bearer ${token}` }));
    > 37 |     expect([200,201,204]).toContain(res.status);
         |                           ^
      38 |     // Load without scope -> 403
      39 |     token = makeJwt([]);
      40 |     res = await (LoadGET as any)(get('http://localhost/api/runtime/checkpoint/load?key=k', { authorization: `Bearer ${token}` }));

      at Object.<anonymous> (unit/api.runtime.checkpoint.scopes.spec.ts:37:27)

{"level":30,"time":1755692109238,"pid":20,"hostname":"b479b09165e0","requestId":"61e57d63-c597-40c6-89ee-ad2717282a0a","ms":8,"msg":"route_success"}
{"level":30,"time":1755692109241,"pid":20,"hostname":"b479b09165e0","requestId":"60a910a6-cd06-48a1-8361-6c7c6ecb08e0","ms":2,"msg":"route_success"}
{"level":30,"time":1755692109481,"pid":20,"hostname":"b479b09165e0","requestId":"642353d8-8022-433f-8482-d37c549bf858","ms":0,"msg":"route_success"}
{"level":30,"time":1755692109482,"pid":20,"hostname":"b479b09165e0","requestId":"260e1311-e53b-4875-b5e2-6792fb21b0f3","ms":1,"msg":"route_success"}
{"level":30,"time":1755692109482,"pid":20,"hostname":"b479b09165e0","requestId":"a8dcaac0-2cff-4550-9b64-39dae0d9170a","ms":0,"msg":"route_success"}
{"level":30,"time":1755692109482,"pid":20,"hostname":"b479b09165e0","requestId":"55c98816-0471-417c-bb59-733f8369c3f7","ms":0,"msg":"route_success"}
FAIL tests/unit/api.messages.threads-and-messages.spec.ts
  ‚óè messages threads and messages (TEST_MODE) ‚Ä∫ thread create has unique participants; unread counts adjust with read

    expect(received).toContain(expected) // indexOf

    Expected value: undefined
    Received array: [0, 1]

      30 |     const teacherThreads = await listTeacherThreads.json();
      31 |     const tRow = teacherThreads.find((x: any) => x.id === thread.id);
    > 32 |     expect([0,1]).toContain(tRow.unread);
         |                   ^
      33 |
      34 |     // mark student's message read as teacher
      35 |     const msgsList = await (MessagesGET as any)(getUrl(`http://localhost/api/messages?thread_id=${thread.id}`, { 'x-test-auth': 'teacher' }));

      at Object.<anonymous> (unit/api.messages.threads-and-messages.spec.ts:32:19)

PASS tests/unit/api.registry.spec.ts
{"level":30,"time":1755692109741,"pid":20,"hostname":"b479b09165e0","requestId":"e65f95f7-ab92-4fa9-8ce5-59edfdaff7e7","ms":1,"msg":"route_success"}
{"level":30,"time":1755692109741,"pid":20,"hostname":"b479b09165e0","requestId":"118f0945-d9cb-4cf1-abf1-47504cf9db5b","ms":0,"msg":"route_success"}
{"level":30,"time":1755692109742,"pid":20,"hostname":"b479b09165e0","requestId":"7640e15e-3895-4cc2-9529-d5c106a0cc5e","ms":0,"msg":"route_success"}
{"level":30,"time":1755692109743,"pid":20,"hostname":"b479b09165e0","requestId":"e7cd6265-5a17-4848-a1a8-7c40caeafcfb","ms":1,"msg":"route_success"}
{"level":30,"time":1755692109743,"pid":20,"hostname":"b479b09165e0","requestId":"708e669a-9244-4379-83b8-9034fc0a601d","ms":0,"msg":"route_success"}
{"level":30,"time":1755692109743,"pid":20,"hostname":"b479b09165e0","requestId":"4471db4f-82c8-40a0-99c3-39c532fcaf92","ms":0,"msg":"route_success"}
{"level":30,"time":1755692109997,"pid":20,"hostname":"b479b09165e0","requestId":"d08e2236-e321-42d3-b9cb-255473bf7789","ms":6,"msg":"route_success"}
{"level":30,"time":1755692110000,"pid":20,"hostname":"b479b09165e0","requestId":"a9a2abbf-0899-4810-b96a-06f012c9d9a9","ms":2,"msg":"route_success"}
FAIL tests/unit/api.runtime.events.scopes.spec.ts
  ‚óè runtime events scopes ‚Ä∫ course.progress requires progress.write; course.attempt.completed requires attempts.write

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 201, 204]

      31 |     token = makeJwt(['progress.write']);
      32 |     res = await (EventsPOST as any)(post('http://localhost/api/runtime/events', { type: 'course.progress', pct: 10 }, { authorization: `Bearer ${token}` }));
    > 33 |     expect([200,201,204]).toContain(res.status);
         |                           ^
      34 |     // Missing attempts.write for attempt.completed -> 403
      35 |     token = makeJwt([]);
      36 |     res = await (EventsPOST as any)(post('http://localhost/api/runtime/events', { type: 'course.attempt.completed', score: 1, max: 1, passed: true }, { authorization: `Bearer ${token}` }));

      at Object.<anonymous> (unit/api.runtime.events.scopes.spec.ts:33:27)

FAIL tests/unit/api.files.download-url.permissions.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.files.download-url.permissions.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.files.download-url.permissions.spec.ts:2:1)

FAIL tests/unit/api.assignments.crud.spec.ts
  ‚óè Assignments CRUD API ‚Ä∫ DELETE role checks

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

      43 |     expect(res.status).toBe(403);
      44 |     res = await (AssignDELETE as any)(makeDelete('http://localhost/api/assignments?id=aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa', { 'x-test-auth': 'teacher' }));
    > 45 |     expect(res.status).toBe(200);
         |                        ^
      46 |   });
      47 | });
      48 |

      at Object.<anonymous> (unit/api.assignments.crud.spec.ts:45:24)

{"level":30,"time":1755692110480,"pid":20,"hostname":"b479b09165e0","requestId":"rq-a","ms":1,"msg":"route_success"}
{"level":30,"time":1755692110481,"pid":20,"hostname":"b479b09165e0","requestId":"f2aaf7a0-45cb-4a81-a055-a9e4e77df10a","ms":1,"msg":"route_success"}
{"level":30,"time":1755692110481,"pid":20,"hostname":"b479b09165e0","requestId":"4309ef69-51f1-4c12-ba9f-504f03b3956e","ms":0,"msg":"route_success"}
{"level":30,"time":1755692110482,"pid":20,"hostname":"b479b09165e0","requestId":"9b2e6585-b130-49fd-a874-5a3b411c0a12","ms":1,"msg":"route_success"}
{"level":30,"time":1755692110482,"pid":20,"hostname":"b479b09165e0","requestId":"a1f445ca-c33a-427e-80a1-bdb1582bda67","ms":0,"msg":"route_success"}
{"level":30,"time":1755692110482,"pid":20,"hostname":"b479b09165e0","requestId":"08138503-d265-4d9f-86be-4d6a337efa26","ms":0,"msg":"route_success"}
{"level":50,"time":1755692110483,"pid":20,"hostname":"b479b09165e0","requestId":"8f59cc0b-8bf9-41b1-acb5-8d49e6905754","issues":[{"path":"id","message":"Required"},{"path":"course_id","message":"Required"},{"path":"title","message":"Required"},{"path":"created_at","message":"Required"}],"msg":"dto_response_validation_failed"}
{"level":30,"time":1755692110483,"pid":20,"hostname":"b479b09165e0","requestId":"c7f5d7aa-06ec-45fc-b655-ac677187685a","ms":1,"msg":"route_success"}
FAIL tests/unit/api.role.guard.matrix.extended.spec.ts
  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'admin/audit-logs',
  url: 'http://localhost/api/admin/audit-logs',
  handler: [AsyncFunction (anonymous)],
  role: 'student'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'admin/audit-logs',
  url: 'http://localhost/api/admin/audit-logs',
  handler: [AsyncFunction (anonymous)],
  role: 'teacher'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'admin/audit-logs',
  url: 'http://localhost/api/admin/audit-logs',
  handler: [AsyncFunction (anonymous)],
  role: 'parent'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'admin/audit-logs',
  url: 'http://localhost/api/admin/audit-logs',
  handler: [AsyncFunction (anonymous)],
  role: 'admin'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'admin/export',
  url: 'http://localhost/api/admin/export',
  handler: [AsyncFunction (anonymous)],
  role: 'student'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'admin/export',
  url: 'http://localhost/api/admin/export',
  handler: [AsyncFunction (anonymous)],
  role: 'teacher'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'admin/export',
  url: 'http://localhost/api/admin/export',
  handler: [AsyncFunction (anonymous)],
  role: 'parent'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'admin/export',
  url: 'http://localhost/api/admin/export',
  handler: [AsyncFunction (anonymous)],
  role: 'admin'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'admin/metrics',
  url: 'http://localhost/api/admin/metrics',
  handler: [AsyncFunction (anonymous)],
  role: 'student'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'admin/metrics',
  url: 'http://localhost/api/admin/metrics',
  handler: [AsyncFunction (anonymous)],
  role: 'teacher'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'admin/metrics',
  url: 'http://localhost/api/admin/metrics',
  handler: [AsyncFunction (anonymous)],
  role: 'parent'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'admin/metrics',
  url: 'http://localhost/api/admin/metrics',
  handler: [AsyncFunction (anonymous)],
  role: 'admin'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'admin/quotas',
  url: 'http://localhost/api/admin/quotas',
  handler: [AsyncFunction (anonymous)],
  role: 'student'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'admin/quotas',
  url: 'http://localhost/api/admin/quotas',
  handler: [AsyncFunction (anonymous)],
  role: 'teacher'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'admin/quotas',
  url: 'http://localhost/api/admin/quotas',
  handler: [AsyncFunction (anonymous)],
  role: 'parent'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'admin/quotas',
  url: 'http://localhost/api/admin/quotas',
  handler: [AsyncFunction (anonymous)],
  role: 'admin'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'users',
  url: 'http://localhost/api/users',
  handler: [AsyncFunction (anonymous)],
  role: 'student'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'users',
  url: 'http://localhost/api/users',
  handler: [AsyncFunction (anonymous)],
  role: 'teacher'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'users',
  url: 'http://localhost/api/users',
  handler: [AsyncFunction (anonymous)],
  role: 'parent'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'users',
  url: 'http://localhost/api/users',
  handler: [AsyncFunction (anonymous)],
  role: 'admin'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'providers/health',
  url: 'http://localhost/api/providers/health',
  handler: [AsyncFunction (anonymous)],
  role: 'student'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'providers/health',
  url: 'http://localhost/api/providers/health',
  handler: [AsyncFunction (anonymous)],
  role: 'teacher'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'providers/health',
  url: 'http://localhost/api/providers/health',
  handler: [AsyncFunction (anonymous)],
  role: 'parent'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'providers/health',
  url: 'http://localhost/api/providers/health',
  handler: [AsyncFunction (anonymous)],
  role: 'admin'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'registry/courses',
  url: 'http://localhost/api/registry/courses',
  handler: [AsyncFunction (anonymous)],
  role: 'student'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'registry/courses',
  url: 'http://localhost/api/registry/courses',
  handler: [AsyncFunction (anonymous)],
  role: 'teacher'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'registry/courses',
  url: 'http://localhost/api/registry/courses',
  handler: [AsyncFunction (anonymous)],
  role: 'parent'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'registry/courses',
  url: 'http://localhost/api/registry/courses',
  handler: [AsyncFunction (anonymous)],
  role: 'admin'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

FAIL tests/unit/api.providers.ratelimit.spec.ts
  ‚óè providers create/update/delete rate-limit headers ‚Ä∫ POST returns 429 with standard headers when limited

    TypeError: supabase.from(...).insert is not a function

      69 |   }
      70 |   const supabase = getRouteHandlerSupabase();
    > 71 |   const { data, error } = await supabase.from('course_providers').insert({ name, jwks_url, domain }).select().single();
         |                                                                   ^
      72 |   if (error) return NextResponse.json({ error: { code: 'DB_ERROR', message: error.message }, requestId }, { status: 500, headers: { 'x-request-id': requestId } });
      73 |   try {
      74 |     await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'provider.create', entity_type: 'provider', entity_id: (data as any).id, details: { name, domain } });

      at POST (../apps/web/src/app/api/providers/route.ts:71:67)
      at Object.POST (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.providers.ratelimit.spec.ts:17:17)

  ‚óè providers create/update/delete rate-limit headers ‚Ä∫ PATCH returns 429 with standard headers when limited

    TypeError: supabase.from(...).update is not a function

      138 |   if (Object.keys(patch).length === 0) return NextResponse.json({ error: { code: 'BAD_REQUEST', message: 'no fields to update' }, requestId }, { status: 400, headers: { 'x-request-id': requestId } });
      139 |   const supabase = getRouteHandlerSupabase();
    > 140 |   const { data, error } = await supabase.from('course_providers').update(patch).eq('id', q.id).select().single();
          |                                                                   ^
      141 |   if (error) return NextResponse.json({ error: { code: 'DB_ERROR', message: error.message }, requestId }, { status: 500, headers: { 'x-request-id': requestId } });
      142 |   try {
      143 |     await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'provider.update', entity_type: 'provider', entity_id: q.id, details: patch });

      at PATCH (../apps/web/src/app/api/providers/route.ts:140:67)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.providers.ratelimit.spec.ts:27:17)

  ‚óè providers create/update/delete rate-limit headers ‚Ä∫ DELETE returns 429 with standard headers when limited

    TypeError: supabase.from(...).delete is not a function

      174 |   try { q = parseQuery(req, idSchema); } catch (e: any) { return NextResponse.json({ error: { code: 'BAD_REQUEST', message: e.message }, requestId }, { status: 400, headers: { 'x-request-id': requestId } }); }
      175 |   const supabase = getRouteHandlerSupabase();
    > 176 |   const { error } = await supabase.from('course_providers').delete().eq('id', q.id);
          |                                                                   ^
      177 |   if (error) return NextResponse.json({ error: { code: 'DB_ERROR', message: error.message }, requestId }, { status: 500, headers: { 'x-request-id': requestId } });
      178 |   try {
      179 |     await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'provider.delete', entity_type: 'provider', entity_id: q.id, details: {} });

      at DELETE (../apps/web/src/app/api/providers/route.ts:176:67)
      at Object.DELETE (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.providers.ratelimit.spec.ts:36:17)

PASS tests/unit/apiHandler.csrf.spec.ts
{"level":50,"time":1755692115441,"pid":20,"hostname":"b479b09165e0","requestId":"3312c496-8212-4885-85a2-5ca6ba16d936","ms":0,"err":"supabase.from(...).insert is not a function","msg":"route_error"}
{"level":50,"time":1755692115451,"pid":20,"hostname":"b479b09165e0","requestId":"70257ab8-9a05-47c6-84ee-8229b4423a97","ms":2,"err":"supabase.from(...).update is not a function","msg":"route_error"}
{"level":50,"time":1755692115451,"pid":20,"hostname":"b479b09165e0","requestId":"1644c0db-2d4f-4c53-8435-e7096ce9fce6","ms":0,"err":"supabase.from(...).delete is not a function","msg":"route_error"}
{"level":30,"time":1755692115791,"pid":20,"hostname":"b479b09165e0","requestId":"86b2501f-a0bd-4fbe-a36b-cf00ac4be331","ms":0,"msg":"route_success"}
{"level":30,"time":1755692115792,"pid":20,"hostname":"b479b09165e0","requestId":"ff468322-1ea9-4f3a-b4e7-298950a6de0b","ms":0,"msg":"route_success"}
{"level":30,"time":1755692115793,"pid":20,"hostname":"b479b09165e0","requestId":"fab10ba3-bbd3-4299-b49e-f68695a340d3","ms":0,"msg":"route_success"}
{"level":30,"time":1755692115793,"pid":20,"hostname":"b479b09165e0","requestId":"505fa8ec-b27a-4684-8894-c9211d1c49ff","ms":0,"msg":"route_success"}
{"level":30,"time":1755692115794,"pid":20,"hostname":"b479b09165e0","requestId":"3c39a27a-39f4-4d89-9b40-dbd61ce9593d","ms":0,"msg":"route_success"}
PASS tests/unit/api.listing.headers.matrix.spec.ts
PASS tests/unit/api.lessons.complete.spec.ts
{"level":30,"time":1755692116133,"pid":20,"hostname":"b479b09165e0","requestId":"fd8b85e2-0f26-4cc4-8fec-ec921e64dbe9","ms":0,"msg":"route_success"}
{"level":30,"time":1755692116134,"pid":20,"hostname":"b479b09165e0","requestId":"db399292-e3cf-4b22-a500-26afc6cad546","ms":0,"msg":"route_success"}
{"level":30,"time":1755692116136,"pid":20,"hostname":"b479b09165e0","requestId":"eac341cb-50f4-4efe-9f15-3a2a1001f252","ms":1,"msg":"route_success"}
{"level":30,"time":1755692116136,"pid":20,"hostname":"b479b09165e0","lessonId":"00000000-0000-0000-0000-00000000ab02","userId":"22222222-2222-2222-2222-222222222222","ms":0,"msg":"progress_marked"}
{"level":30,"time":1755692116136,"pid":20,"hostname":"b479b09165e0","requestId":"fc9dc9fd-218a-4eb3-9c93-d2673e730713","ms":0,"msg":"route_success"}
{"level":30,"time":1755692116143,"pid":20,"hostname":"b479b09165e0","requestId":"cc54c5cf-ebd7-41ee-813c-e7d8f57cc001","ms":1,"msg":"route_success"}
{"level":30,"time":1755692116143,"pid":20,"hostname":"b479b09165e0","lessonId":"11111111-1111-1111-1111-111111111111","userId":"22222222-2222-2222-2222-222222222222","ms":0,"msg":"progress_marked"}
{"level":30,"time":1755692116143,"pid":20,"hostname":"b479b09165e0","requestId":"8049bcc2-7b10-45da-ba68-71db8742635c","ms":0,"msg":"route_success"}
{"level":30,"time":1755692116396,"pid":20,"hostname":"b479b09165e0","requestId":"72a489fc-5244-4cfd-b70d-1dae288ccc2f","ms":6,"msg":"route_success"}
{"level":30,"time":1755692116401,"pid":20,"hostname":"b479b09165e0","requestId":"207b4147-fb35-4de3-b645-5eecdb9ebee5","ms":4,"msg":"route_success"}
{"level":30,"time":1755692116407,"pid":20,"hostname":"b479b09165e0","requestId":"3d10d2fc-40b1-4bdd-b92c-6fe4379bbc0c","ms":3,"msg":"route_success"}
FAIL tests/unit/api.runtime.asset.sign-url.scope.spec.ts
  ‚óè runtime asset sign-url scope ‚Ä∫ valid scope and content-type ‚Üí 200 with url/key

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200]

      32 |     const token = makeJwt(['files.write']);
      33 |     const res = await (AssetSignPOST as any)(post('http://localhost/api/runtime/asset/sign-url', { content_type: 'image/png' }, { authorization: `Bearer ${token}` }));
    > 34 |     expect([200]).toContain(res.status);
         |                   ^
      35 |     const json = await res.json();
      36 |     expect(json.url).toBeTruthy();
      37 |     expect(json.key).toMatch(/runtime\//);

      at Object.<anonymous> (unit/api.runtime.asset.sign-url.scope.spec.ts:34:19)

  ‚óè runtime asset sign-url scope ‚Ä∫ unsupported content type ‚Üí 400

    expect(received).toBe(expected) // Object.is equality

    Expected: 400
    Received: 403

      41 |     const token = makeJwt(['files.write']);
      42 |     const res = await (AssetSignPOST as any)(post('http://localhost/api/runtime/asset/sign-url', { content_type: 'application/x-foo' }, { authorization: `Bearer ${token}` }));
    > 43 |     expect(res.status).toBe(400);
         |                        ^
      44 |   });
      45 | });
      46 |

      at Object.<anonymous> (unit/api.runtime.asset.sign-url.scope.spec.ts:43:24)

PASS tests/unit/gateways/SubmissionsGateway.contract.spec.ts
  ‚óè Console

    console.debug
      [serverFetch] 200 http://web:3022/api/submissions 0ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:78:13)

    console.debug
      [serverFetch] 200 http://web:3022/api/submissions 0ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:78:13)

PASS tests/unit/services.quizAttempts.spec.ts
FAIL tests/unit/api.admin.export.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.admin.export.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.admin.export.spec.ts:3:1)

PASS tests/unit/api.headers.common.matrix.spec.ts
FAIL tests/unit/api.runtime.outcomes.runtime-token.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.runtime.outcomes.runtime-token.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.runtime.outcomes.runtime-token.spec.ts:2:1)

{"level":30,"time":1755692117918,"pid":20,"hostname":"b479b09165e0","requestId":"798167df-736f-4be2-9d6a-8ec72de6f793","ms":0,"msg":"route_success"}
{"level":30,"time":1755692117920,"pid":20,"hostname":"b479b09165e0","requestId":"2c2fdf54-5d4d-4ae8-ba97-0fb1194cd135","ms":1,"msg":"route_success"}
{"level":30,"time":1755692117920,"pid":20,"hostname":"b479b09165e0","requestId":"a34a8aaf-1749-4ccd-a3b0-15466b5d71a6","ms":0,"msg":"route_success"}
{"level":30,"time":1755692117920,"pid":20,"hostname":"b479b09165e0","requestId":"1af72263-ac68-4870-a61f-341fdc757196","ms":0,"msg":"route_success"}
{"level":30,"time":1755692117921,"pid":20,"hostname":"b479b09165e0","requestId":"3feaadfa-1d89-4edb-91f5-5d09f3e6e135","ms":0,"msg":"route_success"}
{"level":30,"time":1755692117921,"pid":20,"hostname":"b479b09165e0","requestId":"ae93c136-a3e8-4db8-90d3-752dc3b6fca8","ms":0,"msg":"route_success"}
{"level":30,"time":1755692117922,"pid":20,"hostname":"b479b09165e0","requestId":"a3bfff61-f31f-4a1d-9cdc-7a117c3ea463","ms":1,"msg":"route_success"}
{"level":30,"time":1755692117922,"pid":20,"hostname":"b479b09165e0","requestId":"4e9208f3-3bbe-4bc6-af80-04b1b0ee9a0d","ms":0,"msg":"route_success"}
{"level":30,"time":1755692117923,"pid":20,"hostname":"b479b09165e0","requestId":"6ecf5a2a-a301-446f-a80f-2c1897450deb","ms":0,"msg":"route_success"}
FAIL tests/unit/middleware.cors.disallowed-origin.spec.ts
  ‚óè middleware CSP connect-src allowlist propagation ‚Ä∫ includes origins from RUNTIME_CORS_ALLOW in CSP via guard path

    expect(received).toMatch(expected)

    Expected pattern: /connect-src [^;]*https:\/\/api\.provider1/
    Received string:  ""

      33 |     const res: any = await (middleware as any)(makeReq('http://localhost/api/health'));
      34 |     const csp = res.headers.get('Content-Security-Policy') || '';
    > 35 |     expect(csp).toMatch(/connect-src [^;]*https:\/\/api\.provider1/);
         |                 ^
      36 |     expect(csp).toMatch(/connect-src [^;]*https:\/\/api\.provider2/);
      37 |   });
      38 | });

      at Object.<anonymous> (unit/middleware.cors.disallowed-origin.spec.ts:35:17)

PASS tests/unit/testStore.edgecases.spec.ts
PASS tests/unit/api.courses.id.spec.ts
{"level":30,"time":1755692118583,"pid":20,"hostname":"b479b09165e0","requestId":"f86b6cbf-d2bf-480c-a40d-7252987db08b","ms":1,"msg":"route_success"}
{"level":30,"time":1755692118583,"pid":20,"hostname":"b479b09165e0","requestId":"10d3c612-e254-4e9b-aa79-c72b581d1939","ms":0,"msg":"route_success"}
{"level":30,"time":1755692118584,"pid":20,"hostname":"b479b09165e0","requestId":"rq-test","ms":1,"msg":"route_success"}
{"level":30,"time":1755692118585,"pid":20,"hostname":"b479b09165e0","requestId":"9cc23225-5216-4b29-bc8b-f4893419bc99","ms":0,"msg":"route_success"}
{"level":30,"time":1755692118585,"pid":20,"hostname":"b479b09165e0","requestId":"213d6f0e-aad7-4c12-845b-b764cbefd281","ms":0,"msg":"route_success"}
PASS tests/unit/services.submissions.queue.spec.ts
PASS tests/unit/ui/GradeRowClient.spec.tsx
PASS tests/unit/api.runtime.asset.sign-url.ratelimit.spec.ts
FAIL tests/unit/api.files.attachments.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.files.attachments.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.files.attachments.spec.ts:3:1)

{"level":30,"time":1755692119733,"pid":20,"hostname":"b479b09165e0","requestId":"fc762640-b9bb-40a0-902d-e2fd12bdd0f3","ms":8,"msg":"route_success"}
{"level":30,"time":1755692119739,"pid":20,"hostname":"b479b09165e0","requestId":"f5e67c11-0a00-4579-a4f5-97beb1329057","ms":6,"msg":"route_success"}
{"level":30,"time":1755692120298,"pid":20,"hostname":"b479b09165e0","requestId":"ea6ff0b1-13f2-412d-b821-af4c00a7a066","ms":6,"msg":"route_success"}
PASS tests/unit/api.runtime.rate-limit.spec.ts
FAIL tests/unit/api.files.finalize.permissions.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.files.finalize.permissions.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.files.finalize.permissions.spec.ts:2:1)

FAIL tests/unit/api.runtime.grade.ratelimit.spec.ts
  ‚óè runtime grade rate-limit headers ‚Ä∫ returns 201 first, then 429 with standard headers

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 201]

      25 |     const h = { authorization: `Bearer ${token}` };
      26 |     let res = await (GradePOST as any)(post({ runtimeAttemptId: 'ra1', score: 1, max: 1, passed: true }, h));
    > 27 |     expect([200,201]).toContain(res.status);
         |                       ^
      28 |     res = await (GradePOST as any)(post({ runtimeAttemptId: 'ra2', score: 1, max: 1, passed: true }, h));
      29 |     expect(res.status).toBe(429);
      30 |     expect(res.headers.get('retry-after')).toBeTruthy();

      at Object.<anonymous> (unit/api.runtime.grade.ratelimit.spec.ts:27:23)

{"level":30,"time":1755692120861,"pid":20,"hostname":"b479b09165e0","requestId":"7368f2fa-525b-49e3-b10a-41ace9d8e9b3","ms":6,"msg":"route_success"}
{"level":30,"time":1755692121123,"pid":20,"hostname":"b479b09165e0","requestId":"e950e342-a7a4-4b4a-9758-60d805480b85","ms":9,"msg":"route_success"}
FAIL tests/unit/api.runtime.grade.idempotency.spec.ts
  ‚óè runtime grade idempotency ‚Ä∫ duplicate grade request with same Idempotency-Key returns replayed 200

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 201, 204]

      27 |     const h = { authorization: `Bearer ${token}`, 'Idempotency-Key': 'grade-dup-1' } as Record<string,string>;
      28 |     let res = await (GradePOST as any)(post('http://localhost/api/runtime/grade', { score: 1, max: 1, passed: true }, h));
    > 29 |     expect([200,201,204]).toContain(res.status);
         |                           ^
      30 |     res = await (GradePOST as any)(post('http://localhost/api/runtime/grade', { score: 1, max: 1, passed: true }, h));
      31 |     expect([200]).toContain(res.status);
      32 |     expect(res.headers.get('idempotency-replayed')).toBe('1');

      at Object.<anonymous> (unit/api.runtime.grade.idempotency.spec.ts:29:27)

FAIL tests/unit/api.admin.audit-logs.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.admin.audit-logs.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.admin.audit-logs.spec.ts:3:1)

FAIL tests/unit/api.providers.dto-and-ratelimit.spec.ts
  ‚óè providers endpoints DTO + ratelimit headers ‚Ä∫ rate limit headers present when throttled on provider PATCH

    TypeError: supabase.from(...).update is not a function

      138 |   if (Object.keys(patch).length === 0) return NextResponse.json({ error: { code: 'BAD_REQUEST', message: 'no fields to update' }, requestId }, { status: 400, headers: { 'x-request-id': requestId } });
      139 |   const supabase = getRouteHandlerSupabase();
    > 140 |   const { data, error } = await supabase.from('course_providers').update(patch).eq('id', q.id).select().single();
          |                                                                   ^
      141 |   if (error) return NextResponse.json({ error: { code: 'DB_ERROR', message: error.message }, requestId }, { status: 500, headers: { 'x-request-id': requestId } });
      142 |   try {
      143 |     await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'provider.update', entity_type: 'provider', entity_id: q.id, details: patch });

      at PATCH (../apps/web/src/app/api/providers/route.ts:140:67)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.providers.dto-and-ratelimit.spec.ts:23:16)

{"level":30,"time":1755692121665,"pid":20,"hostname":"b479b09165e0","requestId":"ccafdf66-8923-4a34-9f02-54fe2dbfad58","ms":0,"msg":"route_success"}
{"level":50,"time":1755692121667,"pid":20,"hostname":"b479b09165e0","requestId":"4bc3b8f3-2964-4bab-8ed2-5ffc4d416512","ms":1,"err":"supabase.from(...).update is not a function","msg":"route_error"}
{"level":30,"time":1755692121927,"pid":20,"hostname":"b479b09165e0","requestId":"a34f688b-fee3-4a6a-998a-0882423516b8","ms":7,"msg":"route_success"}
FAIL tests/unit/api.runtime.events.ratelimit.spec.ts
  ‚óè runtime events rate-limit headers ‚Ä∫ returns 429 with standard headers on rate limit

    expect(received).toBe(expected) // Object.is equality

    Expected: 429
    Received: 403

      30 |     const token = makeJwt(['progress.write']);
      31 |     const res = await (EventsPOST as any)(post({ type: 'course.progress', pct: 10 }, { authorization: `Bearer ${token}` }));
    > 32 |     expect(res.status).toBe(429);
         |                        ^
      33 |     expect(res.headers.get('retry-after')).toBeTruthy();
      34 |     expect(res.headers.get('x-rate-limit-reset')).toBeTruthy();
      35 |     expect(res.headers.get('x-rate-limit-remaining')).toBe('0');

      at Object.<anonymous> (unit/api.runtime.events.ratelimit.spec.ts:32:24)

PASS tests/unit/api.quiz-questions.spec.ts
{"level":30,"time":1755692122194,"pid":20,"hostname":"b479b09165e0","requestId":"119ccdbf-bcda-4607-b8e8-ee0cae88841c","ms":0,"msg":"route_success"}
{"level":30,"time":1755692122195,"pid":20,"hostname":"b479b09165e0","requestId":"07fd46f0-54b6-40d1-8768-bd5d268e6a9d","ms":0,"msg":"route_success"}
{"level":30,"time":1755692122195,"pid":20,"hostname":"b479b09165e0","requestId":"2de488f2-5aef-4e21-a0a1-75e8b291e806","ms":0,"msg":"route_success"}
{"level":30,"time":1755692122196,"pid":20,"hostname":"b479b09165e0","requestId":"63ce2106-d04d-4063-bc86-4c9ee1a7685d","ms":0,"msg":"route_success"}
{"level":30,"time":1755692122202,"pid":20,"hostname":"b479b09165e0","requestId":"a2cf468d-10ae-4a3c-b05b-02471ba23f12","ms":1,"msg":"route_success"}
{"level":30,"time":1755692122202,"pid":20,"hostname":"b479b09165e0","requestId":"0d79418e-854c-4a41-906f-e1edd2ecdb47","ms":0,"msg":"route_success"}
{"level":30,"time":1755692122505,"pid":20,"hostname":"b479b09165e0","requestId":"9a6f28dc-b2e4-4664-b80c-31f9c56f3ff6","ms":1,"msg":"route_success"}
{"level":30,"time":1755692122505,"pid":20,"hostname":"b479b09165e0","requestId":"539394c4-7c71-42d5-86bc-c12a4132af80","ms":0,"msg":"route_success"}
{"level":30,"time":1755692122506,"pid":20,"hostname":"b479b09165e0","requestId":"ca790ea1-5d3b-46b1-aa4c-8ae12702dd6a","ms":0,"msg":"route_success"}
PASS tests/unit/api.runtime.v2.security.spec.ts
PASS tests/unit/lib.serverFetch.headers.spec.ts
  ‚óè Console

    console.debug
      [serverFetch] 200 http://localhost:3030/api/health 0ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:78:13)

    console.debug
      [serverFetch] 200 http://localhost:3030/api/health 0ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:78:13)

    console.debug
      [serverFetch] 400 http://localhost:3030/api/x 0ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:78:13)

PASS tests/unit/api.messages.csrf-double-submit.spec.ts
{"level":30,"time":1755692122823,"pid":20,"hostname":"b479b09165e0","requestId":"1335de69-173e-451a-8d96-b871ee349e81","ms":1,"msg":"route_success"}
{"level":30,"time":1755692123082,"pid":20,"hostname":"b479b09165e0","requestId":"6ff2c229-6a6c-4df1-9322-da6dd3063ec8","ms":6,"msg":"route_success"}
{"level":30,"time":1755692123083,"pid":20,"hostname":"b479b09165e0","requestId":"9fa4b464-914e-4d1c-a3ea-963ceaf36a5c","ms":0,"msg":"route_success"}
PASS tests/unit/api.submissions.rate-limit.spec.ts
FAIL tests/unit/api.files.roundtrip.spec.ts
  ‚óè files round-trip ‚Ä∫ upload-url ‚Üí PUT bytes ‚Üí download-url

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 400

      24 |     const blob = new Blob([new TextEncoder().encode('hello')], { type: 'text/plain' });
      25 |     const put = await (UploadPUT as any)(makePut(`http://localhost${url}`, blob, { 'x-test-auth': 'student' }));
    > 26 |     expect(put.status).toBe(200);
         |                        ^
      27 |     const { id, url: publicUrl } = await put.json();
      28 |     expect(id).toBeTruthy();
      29 |     const dl = await (DownloadGET as any)(makeGet(`http://localhost/api/files/download-url?id=${encodeURIComponent(id)}`, { 'x-test-auth': 'student' }));

      at Object.<anonymous> (unit/api.files.roundtrip.spec.ts:26:24)

{"level":30,"time":1755692123416,"pid":20,"hostname":"b479b09165e0","requestId":"rid-rt","ms":1,"msg":"route_success"}
{"level":30,"time":1755692123419,"pid":20,"hostname":"b479b09165e0","requestId":"17d90a9d-d4ef-41dd-b66d-bcda19737cc9","ms":1,"msg":"route_success"}
{"level":30,"time":1755692123712,"pid":20,"hostname":"b479b09165e0","requestId":"a99d6dc8-c0e7-47a5-baa1-399db79d2ef4","ms":0,"msg":"route_success"}
{"level":30,"time":1755692123717,"pid":20,"hostname":"b479b09165e0","requestId":"aae3cdaa-4253-4322-b877-f8994ae2475a","ms":1,"msg":"route_success"}
{"level":30,"time":1755692123718,"pid":20,"hostname":"b479b09165e0","requestId":"69f8263a-5255-4467-89a3-7fa5fc73528b","ms":1,"msg":"route_success"}
{"level":30,"time":1755692123719,"pid":20,"hostname":"b479b09165e0","requestId":"f9766f63-4fd8-4b08-a51d-6d99ffdeeb0b","ms":1,"msg":"route_success"}
{"level":30,"time":1755692123719,"pid":20,"hostname":"b479b09165e0","requestId":"fde91e0d-c7cb-49bc-ab87-61a4a51d97b7","ms":0,"msg":"route_success"}
{"level":30,"time":1755692123719,"pid":20,"hostname":"b479b09165e0","requestId":"77ed777c-599d-4a0b-9867-03b23ec58d9d","ms":0,"msg":"route_success"}
PASS tests/unit/api.quiz-choices.spec.ts
FAIL tests/unit/api.runtime.idempotency.spec.ts
  ‚óè runtime progress idempotency ‚Ä∫ duplicate request with same Idempotency-Key is replayed 200 with header

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 201, 204]

      25 |     const h = { authorization: `Bearer ${token}`, 'Idempotency-Key': 'dup-1' } as Record<string,string>;
      26 |     let res = await (ProgressPOST as any)(post('http://localhost/api/runtime/progress', h));
    > 27 |     expect([200,201,204]).toContain(res.status);
         |                           ^
      28 |     res = await (ProgressPOST as any)(post('http://localhost/api/runtime/progress', h));
      29 |     expect([200]).toContain(res.status);
      30 |     expect(res.headers.get('idempotency-replayed')).toBe('1');

      at Object.<anonymous> (unit/api.runtime.idempotency.spec.ts:27:27)

{"level":30,"time":1755692123963,"pid":20,"hostname":"b479b09165e0","requestId":"98b6ae7f-35d9-4a4d-838f-2cc041365574","ms":8,"msg":"route_success"}
{"level":30,"time":1755692124205,"pid":20,"hostname":"b479b09165e0","requestId":"faa3311a-cfed-40c3-a979-b34b29d65596","ms":1,"msg":"route_success"}
{"level":30,"time":1755692124206,"pid":20,"hostname":"b479b09165e0","requestId":"f1d860e2-de2a-4ab0-a8b0-50b14f2bf7d8","ms":0,"msg":"route_success"}
{"level":30,"time":1755692124206,"pid":20,"hostname":"b479b09165e0","requestId":"dfc56bdc-6315-4ebf-8bd9-3122af4ab548","ms":1,"msg":"route_success"}
PASS tests/unit/api.notifications.read-all.csrf.spec.ts
PASS tests/unit/api.files.negatives.spec.ts
{"level":30,"time":1755692124468,"pid":20,"hostname":"b479b09165e0","requestId":"322b39ec-f724-45ab-b10b-98b3d0334982","ms":1,"msg":"route_success"}
{"level":30,"time":1755692124468,"pid":20,"hostname":"b479b09165e0","requestId":"1763c07b-4311-484f-ac11-53bddf19f12c","ms":0,"msg":"route_success"}
{"level":30,"time":1755692124469,"pid":20,"hostname":"b479b09165e0","requestId":"xx","ms":0,"msg":"route_success"}
{"level":30,"time":1755692124469,"pid":20,"hostname":"b479b09165e0","requestId":"yy","ms":0,"msg":"route_success"}
{"level":30,"time":1755692124717,"pid":20,"hostname":"b479b09165e0","requestId":"10440e34-b63c-464c-88c5-b2d5e081c842","ms":6,"msg":"route_success"}
FAIL tests/unit/api.runtime.cors.headers.spec.ts
  ‚óè runtime CORS headers for allowed origin ‚Ä∫ includes access-control-allow-origin when origin is allowed

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 201, 204, 400]

      25 |     const res = await (ProgressPOST as any)(post({ authorization: `Bearer ${token}` }));
      26 |     // success or preflight OK
    > 27 |     expect([200,201,204,400]).toContain(res.status);
         |                               ^
      28 |     // @ts-ignore NextResponse-like headers
      29 |     const h = res.headers as Headers;
      30 |     expect(h.get('access-control-allow-origin')).toBe('https://provider.example');

      at Object.<anonymous> (unit/api.runtime.cors.headers.spec.ts:27:31)

PASS tests/unit/api.lessons.reorder.spec.ts
{"level":30,"time":1755692125018,"pid":20,"hostname":"b479b09165e0","requestId":"578e3ab1-135a-4f4c-b0ef-21fd61f74585","ms":0,"msg":"route_success"}
{"level":30,"time":1755692125019,"pid":20,"hostname":"b479b09165e0","requestId":"bd7f95af-3dac-44b4-b763-b1c4614efd5d","ms":1,"msg":"route_success"}
{"level":30,"time":1755692125019,"pid":20,"hostname":"b479b09165e0","requestId":"8cabf3b3-f959-4b55-8695-3d8cce32550b","ms":0,"msg":"route_success"}
{"level":30,"time":1755692125020,"pid":20,"hostname":"b479b09165e0","requestId":"5b933446-9402-4447-b2ac-b34a9446a2ca","ms":0,"msg":"route_success"}
{"level":30,"time":1755692125342,"pid":20,"hostname":"b479b09165e0","requestId":"184663a8-6cbb-4671-8125-5280ca50f885","ms":0,"msg":"route_success"}
{"level":30,"time":1755692125343,"pid":20,"hostname":"b479b09165e0","requestId":"6c44aeb2-2fb0-4812-84a1-7f8b8afe13fb","ms":0,"msg":"route_success"}
{"level":30,"time":1755692125344,"pid":20,"hostname":"b479b09165e0","requestId":"986c32b3-f0fb-47ae-98f4-acaeebc7a255","ms":0,"msg":"route_success"}
{"level":30,"time":1755692125346,"pid":20,"hostname":"b479b09165e0","requestId":"372ee270-9b67-4c49-a22f-1d719ba1f18f","ms":1,"msg":"route_success"}
PASS tests/unit/api.notifications-preferences.spec.ts
PASS tests/unit/api.runtime.checkpoint.size-limit.spec.ts
{"level":30,"time":1755692125575,"pid":20,"hostname":"b479b09165e0","requestId":"db0b2863-aeda-44bd-9b1f-a4ec02ec99e6","ms":6,"msg":"route_success"}
{"level":50,"time":1755692125817,"pid":20,"hostname":"b479b09165e0","requestId":"c5a171b7-b021-4227-a9a4-f843890c403a","ms":1,"err":"supabase.from(...).select(...).eq is not a function","msg":"route_error"}
{"level":30,"time":1755692125854,"pid":20,"hostname":"b479b09165e0","requestId":"b0148904-398d-445d-b452-cbaf510b0f20","ms":0,"msg":"route_success"}
FAIL tests/unit/db.rls.negative.spec.ts
  ‚óè DB RLS negative cases (policy guards) ‚Ä∫ student cannot read other students notifications

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/db.rls.negative.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/db.rls.negative.spec.ts:5:18
      at Object.<anonymous> (unit/db.rls.negative.spec.ts:5:18)

  ‚óè DB RLS negative cases (policy guards) ‚Ä∫ non-owner cannot finalize someone else file (RLS and route guard)

    TypeError: supabase.from(...).select(...).eq is not a function

      14 |   try { body = finalizeSchema.parse(await req.json()); } catch (e: any) { return NextResponse.json({ error: { code: 'BAD_REQUEST', message: String(e?.message || e) }, requestId }, { status: 400, headers: { 'x-request-id': requestId } }); }
      15 |   const supabase = getRouteHandlerSupabase();
    > 16 |   const { data: att } = await supabase.from('attachments').select('id,owner_type,owner_id,size_bytes').eq('object_key', body.key).single();
         |                                                                                                        ^
      17 |   if (!att) return NextResponse.json({ error: { code: 'NOT_FOUND', message: 'not found' }, requestId }, { status: 404, headers: { 'x-request-id': requestId } });
      18 |   // Permission: owner or teacher/admin for domain types (reuse delete semantics where possible)
      19 |   const ownerType = (att as any).owner_type as string;

      at POST (../apps/web/src/app/api/files/finalize/route.ts:16:104)
      at Object.POST (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/db.rls.negative.spec.ts:24:17)

  ‚óè DB RLS negative cases (policy guards) ‚Ä∫ student cannot list submissions for other assignment without auth as teacher

    expect(received).toContain(expected) // indexOf

    Expected value: 200
    Received array: [401, 403]

      29 |     const route = await import('../../apps/web/src/app/api/submissions/route');
      30 |     const res = await route.GET(new Request('http://localhost/api/submissions?assignment_id=00000000-0000-0000-0000-000000000999', { headers: { 'x-test-auth': 'student' } } as any) as any);
    > 31 |     expect([401,403]).toContain(res.status);
         |                       ^
      32 |   });
      33 | });
      34 |

      at Object.<anonymous> (unit/db.rls.negative.spec.ts:31:23)

PASS tests/unit/api.modes.prod-guards.spec.ts
PASS tests/unit/api.notifications.spec.ts
{"level":30,"time":1755692126139,"pid":20,"hostname":"b479b09165e0","requestId":"f9b94c6d-9c3c-4161-9d19-9316a916a967","ms":0,"msg":"route_success"}
{"level":30,"time":1755692126140,"pid":20,"hostname":"b479b09165e0","requestId":"dcb7b12f-c374-48d8-9e36-73000f6ab305","ms":0,"msg":"route_success"}
{"level":30,"time":1755692126428,"pid":20,"hostname":"b479b09165e0","requestId":"b2682313-623e-47e0-a447-4f3890806d17","ms":0,"msg":"route_success"}
{"level":30,"time":1755692126429,"pid":20,"hostname":"b479b09165e0","requestId":"0cbdde0a-2960-497f-9fed-f90d73689936","ms":0,"msg":"route_success"}
{"level":30,"time":1755692126429,"pid":20,"hostname":"b479b09165e0","requestId":"85e837d6-ac2f-40da-bf0e-a5daa29f7e00","ms":0,"msg":"route_success"}
{"level":30,"time":1755692126430,"pid":20,"hostname":"b479b09165e0","requestId":"bc35367c-a3c0-4de4-9869-23f686aa072d","ms":1,"msg":"route_success"}
{"level":30,"time":1755692126430,"pid":20,"hostname":"b479b09165e0","requestId":"01ad12a2-054b-4b61-b254-a817da5a9207","ms":0,"msg":"route_success"}
PASS tests/unit/api.modules.spec.ts
PASS tests/unit/api.csrf.double-submit.spec.ts
PASS tests/unit/api.messages.threads.ratelimit.headers.spec.ts
FAIL tests/unit/middleware.security-headers.more.spec.ts
  ‚óè middleware additional security headers ‚Ä∫ sets Referrer-Policy, X-Content-Type-Options, COOP, CORP, Permissions-Policy

    TypeError: server_1.NextResponse.next is not a function

      84 |     }
      85 |   } catch {}
    > 86 |   const res = NextResponse.next({ request: { headers } });
         |                            ^
      87 |   res.headers.set("x-request-id", requestId);
      88 |   res.headers.set("Content-Security-Policy", csp);
      89 |   if (process.env.NODE_ENV === 'production') {

      at Object.middleware (../apps/web/middleware.ts:86:28)
      at Object.<anonymous> (unit/middleware.security-headers.more.spec.ts:25:29)

  ‚óè middleware additional security headers ‚Ä∫ sets HSTS only in production

    TypeError: server_1.NextResponse.next is not a function

      84 |     }
      85 |   } catch {}
    > 86 |   const res = NextResponse.next({ request: { headers } });
         |                            ^
      87 |   res.headers.set("x-request-id", requestId);
      88 |   res.headers.set("Content-Security-Policy", csp);
      89 |   if (process.env.NODE_ENV === 'production') {

      at Object.middleware (../apps/web/middleware.ts:86:28)
      at Object.<anonymous> (unit/middleware.security-headers.more.spec.ts:36:32)

FAIL tests/unit/api.runtime.outcomes.rate-limit.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.runtime.outcomes.rate-limit.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.runtime.outcomes.rate-limit.spec.ts:2:1)

{"level":30,"time":1755692126914,"pid":20,"hostname":"b479b09165e0","requestId":"742c995a-1fd1-4628-bb44-0a448fa12b05","ms":1,"msg":"route_success"}
{"level":30,"time":1755692126915,"pid":20,"hostname":"b479b09165e0","requestId":"81162e70-51bc-4ff7-b307-ed08a38d226e","ms":1,"msg":"route_success"}
{"level":30,"time":1755692126916,"pid":20,"hostname":"b479b09165e0","requestId":"7b773337-ba89-4b41-be64-8af33ee0938d","ms":0,"msg":"route_success"}
{"level":30,"time":1755692126916,"pid":20,"hostname":"b479b09165e0","requestId":"61463d33-81ba-406d-80e8-ec52b46ebaff","ms":0,"msg":"route_success"}
{"level":30,"time":1755692127610,"pid":20,"hostname":"b479b09165e0","requestId":"042bce09-962f-4702-930e-d71bcd997613","ms":1,"msg":"route_success"}
{"level":30,"time":1755692127610,"pid":20,"hostname":"b479b09165e0","requestId":"01516e0d-dd4a-45b1-8829-062c3da0406d","ms":0,"msg":"route_success"}
{"level":30,"time":1755692127611,"pid":20,"hostname":"b479b09165e0","requestId":"fde6822b-ebec-4185-976d-007b01c94893","ms":1,"msg":"route_success"}
{"level":30,"time":1755692127614,"pid":20,"hostname":"b479b09165e0","requestId":"rq-enr","ms":0,"msg":"route_success"}
FAIL tests/unit/api.enrollments.spec.ts
  ‚óè API /api/enrollments ‚Ä∫ POST unauth ‚Üí 401; non-student ‚Üí 403; student ‚Üí 201 with own student_id

    expect(received).toBe(expected) // Object.is equality

    Expected: "test-student-id"
    Received: "22222222-2222-2222-2222-222222222222"

      28 | 		expect(res.status).toBe(201);
      29 | 		const json = await res.json();
    > 30 | 		expect(json.student_id).toBe('test-student-id');
         | 		                        ^
      31 | 	});
      32 |
      33 | 	test('GET unauth ‚Üí 401; echoes x-request-id', async () => {

      at Object.<anonymous> (unit/api.enrollments.spec.ts:30:27)

PASS tests/unit/testStore.spec.ts
PASS tests/unit/server.withRouteTiming.csrf.spec.ts
FAIL tests/unit/api.providers.health.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.providers.health.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.providers.health.spec.ts:2:1)

{"level":30,"time":1755692127955,"pid":20,"hostname":"b479b09165e0","requestId":"e67aa2dd-4537-4424-ae14-6e5be9b70f21","ms":0,"msg":"route_success"}
PASS tests/unit/services.quizzes.spec.ts
FAIL tests/unit/api.notifications.rate-limit.spec.ts
  ‚óè notifications rate-limit headers ‚Ä∫ GET list returns 429 with standard headers when limited

    expect(received).toBe(expected) // Object.is equality

    Expected: 429
    Received: 200

      18 |   test('GET list returns 429 with standard headers when limited', async () => {
      19 |     const res = await (NotifGET as any)(get('http://localhost/api/notifications'));
    > 20 |     expect(res.status).toBe(429);
         |                        ^
      21 |     expect(res.headers.get('retry-after')).toBeTruthy();
      22 |     expect(res.headers.get('x-rate-limit-remaining')).toBe('0');
      23 |     expect(res.headers.get('x-rate-limit-reset')).toBeTruthy();

      at Object.<anonymous> (unit/api.notifications.rate-limit.spec.ts:20:24)

{"level":30,"time":1755692128881,"pid":20,"hostname":"b479b09165e0","requestId":"060efb30-d46a-4950-b3ec-0bdf5cc64260","ms":0,"msg":"route_success"}
{"level":30,"time":1755692128884,"pid":20,"hostname":"b479b09165e0","requestId":"3d2f62b0-8459-439c-b320-5c679c7ba83d","ms":1,"msg":"route_success"}
{"level":30,"time":1755692129180,"pid":20,"hostname":"b479b09165e0","requestId":"d62eb768-97e5-44b5-931c-e308b1011555","ms":0,"msg":"route_success"}
FAIL tests/unit/api.assignments.post.csrf.spec.ts
  ‚óè assignments POST CSRF double-submit ‚Ä∫ 403 missing/mismatched tokens; 201 when matched

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [200, 201]

      26 |     // Match
      27 |     res = await (AssignmentsPOST as any)(post(payload, { origin: 'http://localhost', referer: 'http://localhost/x', cookie: 'csrf_token=t', 'x-csrf-token': 't' }));
    > 28 |     expect([200,201]).toContain(res.status);
         |                       ^
      29 |   });
      30 | });
      31 |

      at Object.<anonymous> (unit/api.assignments.post.csrf.spec.ts:28:23)

PASS tests/unit/services.dashboard.spec.ts
{"level":20,"time":1755692129413,"pid":20,"hostname":"b479b09165e0","ms":0,"msg":"dash_teacher_widgets"}
{"level":20,"time":1755692129415,"pid":20,"hostname":"b479b09165e0","ms":1,"msg":"dash_student_widgets"}
{"level":50,"time":1755692129672,"pid":20,"hostname":"b479b09165e0","requestId":"db3d8bf2-2435-47d4-a598-fb1c2351f725","ms":1,"err":"[\n  {\n    \"code\": \"too_small\",\n    \"minimum\": 3,\n    \"type\": \"string\",\n    \"inclusive\": true,\n    \"exact\": false,\n    \"message\": \"String must contain at least 3 character(s)\",\n    \"path\": [\n      \"title\"\n    ]\n  }\n]","msg":"route_error"}
{"level":30,"time":1755692129685,"pid":20,"hostname":"b479b09165e0","requestId":"a8570b64-937f-47fd-be38-0f1b7d6a9ccf","ms":2,"msg":"route_success"}
FAIL tests/unit/api.quizzes.ratelimit.spec.ts
  ‚óè quizzes rate-limit headers on PATCH/DELETE ‚Ä∫ PATCH returns 429 with standard headers when limited

    ZodError: [
      {
        "code": "too_small",
        "minimum": 3,
        "type": "string",
        "inclusive": true,
        "exact": false,
        "message": "String must contain at least 3 character(s)",
        "path": [
          "title"
        ]
      }
    ]

      93 |   } catch {}
      94 |   const body = await req.json();
    > 95 |   const parsed = quizUpdateRequest.parse(body);
         |                                    ^
      96 |   const out = await updateQuizApi(q.id, parsed);
      97 |   try {
      98 |     const dto = quizDto.parse(out);

      at Object.get error [as error] (../node_modules/zod/v3/types.cjs:45:31)
      at ZodEffects.parse (../node_modules/zod/v3/types.cjs:120:22)
      at PATCH (../apps/web/src/app/api/quizzes/route.ts:95:36)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.quizzes.ratelimit.spec.ts:15:17)

FAIL tests/unit/future.observability.logs.spec.ts
  ‚óè observability logs (services) ‚Ä∫ dash_teacher_widgets and dash_student_widgets include ms

    TypeError: Cannot set properties of undefined (setting 'length')

      23 |   test('dash_teacher_widgets and dash_student_widgets include ms', async () => {
      24 |     const logs: any[] = (loggerMod as any).__TEST_LOGS__;
    > 25 |     logs.length = 0;
         |                ^
      26 |     await dashboardSvc.getDashboardForUser('test-teacher-id', 'teacher');
      27 |     await dashboardSvc.getDashboardForUser('test-student-id', 'student');
      28 |     expect(logs.some(l => l.msg === 'dash_teacher_widgets' && typeof l.obj?.ms === 'number')).toBe(true);

      at Object.<anonymous> (unit/future.observability.logs.spec.ts:25:16)

  ‚óè observability logs (services) ‚Ä∫ progress_marked counter emitted on completion

    TypeError: Cannot set properties of undefined (setting 'length')

      32 |   test('progress_marked counter emitted on completion', async () => {
      33 |     const logs: any[] = (loggerMod as any).__TEST_LOGS__;
    > 34 |     logs.length = 0;
         |                ^
      35 |     const out = await progressSvc.markLessonComplete('u1', '00000000-0000-0000-0000-000000000001');
      36 |     expect(out.lessonId).toBeTruthy();
      37 |     expect(logs.some(l => l.msg === 'progress_marked' && typeof l.obj?.ms === 'number')).toBe(true);

      at Object.<anonymous> (unit/future.observability.logs.spec.ts:34:16)

PASS tests/unit/api.messages.threads.ratelimit.spec.ts
FAIL tests/unit/api.progress.errors.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.progress.errors.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.progress.errors.spec.ts:3:1)

{"level":30,"time":1755692130323,"pid":20,"hostname":"b479b09165e0","requestId":"6d3ddb54-afd1-4b7e-8a65-05cf78dd7b04","ms":1,"msg":"route_success"}
{"level":30,"time":1755692130336,"pid":20,"hostname":"b479b09165e0","requestId":"b6bbde70-6e17-41e9-9905-c6e83b301d48","ms":1,"msg":"route_success"}
{"level":30,"time":1755692130336,"pid":20,"hostname":"b479b09165e0","requestId":"99b46f3b-df5a-4a76-bef4-e03df82f9d2e","ms":0,"msg":"route_success"}
{"level":20,"time":1755692130962,"pid":20,"hostname":"b479b09165e0","ms":0,"msg":"dash_teacher_widgets"}
{"level":20,"time":1755692130963,"pid":20,"hostname":"b479b09165e0","ms":0,"msg":"dash_teacher_widgets"}
PASS tests/unit/services.dashboard.needsGrading.spec.ts
PASS tests/unit/schemas.env.runtime-keys.required.spec.ts
PASS tests/unit/services.lessons.spec.ts
{"level":30,"time":1755692131513,"pid":20,"hostname":"b479b09165e0","requestId":"384a4c62-15e9-485c-bff8-ce4f4a848ec6","ms":1,"msg":"route_success"}
PASS tests/unit/services.submissions.queue.pagination.spec.ts
FAIL tests/unit/api.events.behavior.spec.ts
  ‚óè Events API behavior ‚Ä∫ test-mode: POST 201 and GET lists event; 401 unauth

    expect(received).toContain(expected) // indexOf

    Expected value: 500
    Received array: [201, 204]

      22 |     jest.spyOn(supa, 'getCurrentUserInRoute').mockResolvedValue({ id: 'u', user_metadata: { role: 'teacher' } } as any);
      23 |     res = await (EventsPOST as any)(post('http://localhost/api/events', { event_type: 'x', entity_type: 'y', entity_id: 'e1', meta: {} }));
    > 24 |     expect([201,204]).toContain(res.status); // test-mode -> 201
         |                       ^
      25 |     const list = await (EventsGET as any)(get('http://localhost/api/events'));
      26 |     expect(list.status).toBe(200);
      27 |   });

      at Object.<anonymous> (unit/api.events.behavior.spec.ts:24:23)

{"level":30,"time":1755692132114,"pid":20,"hostname":"b479b09165e0","requestId":"6e7ace2a-e77d-4a27-b163-f1b77f4e0384","ms":1,"msg":"route_success"}
{"level":30,"time":1755692132115,"pid":20,"hostname":"b479b09165e0","requestId":"3e7d9790-5dc5-40ef-b03a-9a41b9900262","ms":0,"msg":"route_success"}
{"level":30,"time":1755692132116,"pid":20,"hostname":"b479b09165e0","requestId":"46c12b6e-8632-478d-accb-347891cce7f0","ms":0,"msg":"route_success"}
{"level":30,"time":1755692132386,"pid":20,"hostname":"b479b09165e0","requestId":"66710963-4a23-40a6-991a-da35a691a64e","ms":0,"msg":"route_success"}
{"level":30,"time":1755692132387,"pid":20,"hostname":"b479b09165e0","requestId":"73edfac0-d9f6-47cf-aec4-fc8563646ac0","ms":0,"msg":"route_success"}
{"level":30,"time":1755692132395,"pid":20,"hostname":"b479b09165e0","requestId":"rq-test","ms":0,"msg":"route_success"}
PASS tests/unit/api.courses.spec.ts
FAIL tests/unit/api.teacher.grading-queue.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.teacher.grading-queue.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.teacher.grading-queue.spec.ts:3:19
      at Object.<anonymous> (../apps/web/src/app/api/teacher/grading-queue/route.ts:4:1)
      at Object.<anonymous> (unit/api.teacher.grading-queue.spec.ts:8:1)

PASS tests/unit/future.observability.spec.ts
  ‚óè Console

    console.debug
      [serverFetch] 200 http://web:3022/api/demo 0ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:78:13)

{"level":30,"time":1755692132885,"pid":20,"hostname":"b479b09165e0","requestId":"up-123","ms":0,"msg":"route_success"}
{"level":50,"time":1755692132886,"pid":20,"hostname":"b479b09165e0","requestId":"eba06480-4154-4fbf-bf24-2ec8e5893c40","ms":0,"err":"boom","msg":"route_error"}
{"level":30,"time":1755692133135,"pid":20,"hostname":"b479b09165e0","requestId":"ed693316-2905-4abe-824a-989c6aba53e9","ms":1,"msg":"route_success"}
{"level":30,"time":1755692133136,"pid":20,"hostname":"b479b09165e0","requestId":"be64bc9d-4d45-4e00-9b06-012642c6a31e","ms":1,"msg":"route_success"}
PASS tests/unit/api.announcements.ratelimit.spec.ts
PASS tests/unit/api.requestId.headers.matrix.spec.ts
{"level":30,"time":1755692133457,"pid":20,"hostname":"b479b09165e0","requestId":"ded2b075-4d70-4caa-abc4-92a4dd41516b","ms":0,"msg":"route_success"}
{"level":30,"time":1755692133458,"pid":20,"hostname":"b479b09165e0","requestId":"39a65564-eddf-476b-a28c-1bc8b74ca9a4","ms":1,"msg":"route_success"}
{"level":30,"time":1755692133689,"pid":20,"hostname":"b479b09165e0","requestId":"7e411150-e2cb-452d-9c79-75a847dbff7c","ms":0,"msg":"route_success"}
{"level":30,"time":1755692133696,"pid":20,"hostname":"b479b09165e0","requestId":"22df5691-15cd-487c-bb4f-5b1c768aa698","ms":6,"msg":"route_success"}
PASS tests/unit/api.parent-links.headers.spec.ts
PASS tests/unit/gateways/health.gateway.spec.ts
  ‚óè Console

    console.debug
      [serverFetch] 200 http://web:3022/api/health 1ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:78:13)

PASS tests/unit/apiHandler.spec.ts
FAIL tests/unit/server.withRouteTiming.runtime-csrf-skip.spec.ts
  ‚óè withRouteTiming skips CSRF on /api/runtime/* ‚Ä∫ cross-origin POST to runtime path passes without same-origin or double-submit

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 403

      23 |     const handler = withRouteTiming(async () => new Response(JSON.stringify({ ok: true }), { status: 200 }));
      24 |     const res = await (handler as any)(mkReq('http://localhost/api/runtime/progress', 'POST', { origin: 'http://evil.example', referer: 'http://evil.example/p' }) as any);
    > 25 |     expect(res.status).toBe(200);
         |                        ^
      26 |     expect(res.headers.get('x-request-id')).toBeTruthy();
      27 |   });
      28 | });

      at Object.<anonymous> (unit/server.withRouteTiming.runtime-csrf-skip.spec.ts:25:24)

{"level":30,"time":1755692133997,"pid":20,"hostname":"b479b09165e0","requestId":"4a9e3747-b446-41c6-9058-559dd2a6a74a","ms":0,"msg":"route_success"}
PASS tests/unit/services.announcements.spec.ts
PASS tests/unit/ui/SystemThroughputProfiler.spec.tsx
FAIL tests/unit/middleware.csrf-cookie.spec.ts
  ‚óè middleware CSRF cookie issuance ‚Ä∫ sets csrf_token cookie when missing

    TypeError: server_1.NextResponse.next is not a function

      84 |     }
      85 |   } catch {}
    > 86 |   const res = NextResponse.next({ request: { headers } });
         |                            ^
      87 |   res.headers.set("x-request-id", requestId);
      88 |   res.headers.set("Content-Security-Policy", csp);
      89 |   if (process.env.NODE_ENV === 'production') {

      at Object.middleware (../apps/web/middleware.ts:86:28)
      at Object.<anonymous> (unit/middleware.csrf-cookie.spec.ts:38:29)

FAIL tests/unit/api.files.content-type-default.spec.ts
  ‚óè files default content_type ‚Ä∫ defaults to application/octet-stream when omitted

    expect(received).toBe(expected) // Object.is equality

    Expected: "application/octet-stream"
    Received: "application/json"

      22 |     const { id } = await put.json();
      23 |     const dl = await (DownloadGET as any)(getUrl(`http://localhost/api/files/download-url?id=${id}`, { 'x-test-auth': 'student' }));
    > 24 |     expect(dl.headers.get('content-type')).toBe('application/octet-stream');
         |                                            ^
      25 |   });
      26 | });
      27 |

      at Object.<anonymous> (unit/api.files.content-type-default.spec.ts:24:44)

{"level":30,"time":1755692135140,"pid":20,"hostname":"b479b09165e0","requestId":"7144bec0-b47c-44b7-9a1a-1933d40a35c2","ms":0,"msg":"route_success"}
{"level":30,"time":1755692135141,"pid":20,"hostname":"b479b09165e0","requestId":"e01292b5-c38f-47ec-a56e-4eba26a66e9e","ms":0,"msg":"route_success"}
{"level":30,"time":1755692135141,"pid":20,"hostname":"b479b09165e0","requestId":"63b0715d-b408-4df7-b324-53e005d9f5d6","ms":0,"msg":"route_success"}
{"level":20,"time":1755692135393,"pid":20,"hostname":"b479b09165e0","ms":0,"msg":"dash_student_widgets"}
{"level":30,"time":1755692135393,"pid":20,"hostname":"b479b09165e0","requestId":"7acd1e18-1279-429c-a6e9-659920303091","ms":0,"msg":"route_success"}
{"level":30,"time":1755692135394,"pid":20,"hostname":"b479b09165e0","lessonId":"00000000-0000-0000-0000-000000000001","userId":"22222222-2222-2222-2222-222222222222","ms":0,"msg":"progress_marked"}
{"level":30,"time":1755692135394,"pid":20,"hostname":"b479b09165e0","requestId":"5bd2bcd4-dd98-4c37-a5ee-a9df519968c9","ms":0,"msg":"route_success"}
PASS tests/unit/api.dto.enforced.on.success.spec.ts
FAIL tests/unit/api.progress.access.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.progress.access.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.progress.access.spec.ts:3:1)

PASS tests/unit/schemas.quiz.spec.ts
PASS tests/unit/schemas.dashboard.spec.ts
FAIL tests/unit/api.runtime.teacher.outcomes.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.runtime.teacher.outcomes.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.runtime.teacher.outcomes.spec.ts:2:1)

FAIL tests/unit/api.messages.read-all.spec.ts
  ‚óè API /api/messages/threads/[id]/read-all ‚Ä∫ marks all messages as read for participant; non-participant remains unaffected (TEST_MODE)

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

      24 |     globalThis.__TEST_HEADERS_STORE__?.cookies?.set?.('x-test-auth', 'student');
      25 |     const res = await (ReadAllPATCH as any)(makePatch(`http://localhost/api/messages/threads/${th.id}/read-all`), { params: { id: th.id } } as any);
    > 26 |     expect(res.status).toBe(200);
         |                        ^
      27 |     const json = await res.json();
      28 |     expect(json.ok).toBe(true);
      29 |   });

      at Object.<anonymous> (unit/api.messages.read-all.spec.ts:26:24)

{"level":30,"time":1755692136460,"pid":20,"hostname":"b479b09165e0","requestId":"c515000c-c276-4202-8826-7685bdd4cf32","ms":0,"msg":"route_success"}
{"level":50,"time":1755692136461,"pid":20,"hostname":"b479b09165e0","requestId":"8a781053-6485-4f7e-aeb9-461fbb5a4db6","issues":[{"path":"updated","message":"Required"}],"msg":"dto_response_validation_failed"}
{"level":30,"time":1755692136461,"pid":20,"hostname":"b479b09165e0","requestId":"d7d1eeb7-bf82-44f7-b408-fd8ac78a0060","ms":0,"msg":"route_success"}
{"level":30,"time":1755692136677,"pid":20,"hostname":"b479b09165e0","requestId":"49b567bb-805a-45c4-bdfb-0c7437f04fa9","ms":1,"msg":"route_success"}
{"level":30,"time":1755692136678,"pid":20,"hostname":"b479b09165e0","requestId":"be7d5196-fb25-4120-949e-9754bce0f943","ms":0,"msg":"route_success"}
{"level":50,"time":1755692136679,"pid":20,"hostname":"b479b09165e0","requestId":"d9e0d936-4bd0-47c9-9cb6-9be217c5a6ba","issues":[{"path":"abc.url","message":"Invalid url"},{"path":"x y.url","message":"Invalid url"},{"path":"z/1.url","message":"Invalid url"}],"msg":"dto_response_validation_failed"}
{"level":30,"time":1755692136679,"pid":20,"hostname":"b479b09165e0","requestId":"90a0b67c-9c9d-4102-9283-0db7529f6912","ms":1,"msg":"route_success"}
FAIL tests/unit/api.files.resolve.spec.ts
  ‚óè API /api/files/resolve ‚Ä∫ test-mode: returns mapping for keys with signed download-url

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

      22 |   test('test-mode: returns mapping for keys with signed download-url', async () => {
      23 |     const res = await (ResolvePOST as any)(makePost({ keys: ['abc', 'x y', 'z/1'] }, { 'x-test-auth': 'student' }));
    > 24 |     expect(res.status).toBe(200);
         |                        ^
      25 |     const json = await res.json();
      26 |     expect(json['abc'].url).toBe('/api/files/download-url?id=abc');
      27 |     expect(json['x y'].url).toBe('/api/files/download-url?id=x%20y');

      at Object.<anonymous> (unit/api.files.resolve.spec.ts:24:24)

PASS tests/unit/api.lessons-complete.spec.ts
PASS tests/unit/lib.jwksCache.ttl.spec.ts
{"level":30,"time":1755692136968,"pid":20,"hostname":"b479b09165e0","requestId":"a889e3b1-a19d-48fc-a8c8-d35e22021071","ms":0,"msg":"route_success"}
{"level":30,"time":1755692136968,"pid":20,"hostname":"b479b09165e0","requestId":"cc7a885a-50c0-4593-a9b9-8ad1b99cbc00","ms":0,"msg":"route_success"}
{"level":30,"time":1755692136969,"pid":20,"hostname":"b479b09165e0","lessonId":"00000000-0000-0000-0000-000000000001","userId":"22222222-2222-2222-2222-222222222222","ms":0,"msg":"progress_marked"}
{"level":30,"time":1755692136969,"pid":20,"hostname":"b479b09165e0","requestId":"fbe8f925-9492-4c30-8b89-9261b66dfa0f","ms":0,"msg":"route_success"}
FAIL tests/unit/middleware.security-headers.spec.ts
  ‚óè middleware security headers ‚Ä∫ sets X-Frame-Options: DENY and CSP frame-ancestors none

    TypeError: server_1.NextResponse.next is not a function

      84 |     }
      85 |   } catch {}
    > 86 |   const res = NextResponse.next({ request: { headers } });
         |                            ^
      87 |   res.headers.set("x-request-id", requestId);
      88 |   res.headers.set("Content-Security-Policy", csp);
      89 |   if (process.env.NODE_ENV === 'production') {

      at Object.middleware (../apps/web/middleware.ts:86:28)
      at Object.<anonymous> (unit/middleware.security-headers.spec.ts:30:29)

FAIL tests/unit/api.runtime.outcomes.jwks.rotation.spec.ts
  ‚óè runtime outcomes JWKS rotation ‚Ä∫ refreshes JWKS on verify failure

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 201]

      21 |     const req = new Request('http://localhost/api/runtime/outcomes', { method: 'POST', headers: { 'content-type': 'application/json', authorization: 'Bearer PROVIDERJWT' } as any, body: JSON.stringify({ courseId: 'c1', userId: 'u1', event: { type: 'attempt.completed', runtimeAttemptId: 'ra1', score: 1, max: 1, passed: true } }) } as any);
      22 |     const res = await route.POST(req as any);
    > 23 |     expect([200,201]).toContain(res.status);
         |                       ^
      24 |   });
      25 | });
      26 |

      at Object.<anonymous> (unit/api.runtime.outcomes.jwks.rotation.spec.ts:23:23)

FAIL tests/unit/api.courses.transfer-owner.audit.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.courses.transfer-owner.audit.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.courses.transfer-owner.audit.spec.ts:3:1)

{"level":30,"time":1755692137326,"pid":20,"hostname":"b479b09165e0","requestId":"c54e4444-34e3-47b2-8be4-25e9cbe66b75","ms":1,"msg":"route_success"}
FAIL tests/unit/api.health.requiredEnvs.spec.ts
  ‚óè api.health requiredEnvs snapshot ‚Ä∫ includes Supabase keys and runtime keys when RUNTIME_API_V2=1

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: undefined

      19 |     expect(json.requiredEnvs.NEXT_PUBLIC_SUPABASE_URL).toBe(true);
      20 |     expect(json.requiredEnvs.NEXT_PUBLIC_SUPABASE_ANON_KEY).toBe(true);
    > 21 |     expect(json.requiredEnvs.NEXT_RUNTIME_PUBLIC_KEY).toBe(true);
         |                                                       ^
      22 |     expect(json.requiredEnvs.NEXT_RUNTIME_PRIVATE_KEY).toBe(true);
      23 |     expect(json.requiredEnvs.NEXT_RUNTIME_KEY_ID).toBe(true);
      24 |   });

      at Object.<anonymous> (unit/api.health.requiredEnvs.spec.ts:21:55)

FAIL tests/unit/db.rls.assignments.negative.spec.ts
  ‚óè Assignments RLS/authorization negatives ‚Ä∫ student cannot create assignment

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 403]

      4 |     const req = new Request('http://localhost/api/assignments', { method: 'POST', headers: { 'content-type': 'application/json', 'x-test-auth': 'student' } as any, body: JSON.stringify({ course_id: 'c1', title: 'X', points: 10, due_at: null }) } as any);
      5 |     const res = await route.POST(req as any);
    > 6 |     expect([401,403]).toContain(res.status);
        |                       ^
      7 |   });
      8 |
      9 |   test('student cannot update assignment', async () => {

      at Object.<anonymous> (unit/db.rls.assignments.negative.spec.ts:6:23)

FAIL tests/unit/api.providers.get.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.providers.get.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.providers.get.spec.ts:3:1)

{"level":30,"time":1755692138089,"pid":20,"hostname":"b479b09165e0","requestId":"00a7b860-1792-4f7b-9027-8df7843f6710","ms":1,"msg":"route_success"}
{"level":30,"time":1755692138091,"pid":20,"hostname":"b479b09165e0","requestId":"e71aa44c-a597-40b9-928d-42e4c7b30cbe","ms":1,"msg":"route_success"}
{"level":30,"time":1755692138091,"pid":20,"hostname":"b479b09165e0","requestId":"1f5ea4f1-f66c-4dcb-8bf9-ade4db2fe7a3","ms":0,"msg":"route_success"}
{"level":30,"time":1755692138696,"pid":20,"hostname":"b479b09165e0","requestId":"c71eaad3-75c9-416d-9b8d-832c0a5779f6","ms":1,"msg":"route_success"}
{"level":30,"time":1755692138697,"pid":20,"hostname":"b479b09165e0","requestId":"804d44e4-bced-4304-a72b-c1a79ca1c9cd","ms":0,"msg":"route_success"}
PASS tests/unit/api.quiz-choices.dto.spec.ts
PASS tests/unit/api.files.guards-and-headers.spec.ts
FAIL tests/unit/api.headers.security.spec.ts
  ‚óè security headers (CSP frame-ancestors + X-Frame-Options) ‚Ä∫ middleware sets CSP frame-ancestors none and X-Frame-Options DENY

    TypeError: server_1.NextResponse.next is not a function

      84 |     }
      85 |   } catch {}
    > 86 |   const res = NextResponse.next({ request: { headers } });
         |                            ^
      87 |   res.headers.set("x-request-id", requestId);
      88 |   res.headers.set("Content-Security-Policy", csp);
      89 |   if (process.env.NODE_ENV === 'production') {

      at Object.middleware (../apps/web/middleware.ts:86:28)
      at Object.<anonymous> (unit/api.headers.security.spec.ts:29:29)

{"level":30,"time":1755692139146,"pid":20,"hostname":"b479b09165e0","requestId":"ff8922c2-effa-41d9-be4f-cb0fdc78863c","ms":0,"msg":"route_success"}
{"level":30,"time":1755692139147,"pid":20,"hostname":"b479b09165e0","requestId":"hdr-1","ms":0,"msg":"route_success"}
{"level":30,"time":1755692139498,"pid":20,"hostname":"b479b09165e0","requestId":"f5e45fd9-5a6b-4d74-8bf0-e566fc200381","ms":1,"msg":"route_success"}
{"level":30,"time":1755692139499,"pid":20,"hostname":"b479b09165e0","requestId":"29445d06-bfb2-4958-b011-25ac562af942","ms":1,"msg":"route_success"}
PASS tests/unit/api.quiz-questions.dto.spec.ts
PASS tests/unit/api.notifications.prefs.dto.spec.ts
{"level":30,"time":1755692139774,"pid":20,"hostname":"b479b09165e0","requestId":"d5d499da-35d5-4311-97ed-9aba453cc215","ms":0,"msg":"route_success"}
{"level":30,"time":1755692139776,"pid":20,"hostname":"b479b09165e0","requestId":"e53fc54f-7551-4841-99d8-42eb0db87d9f","ms":1,"msg":"route_success"}
PASS tests/unit/api.health.spec.ts
FAIL tests/unit/api.events.producers.spec.ts
  ‚óè Event producers (TEST_MODE) ‚Ä∫ lesson complete records event

    expect(received).toBeTruthy()

    Received: undefined

       9 |     await markLessonComplete('22222222-2222-2222-2222-222222222222', 'aaaaaaaa-aaaa-aaaa-aaaa-000000000111');
      10 |     const ev = getInMemoryEvents().find(e => e.event_type === 'lesson.complete');
    > 11 |     expect(ev).toBeTruthy();
         |                ^
      12 |   });
      13 |
      14 |   test('submission create and grade records events', async () => {

      at Object.<anonymous> (unit/api.events.producers.spec.ts:11:16)

  ‚óè Event producers (TEST_MODE) ‚Ä∫ submission create and grade records events

    expect(received).toBeTruthy()

    Received: undefined

      17 |     const sub = await createSubmissionApi({ assignment_id: 'aaaaaaaa-aaaa-aaaa-aaaa-000000000222', text: '' } as any, '22222222-2222-2222-2222-222222222222');
      18 |     const createEv = getInMemoryEvents().find(e => e.event_type === 'assignment.submit');
    > 19 |     expect(createEv).toBeTruthy();
         |                      ^
      20 |     await gradeSubmissionApi(sub.id, { score: 95 }, '11111111-1111-1111-1111-111111111111');
      21 |     const gradeEv = getInMemoryEvents().find(e => e.event_type === 'assignment.graded');
      22 |     expect(gradeEv).toBeTruthy();

      at Object.<anonymous> (unit/api.events.producers.spec.ts:19:22)

{"level":30,"time":1755692140291,"pid":20,"hostname":"b479b09165e0","lessonId":"aaaaaaaa-aaaa-aaaa-aaaa-000000000111","userId":"22222222-2222-2222-2222-222222222222","ms":0,"msg":"progress_marked"}
{"level":30,"time":1755692140538,"pid":20,"hostname":"b479b09165e0","requestId":"0619febe-412e-461f-8ea8-48d3c88923d2","ms":0,"msg":"route_success"}
PASS tests/unit/lib.cors.preflight.spec.ts
PASS tests/unit/api.csrf.double-submit.negatives.spec.ts
FAIL tests/unit/api.files.upload-url.quota.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.files.upload-url.quota.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.files.upload-url.quota.spec.ts:2:1)

PASS tests/unit/apiHandler.ratelimit.spec.ts
FAIL tests/unit/api.reports.dto.spec.ts
  ‚óè reports endpoints headers and DTO-like responses ‚Ä∫ GET /api/reports/grade-distribution CSV includes header and x-request-id

    expect(received).toBeTruthy()

    Received: false

      20 |     expect(res.headers.get('x-request-id')).toBeTruthy();
      21 |     const ct = res.headers.get('content-type') || '';
    > 22 |     expect(ct.includes('text/csv')).toBeTruthy();
         |                                     ^
      23 |   });
      24 | });
      25 |

      at Object.<anonymous> (unit/api.reports.dto.spec.ts:22:37)

{"level":30,"time":1755692141435,"pid":20,"hostname":"b479b09165e0","requestId":"d702f650-fd41-4906-bd19-acf0f6692916","ms":0,"msg":"route_success"}
{"level":30,"time":1755692141437,"pid":20,"hostname":"b479b09165e0","requestId":"8ce4992a-bb14-4307-ae69-832435c44018","ms":1,"msg":"route_success"}
{"level":30,"time":1755692141737,"pid":20,"hostname":"b479b09165e0","requestId":"c2d1958b-b989-4238-ad3c-46cbeb5d2cdc","ms":0,"msg":"route_success"}
FAIL tests/unit/api.notifications.patch.csrf.spec.ts
  ‚óè notifications preferences PATCH respects CSRF double-submit ‚Ä∫ 403 when tokens missing or mismatched; 200 when matched

    expect(received).toContain(expected) // indexOf

    Expected value: 401
    Received array: [200]

      17 |     // Match -> 200
      18 |     res = await (NotifPrefsPATCH as any)(patch({ origin: 'http://localhost', referer: 'http://localhost/p', cookie: 'csrf_token=t', 'x-csrf-token': 't', 'content-type': 'application/json' }));
    > 19 |     expect([200]).toContain(res.status);
         |                   ^
      20 |   });
      21 | });
      22 |

      at Object.<anonymous> (unit/api.notifications.patch.csrf.spec.ts:19:19)

PASS tests/unit/api.submissions.csrf.negatives.spec.ts
FAIL tests/unit/ui/TeacherAnnouncements.spec.tsx
  ‚óè Teacher Announcements (labs) ‚Ä∫ renders course count and announcement list with jitter

    TypeError: c.getAll is not a function

      11 |   const h = headers();
      12 |   const c = cookies();
    > 13 |   const cookieHeader = h.get("cookie") ?? c.getAll().map(x => `${x.name}=${x.value}`).join("; ");
         |                                             ^
      14 |   const testAuth = h.get("x-test-auth") ?? c.get("x-test-auth")?.value;
      15 |
      16 |   const baseHeaders = { ...(cookieHeader ? { cookie: cookieHeader } : {}), ...(testAuth ? { "x-test-auth": testAuth } : {}) } as HeadersInit;

      at TeacherAnnouncementsPage (../apps/web/src/app/labs/teacher/announcements/page.tsx:13:45)
      at Object.<anonymous> (unit/ui/TeacherAnnouncements.spec.tsx:25:46)

FAIL tests/unit/api.user-profile.put.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.user-profile.put.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.user-profile.put.spec.ts:3:1)

FAIL tests/unit/ui/TeacherCourseInsightsAdvanced.spec.tsx
  ‚óè Teacher Course Insights (Advanced) ‚Ä∫ renders table and totals with jitter

    TypeError: cookieStore.getAll is not a function

      15 |   const cookieStore = cookies();
      16 |   const incoming = headers();
    > 17 |   const cookieHeader = cookieStore.getAll().map(c => `${c.name}=${c.value}`).join("; ");
         |                                    ^
      18 |   const xTestAuth = incoming.get("x-test-auth") ?? cookieStore.get("x-test-auth")?.value;
      19 |
      20 |   const baseHeaders: HeadersInit = {

      at TeacherCourseInsightsAdvancedPage (../apps/web/src/app/labs/teacher/course-insights-advanced/page.tsx:17:36)
      at Object.<anonymous> (unit/ui/TeacherCourseInsightsAdvanced.spec.tsx:27:55)

PASS tests/unit/api.notifications-preferences.rate-limit.spec.ts
FAIL tests/unit/api.files.download-url.dev-namespace.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.files.download-url.dev-namespace.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.files.download-url.dev-namespace.spec.ts:3:1)

FAIL tests/unit/api.providers.create.negatives.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.providers.create.negatives.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.providers.create.negatives.spec.ts:3:1)

{"level":30,"time":1755692143838,"pid":20,"hostname":"b479b09165e0","requestId":"327d7550-426e-4ff0-94fd-629c3dd812fa","ms":0,"msg":"route_success"}
PASS tests/unit/schemas.announcement.spec.ts
FAIL tests/unit/api.providers.create.happy-path.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.providers.create.happy-path.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.providers.create.happy-path.spec.ts:3:1)

PASS tests/unit/ui/SystemDiagnosticsSuite.spec.tsx
PASS tests/unit/ui/StudentStudyDigest.spec.tsx
PASS tests/unit/api.progress.student-map.spec.ts
{"level":30,"time":1755692146223,"pid":20,"hostname":"b479b09165e0","requestId":"890aa775-6eb4-4326-8ad9-4621c34c8c04","ms":1,"msg":"route_success"}
{"level":30,"time":1755692146224,"pid":20,"hostname":"b479b09165e0","requestId":"rid-1","ms":1,"msg":"route_success"}
{"level":30,"time":1755692146224,"pid":20,"hostname":"b479b09165e0","requestId":"cbef4485-c1c1-4a8d-8f20-c0672bbe64b2","ms":0,"msg":"route_success"}
{"level":30,"time":1755692146488,"pid":20,"hostname":"b479b09165e0","requestId":"7f1fba86-0e04-4cc6-9ed4-274cafd12e15","ms":1,"msg":"route_success"}
FAIL tests/unit/api.messages.post.ratelimit.spec.ts
  ‚óè messages POST rate limit headers ‚Ä∫ returns 429 with standard headers when rate-limited

    expect(received).toBe(expected) // Object.is equality

    Expected: 429
    Received: 201

      19 |   test('returns 429 with standard headers when rate-limited', async () => {
      20 |     const res = await (MessagesPOST as any)(post({ thread_id: '00000000-0000-0000-0000-000000000001', body: 'hello' }));
    > 21 |     expect(res.status).toBe(429);
         |                        ^
      22 |     expect(res.headers.get('retry-after')).toBeTruthy();
      23 |     expect(res.headers.get('x-rate-limit-reset')).toBeTruthy();
      24 |     expect(res.headers.get('x-rate-limit-remaining')).toBe('0');

      at Object.<anonymous> (unit/api.messages.post.ratelimit.spec.ts:21:24)

PASS tests/unit/server.withRouteTiming.ratelimit.spec.ts
{"level":30,"time":1755692146705,"pid":20,"hostname":"b479b09165e0","requestId":"d25cbf3b-d3a0-4f50-978b-8c1e6930b311","ms":0,"msg":"route_success"}
{"level":30,"time":1755692146981,"pid":20,"hostname":"b479b09165e0","requestId":"d46a2763-6581-4ce0-9ade-1f4d8ca17c43","ms":1,"msg":"route_success"}
{"level":30,"time":1755692146981,"pid":20,"hostname":"b479b09165e0","requestId":"24079b3c-b767-4250-9b73-463121db2914","ms":0,"msg":"route_success"}
PASS tests/unit/api.files.access.spec.ts
FAIL tests/unit/api.providers.health.ratelimit.spec.ts
  ‚óè providers health rate-limit headers ‚Ä∫ 429 includes retry-after and x-rate-limit-* headers

    TypeError: supabase.from(...).select(...).eq is not a function

      33 |
      34 |   const supabase = getRouteHandlerSupabase();
    > 35 |   const { data: row, error } = await supabase.from('course_providers').select('id,name,jwks_url,domain').eq('id', q.id).single();
         |                                                                                                          ^
      36 |   if (error) return NextResponse.json({ error: { code: 'DB_ERROR', message: error.message }, requestId }, { status: 500, headers: { 'x-request-id': requestId } });
      37 |   if (!row) return NextResponse.json({ error: { code: 'NOT_FOUND', message: 'Provider not found' }, requestId }, { status: 404, headers: { 'x-request-id': requestId } });
      38 |

      at GET (../apps/web/src/app/api/providers/health/route.ts:35:106)
      at Object.GET (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.providers.health.ratelimit.spec.ts:17:15)

FAIL tests/unit/api.files.quota.enforcement.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.files.quota.enforcement.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.files.quota.enforcement.spec.ts:2:1)

FAIL tests/unit/api.enrollments.launch-token.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.enrollments.launch-token.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.enrollments.launch-token.spec.ts:3:1)

{"level":50,"time":1755692147242,"pid":20,"hostname":"b479b09165e0","requestId":"1a25f97e-2823-4e2a-a462-107e414e68f7","ms":1,"err":"supabase.from(...).select(...).eq is not a function","msg":"route_error"}
{"level":30,"time":1755692147978,"pid":20,"hostname":"b479b09165e0","requestId":"4e10d204-3694-4791-865f-c97fdbf0d592","ms":0,"msg":"route_success"}
{"level":50,"time":1755692147978,"pid":20,"hostname":"b479b09165e0","requestId":"69a84800-f35b-4914-bbd3-e55c9916392b","ms":0,"err":"boom","msg":"route_error"}
PASS tests/unit/server.withRouteTiming.metrics.spec.ts
PASS tests/unit/apiHandler.requestId.spec.ts
PASS tests/unit/services.assignments.spec.ts
FAIL tests/unit/gateways/reports.gateway.spec.ts
  ‚óè ReportsGateway ‚Ä∫ engagement returns counters (course scoped)

    expect(received).toBe(expected) // Object.is equality

    Expected: 3
    Received: 12

      15 |     }));
      16 |     const out = await createReportsGateway().engagement('c-1');
    > 17 |     expect(out.lessons).toBe(3);
         |                         ^
      18 |     expect(out.assignments).toBe(2);
      19 |   });
      20 |

      at Object.<anonymous> (unit/gateways/reports.gateway.spec.ts:17:25)

  ‚óè ReportsGateway ‚Ä∫ gradeDistribution returns shape (admin/global)

    expect(received).toBe(expected) // Object.is equality

    Expected: 10
    Received: 42

      28 |     }));
      29 |     const out = await createReportsGateway().gradeDistribution();
    > 30 |     expect(out.total).toBe(10);
         |                       ^
      31 |     expect(out.dist[0].bucket).toBe('80-89');
      32 |   });
      33 | });

      at Object.<anonymous> (unit/gateways/reports.gateway.spec.ts:30:23)

PASS tests/unit/services.messaging.spec.ts
PASS tests/unit/ui/StudentLearningOverviewDetailed.spec.tsx
PASS tests/unit/ui/StudentLearningOverviewAdvanced.spec.tsx
PASS tests/unit/api.registry.versions.rate-limit.spec.ts
{"level":30,"time":1755692149812,"pid":20,"hostname":"b479b09165e0","requestId":"89cd3372-4e21-4f99-be1f-8a1fbcd32bde","ms":0,"msg":"route_success"}
{"level":30,"time":1755692149813,"pid":20,"hostname":"b479b09165e0","requestId":"6b4daf25-996b-4acb-a1a6-f42d2ed37047","ms":1,"msg":"route_success"}
{"level":30,"time":1755692150063,"pid":20,"hostname":"b479b09165e0","requestId":"1aaf12b4-31bd-49d5-92da-ed6e74e9f3b9","ms":0,"msg":"route_success"}
PASS tests/unit/api.problem-envelope.matrix.spec.ts
FAIL tests/unit/api.files.av-and-quota.negatives.spec.ts
  ‚óè files AV stub and quota exceed ‚Ä∫ EICAR-like content rejected

    expect(received).toContain(expected) // indexOf

    Expected value: 500
    Received array: [400, 200]

      14 |     const id = encodeURIComponent(j.key || 'k');
      15 |     const res = await (UploadPUT as any)(put(`?owner_type=user&owner_id=u1&content_type=text/plain`, `X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*`));
    > 16 |     expect([400,200]).toContain(res.status);
         |                       ^
      17 |   });
      18 | });
      19 |

      at Object.<anonymous> (unit/api.files.av-and-quota.negatives.spec.ts:16:23)

{"level":30,"time":1755692150305,"pid":20,"hostname":"b479b09165e0","requestId":"97d58bf1-9c1e-49b5-a3d1-0ff3f2bbb597","ms":1,"msg":"route_success"}
{"level":50,"time":1755692150306,"pid":20,"hostname":"b479b09165e0","requestId":"c86464d5-7227-4ef9-90dd-919c3cac072c","issues":[{"path":"url","message":"Invalid url"}],"msg":"dto_response_validation_failed"}
{"level":30,"time":1755692150306,"pid":20,"hostname":"b479b09165e0","requestId":"e02a5749-b81e-426a-8f3e-667d94653df9","ms":1,"msg":"route_success"}
PASS tests/unit/lib.serverFetch.csrf-header.spec.ts
PASS tests/unit/api.messages.scoping.spec.ts
{"level":30,"time":1755692150754,"pid":20,"hostname":"b479b09165e0","requestId":"059cd917-16b4-4deb-a87e-4858380a9197","ms":1,"msg":"route_success"}
{"level":30,"time":1755692150754,"pid":20,"hostname":"b479b09165e0","requestId":"f9023536-a346-4995-a406-ea760d296671","ms":0,"msg":"route_success"}
PASS tests/unit/api.runtime.checkpoint.preflight.spec.ts
PASS tests/unit/api.messages.threads.spec.ts
{"level":30,"time":1755692151275,"pid":20,"hostname":"b479b09165e0","requestId":"d6a98239-1317-4539-97bb-11e96ac2e2df","ms":0,"msg":"route_success"}
{"level":30,"time":1755692151276,"pid":20,"hostname":"b479b09165e0","requestId":"7858fee0-fb8f-4d70-8f0e-dc8f712c81b6","ms":0,"msg":"route_success"}
{"level":30,"time":1755692151277,"pid":20,"hostname":"b479b09165e0","requestId":"44e41237-816c-4ad5-8608-eea4b2961360","ms":1,"msg":"route_success"}
{"level":30,"time":1755692151500,"pid":20,"hostname":"b479b09165e0","requestId":"e0b71d39-1e10-484a-a392-a24168720f6b","ms":1,"msg":"route_success"}
{"level":30,"time":1755692151500,"pid":20,"hostname":"b479b09165e0","requestId":"1819a58f-bda9-4b33-a529-a8a367bcd2b7","ms":0,"msg":"route_success"}
PASS tests/unit/api.messages.ratelimit.headers.spec.ts
FAIL tests/unit/middleware.coep.flag.spec.ts
  ‚óè middleware COEP flag ‚Ä∫ sets Cross-Origin-Embedder-Policy when COEP=1

    TypeError: server_1.NextResponse.next is not a function

      84 |     }
      85 |   } catch {}
    > 86 |   const res = NextResponse.next({ request: { headers } });
         |                            ^
      87 |   res.headers.set("x-request-id", requestId);
      88 |   res.headers.set("Content-Security-Policy", csp);
      89 |   if (process.env.NODE_ENV === 'production') {

      at Object.middleware (../apps/web/middleware.ts:86:28)
      at Object.<anonymous> (unit/middleware.coep.flag.spec.ts:29:29)

PASS tests/unit/api.admin.metrics.spec.ts
{"level":30,"time":1755692151809,"pid":20,"hostname":"b479b09165e0","requestId":"7779abd9-03ba-48b1-a2d5-849e2df5fb9b","ms":1,"msg":"route_success"}
{"level":30,"time":1755692151810,"pid":20,"hostname":"b479b09165e0","requestId":"5f2591a3-cb22-4fb0-a44e-8a18762a512c","ms":1,"msg":"route_success"}
{"level":30,"time":1755692151810,"pid":20,"hostname":"b479b09165e0","requestId":"353f2cce-95ac-40eb-a738-63ef2bf7712d","ms":0,"msg":"route_success"}
PASS tests/unit/services.submissions.queue.edges.spec.ts
PASS tests/unit/api.runtime.auth.exchange.edgecases.spec.ts
{"level":30,"time":1755692152280,"pid":20,"hostname":"b479b09165e0","requestId":"96880a14-548f-44a9-9def-90a16d42d24e","ms":0,"msg":"route_success"}
{"level":30,"time":1755692152303,"pid":20,"hostname":"b479b09165e0","requestId":"2eea48a6-085d-43cb-819f-b734e7257f1a","ms":22,"msg":"route_success"}
{"level":30,"time":1755692152512,"pid":20,"hostname":"b479b09165e0","requestId":"c06b65ab-9d55-4bc2-9830-3a1a3156d5f9","ms":1,"msg":"route_success"}
{"level":30,"time":1755692152512,"pid":20,"hostname":"b479b09165e0","requestId":"1f438cb8-b53a-4b21-aed4-27f9ed3339e3","ms":0,"msg":"route_success"}
{"level":30,"time":1755692152513,"pid":20,"hostname":"b479b09165e0","requestId":"ad0ca6d7-11f6-43c9-84e3-b9d27e07505d","ms":1,"msg":"route_success"}
{"level":50,"time":1755692152513,"pid":20,"hostname":"b479b09165e0","requestId":"5e8bea73-f2bf-46d6-880f-db5a64200b51","issues":[{"path":"key","message":"Expected boolean, received string"}],"msg":"dto_response_validation_failed"}
{"level":30,"time":1755692152513,"pid":20,"hostname":"b479b09165e0","requestId":"f901c42c-628c-451c-8d4b-69e3330230c9","ms":0,"msg":"route_success"}
FAIL tests/unit/api.flags.spec.ts
  ‚óè Feature flags API (test-mode) ‚Ä∫ GET requires auth, returns list; PATCH validates key

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

      16 |     // PATCH toggle a flag
      17 |     const ok = await route.PATCH(new Request('http://localhost/api/flags', { method: 'PATCH', headers: { 'content-type': 'application/json', 'x-test-auth': 'admin' }, body: JSON.stringify({ key: 'reports.enabled', value: true }) }) as any);
    > 18 |     expect(ok.status).toBe(200);
         |                       ^
      19 |   });
      20 | });
      21 |

      at Object.<anonymous> (unit/api.flags.spec.ts:18:23)

FAIL tests/unit/api.runtime.jwks.rotation.spec.ts
  ‚óè runtime JWKS rotation (kid refresh) ‚Ä∫ on verify failure, JWKS cache clears and a subsequent verify can succeed

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 403]

      10 |     const body = { courseId: 'c1', userId: 'u1', event: { type: 'progress', pct: 10 } };
      11 |     const bad = await (OutcomesPOST as any)(post(body, { authorization: 'Bearer bad.token.value' }));
    > 12 |     expect([401,403]).toContain(bad.status);
         |                       ^
      13 |     // Clear cache hook (simulated by env toggle) and retry
      14 |     (process as any).env.JWKS_TTL_MS = '1';
      15 |     const again = await (OutcomesPOST as any)(post(body, { authorization: 'Bearer bad.token.value' }));

      at Object.<anonymous> (unit/api.runtime.jwks.rotation.spec.ts:12:23)

{"level":30,"time":1755692152744,"pid":20,"hostname":"b479b09165e0","requestId":"eec6a3ed-1636-467f-87d0-c68cffaf0967","ms":1,"msg":"route_success"}
{"level":30,"time":1755692153114,"pid":20,"hostname":"b479b09165e0","requestId":"90997a68-e1bf-43ce-8983-c34b7c06edcf","ms":0,"msg":"route_success"}
{"level":30,"time":1755692153115,"pid":20,"hostname":"b479b09165e0","requestId":"b2b88478-07fe-4925-aff0-fd000c643e39","ms":1,"msg":"route_success"}
{"level":50,"time":1755692153115,"pid":20,"hostname":"b479b09165e0","requestId":"dd5851bc-5e59-4803-ab8c-62fc7e26b234","ms":0,"err":"supabase.from(...).select(...).order is not a function","msg":"route_error"}
FAIL tests/unit/api.reports.activity-retention.spec.ts
  ‚óè API /api/reports/activity & /api/reports/retention (TEST_MODE) ‚Ä∫ retention returns array of { day, dau } when authed

    TypeError: supabase.from(...).select(...).order is not a function

      15 |   try { q = parseQuery(req, qSchema); } catch (e: any) { return NextResponse.json({ error: { code: 'BAD_REQUEST', message: e.message }, requestId }, { status: 400, headers: { 'x-request-id': requestId } }); }
      16 |   const supabase = getRouteHandlerSupabase();
    > 17 |   let builder: any = supabase.from('daily_active_users').select('day,dau').order('day', { ascending: true });
         |                                                                            ^
      18 |   if (q.from) builder = builder.gte('day', q.from);
      19 |   if (q.to) builder = builder.lte('day', q.to);
      20 |   const { data, error } = await builder;

      at GET (../apps/web/src/app/api/reports/retention/route.ts:17:76)
      at Object.GET (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.reports.activity-retention.spec.ts:22:17)

FAIL tests/unit/api.files.upload-url.spec.ts
  ‚óè api.files.upload-url ‚Ä∫ returns signed fields in test-mode

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 403

      18 |     globalThis.__TEST_HEADERS_STORE__.cookies.set('x-test-auth', 'student');
      19 |     const res = await (UploadPOST as any)(makeReq({ owner_type: 'user', owner_id: 'test-student-id', content_type: 'text/plain' }, { 'x-test-auth': 'student' }));
    > 20 |     expect(res.status).toBe(200);
         |                        ^
      21 |     const json = await res.json();
      22 |     expect(json.url).toContain('/api/files/upload-url');
      23 |     expect(json.fields).toBeDefined();

      at Object.<anonymous> (unit/api.files.upload-url.spec.ts:20:24)

{"level":30,"time":1755692153354,"pid":20,"hostname":"b479b09165e0","requestId":"ee20ac10-fa1c-46e2-bdf5-56cfaba2349f","ms":0,"msg":"route_success"}
{"level":30,"time":1755692153355,"pid":20,"hostname":"b479b09165e0","requestId":"a43b21b3-b62d-47d7-8b08-b39f7ec8d7bc","ms":0,"msg":"route_success"}
{"level":30,"time":1755692153588,"pid":20,"hostname":"b479b09165e0","requestId":"a759561a-9390-442c-b99e-04f2e14cd723","ms":0,"msg":"route_success"}
{"level":30,"time":1755692153589,"pid":20,"hostname":"b479b09165e0","requestId":"a6406ef5-ad99-4fac-ba8a-25e71a895768","ms":0,"msg":"route_success"}
PASS tests/unit/api.runtime.auth.aud-and-scopes.spec.ts
FAIL tests/unit/api.courses.transfer-owner.ratelimit.spec.ts
  ‚óè courses transfer-owner rate-limit headers ‚Ä∫ returns 429 with standard headers when limited

    TypeError: supabase.from(...).select(...).eq is not a function

      38 |   // Only current teacher owner or admin can transfer
      39 |   if (role !== 'admin') {
    > 40 |     const { data: course } = await supabase.from('courses').select('id,teacher_id').eq('id', params.id).single();
         |                                                                                     ^
      41 |     if (!course || (course as any).teacher_id !== user.id) {
      42 |       return NextResponse.json({ error: { code: 'FORBIDDEN', message: 'Not allowed' }, requestId }, { status: 403, headers: { 'x-request-id': requestId } });
      43 |     }

      at PATCH (../apps/web/src/app/api/courses/[id]/transfer-owner/route.ts:40:85)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.courses.transfer-owner.ratelimit.spec.ts:12:17)

{"level":50,"time":1755692153802,"pid":20,"hostname":"b479b09165e0","requestId":"dff2509f-f123-43de-999c-0ea5bf6de6f4","ms":1,"err":"supabase.from(...).select(...).eq is not a function","msg":"route_error"}
{"level":30,"time":1755692154041,"pid":20,"hostname":"b479b09165e0","requestId":"819f2e75-64d9-4d3f-b5b1-f559e089f180","ms":0,"msg":"route_success"}
PASS tests/unit/api.assignments.delete.ratelimit.spec.ts
PASS tests/unit/api.progress.rls.negatives.spec.ts
FAIL tests/unit/api.files.download-url.dev-namespace.guard.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.files.download-url.dev-namespace.guard.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.files.download-url.dev-namespace.guard.spec.ts:2:1)

{"level":30,"time":1755692154265,"pid":20,"hostname":"b479b09165e0","requestId":"c240a10d-6212-4c8c-89dc-0f7e0e81eae5","ms":1,"msg":"route_success"}
{"level":30,"time":1755692154265,"pid":20,"hostname":"b479b09165e0","requestId":"9cad57a8-2521-45f3-a623-4c016db2d7cf","ms":0,"msg":"route_success"}
{"level":30,"time":1755692154737,"pid":20,"hostname":"b479b09165e0","requestId":"cd879638-b067-4075-9c26-39222891463b","ms":1,"msg":"route_success"}
{"level":30,"time":1755692154737,"pid":20,"hostname":"b479b09165e0","requestId":"334af985-a920-4283-91fd-3255479be1c8","ms":0,"msg":"route_success"}
PASS tests/unit/api.parent-links.ratelimit.spec.ts
FAIL tests/unit/api.files.upload-url.ratelimit.spec.ts
  ‚óè files upload-url rate limit headers ‚Ä∫ 429 includes rate limit headers

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 401]

      15 |     const payload = { owner_type: 'user', owner_id: 'test-student-id', content_type: 'text/plain' };
      16 |     const res1 = await (UploadPOST as any)(req(payload));
    > 17 |     expect([200,401]).toContain(res1.status);
         |                       ^
      18 |     const res2 = await (UploadPOST as any)(req(payload));
      19 |     if (res2.status === 429) {
      20 |       expect(res2.headers.get('retry-after')).toBeTruthy();

      at Object.<anonymous> (unit/api.files.upload-url.ratelimit.spec.ts:17:23)

PASS tests/unit/ui/ParentAnnouncementsLab.spec.tsx
FAIL tests/unit/api.attachments.delete.permissions.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.attachments.delete.permissions.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.attachments.delete.permissions.spec.ts:3:1)

{"level":30,"time":1755692154979,"pid":20,"hostname":"b479b09165e0","requestId":"8ccff60c-5486-4a60-afef-a7020e8283e5","ms":1,"msg":"route_success"}
PASS tests/unit/lib.serverFetch.extend.spec.ts
  ‚óè Console

    console.debug
      [serverFetch] 200 http://example.com/api/x 0ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:78:13)

    console.debug
      [serverFetch] 200 http://web:3022/api/demo 0ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:78:13)

PASS tests/unit/ui/StudentLearningOverview.spec.tsx
FAIL tests/unit/api.user.role.audit.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.user.role.audit.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.user.role.audit.spec.ts:2:1)

PASS tests/unit/schemas.message.spec.ts
PASS tests/unit/api.registry.courses.rate-limit.spec.ts
{"level":30,"time":1755692155995,"pid":20,"hostname":"b479b09165e0","requestId":"4fc9908b-1d27-47fe-9f87-c360cb9a11c0","ms":1,"msg":"route_success"}
{"level":30,"time":1755692155995,"pid":20,"hostname":"b479b09165e0","requestId":"c5d98a71-6bdb-4109-b9af-2a96820b0013","ms":0,"msg":"route_success"}
{"level":30,"time":1755692156217,"pid":20,"hostname":"b479b09165e0","requestId":"e88ae934-b433-4c70-b250-011eb988764d","ms":1,"msg":"route_success"}
{"level":30,"time":1755692156218,"pid":20,"hostname":"b479b09165e0","requestId":"6ec87403-0e1c-4609-bd96-843491baf7e3","ms":0,"msg":"route_success"}
PASS tests/unit/api.progress.per-student.spec.ts
PASS tests/unit/server.withRouteTiming.csrf-double-submit.spec.ts
PASS tests/unit/api.runtime.context.roles.spec.ts
{"level":30,"time":1755692156642,"pid":20,"hostname":"b479b09165e0","requestId":"9c360e90-881b-40ed-a80b-6b8fdd4a0d06","ms":1,"msg":"route_success"}
{"level":30,"time":1755692156650,"pid":20,"hostname":"b479b09165e0","requestId":"061afc64-2bd4-48bb-b84a-6bbd7ea6ee9b","ms":8,"msg":"route_success"}
PASS tests/unit/schemas.submission.spec.ts
PASS tests/unit/api.lessons.spec.ts
{"level":30,"time":1755692157063,"pid":20,"hostname":"b479b09165e0","requestId":"33b678a5-3eae-4ebf-a620-8f1db8160699","ms":1,"msg":"route_success"}
{"level":20,"time":1755692157318,"pid":20,"hostname":"b479b09165e0","ms":0,"msg":"dash_student_widgets"}
{"level":30,"time":1755692157318,"pid":20,"hostname":"b479b09165e0","requestId":"4acccb65-8902-4d47-9a90-3c4201b41673","ms":1,"msg":"route_success"}
{"level":20,"time":1755692157318,"pid":20,"hostname":"b479b09165e0","ms":0,"msg":"dash_teacher_widgets"}
{"level":30,"time":1755692157319,"pid":20,"hostname":"b479b09165e0","requestId":"abe2403f-f15d-4090-b3e2-ed04010056dd","ms":1,"msg":"route_success"}
{"level":30,"time":1755692157319,"pid":20,"hostname":"b479b09165e0","requestId":"66a80f21-e88d-4436-95b0-2a4d304a99bb","ms":0,"msg":"route_success"}
{"level":30,"time":1755692157319,"pid":20,"hostname":"b479b09165e0","requestId":"06d7fbc5-90a0-4a86-9ea3-5582f78c136f","ms":0,"msg":"route_success"}
{"level":30,"time":1755692157320,"pid":20,"hostname":"b479b09165e0","requestId":"294f9a28-f93d-4a18-89bb-11d190d47a4f","ms":0,"msg":"route_success"}
{"level":30,"time":1755692157320,"pid":20,"hostname":"b479b09165e0","requestId":"7c462260-1d18-4709-a3d5-069258ad8f87","ms":0,"msg":"route_success"}
{"level":30,"time":1755692157320,"pid":20,"hostname":"b479b09165e0","requestId":"ad754a8f-8ebb-4220-9529-ac7614734205","ms":0,"msg":"route_success"}
{"level":30,"time":1755692157321,"pid":20,"hostname":"b479b09165e0","requestId":"88e85135-d2c7-4314-a44b-980f46a20fed","ms":0,"msg":"route_success"}
PASS tests/unit/api.role.access.matrix.spec.ts
PASS tests/unit/api.assignments.delete.ratelimit.headers.spec.ts
PASS tests/unit/lib.logger.redaction.spec.ts
{"level":50,"time":1755692157564,"pid":20,"hostname":"b479b09165e0","requestId":"c0fad071-cdb9-468a-9f94-63c0adfd6084","issues":[{"path":"id","message":"Required"},{"path":"course_id","message":"Required"},{"path":"title","message":"Required"},{"path":"created_at","message":"Required"}],"msg":"dto_response_validation_failed"}
{"level":30,"time":1755692157564,"pid":20,"hostname":"b479b09165e0","requestId":"df4f1629-54c7-402c-8f7f-fea8a8233ace","ms":1,"msg":"route_success"}
{"level":50,"time":1755692157565,"pid":20,"hostname":"b479b09165e0","requestId":"40bab17b-3182-49c6-8838-0046bd5f30e2","issues":[{"path":"id","message":"Required"},{"path":"course_id","message":"Required"},{"path":"title","message":"Required"},{"path":"created_at","message":"Required"}],"msg":"dto_response_validation_failed"}
{"level":30,"time":1755692157565,"pid":20,"hostname":"b479b09165e0","requestId":"edb289f1-dcdc-4427-9a5d-140b5e07abe2","ms":1,"msg":"route_success"}
{"level":30,"time":1755692157851,"pid":20,"hostname":"b479b09165e0","requestId":"c9a318df-280e-47db-8f3b-bb5b3f6eaf19","ms":1,"msg":"route_success"}
{"level":30,"time":1755692157851,"pid":20,"hostname":"b479b09165e0","requestId":"b82b73fd-afba-4faa-9d4a-9d883d10d075","ms":0,"msg":"route_success"}
PASS tests/unit/api.messages.list.ratelimit.spec.ts
PASS tests/unit/api.lessons.complete.idempotent.spec.ts
{"level":30,"time":1755692158100,"pid":20,"hostname":"b479b09165e0","lessonId":"00000000-0000-0000-0000-00000000aa11","userId":"22222222-2222-2222-2222-222222222222","ms":0,"msg":"progress_marked"}
{"level":30,"time":1755692158100,"pid":20,"hostname":"b479b09165e0","requestId":"918f84cc-0467-461a-8a8a-b2a2da3811e8","ms":1,"msg":"route_success"}
{"level":30,"time":1755692158100,"pid":20,"hostname":"b479b09165e0","lessonId":"00000000-0000-0000-0000-00000000aa11","userId":"22222222-2222-2222-2222-222222222222","ms":0,"msg":"progress_marked"}
{"level":30,"time":1755692158100,"pid":20,"hostname":"b479b09165e0","requestId":"852ad818-8377-4fef-9e86-71ff407031a5","ms":0,"msg":"route_success"}
{"level":30,"time":1755692158338,"pid":20,"hostname":"b479b09165e0","requestId":"4feafcf8-cd79-4f96-9827-4b0063d403c2","ms":1,"msg":"route_success"}
PASS tests/unit/api.files.download-url.disposition.spec.ts
PASS tests/unit/services.modules.spec.ts
PASS tests/unit/ui/SystemPercentileTrends.spec.tsx
PASS tests/unit/schemas.lesson.spec.ts
PASS tests/unit/api.messages.patch.ratelimit.spec.ts
{"level":30,"time":1755692159421,"pid":20,"hostname":"b479b09165e0","requestId":"74dfd021-98dd-459d-9a36-a8733ab21a6a","ms":0,"msg":"route_success"}
{"level":30,"time":1755692159653,"pid":20,"hostname":"b479b09165e0","requestId":"3c992e09-6060-4171-9d90-a88d50cad4ce","ms":1,"msg":"route_success"}
{"level":30,"time":1755692159653,"pid":20,"hostname":"b479b09165e0","requestId":"61a914b6-9948-41b3-ba36-a22094c512ee","ms":0,"msg":"route_success"}
{"level":30,"time":1755692159654,"pid":20,"hostname":"b479b09165e0","requestId":"d2c23fb5-0dec-45a4-978c-e781fa6c7eff","ms":0,"msg":"route_success"}
PASS tests/unit/api.user-profile.spec.ts
PASS tests/unit/api.modules.delete.ratelimit.spec.ts
{"level":30,"time":1755692160054,"pid":20,"hostname":"b479b09165e0","requestId":"5269ee01-2f32-43da-8118-af360ba26e5c","ms":9,"msg":"route_success"}
{"level":50,"time":1755692160428,"pid":20,"hostname":"b479b09165e0","requestId":"8e2c9e62-bff6-4576-83b4-dcd863d18091","ms":1,"err":"supabase.from(...).upsert is not a function","msg":"route_error"}
FAIL tests/unit/api.admin.quotas.ratelimit.spec.ts
  ‚óè admin quotas PATCH rate-limit headers ‚Ä∫ returns 429 and retry-after header when limited

    TypeError: supabase.from(...).upsert is not a function

      52 |   if (typeof body.max_bytes === 'number') row.max_bytes = body.max_bytes;
      53 |   if (typeof body.used_bytes === 'number') row.used_bytes = body.used_bytes;
    > 54 |   const { error } = await supabase.from('user_storage_quotas').upsert(row, { onConflict: 'user_id' } as any);
         |                                                                ^
      55 |   if (error) return NextResponse.json({ error: { code: 'DB_ERROR', message: error.message }, requestId }, { status: 500, headers: { 'x-request-id': requestId } });
      56 |   return jsonDto({ ok: true } as any, z.object({ ok: z.boolean() }) as any, { requestId, status: 200 });
      57 | });

      at PATCH (../apps/web/src/app/api/admin/quotas/route.ts:54:64)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.admin.quotas.ratelimit.spec.ts:14:17)

FAIL tests/unit/gateways/enrollments.gateway.spec.ts
  ‚óè Console

    console.debug
      [serverFetch] 200 http://web:3022/api/enrollments 0ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:78:13)

  ‚óè EnrollmentsGateway.list ‚Ä∫ returns enrollments array

    ZodError: [
      {
        "validation": "uuid",
        "code": "invalid_string",
        "message": "Invalid uuid",
        "path": [
          0,
          "id"
        ]
      },
      {
        "validation": "uuid",
        "code": "invalid_string",
        "message": "Invalid uuid",
        "path": [
          0,
          "course_id"
        ]
      },
      {
        "validation": "uuid",
        "code": "invalid_string",
        "message": "Invalid uuid",
        "path": [
          1,
          "id"
        ]
      },
      {
        "validation": "uuid",
        "code": "invalid_string",
        "message": "Invalid uuid",
        "path": [
          1,
          "course_id"
        ]
      }
    ]

      100 |     throw new Error(`${code}: ${message}`);
      101 |   }
    > 102 |   return schema.parse(json) as T;
          |                 ^
      103 | }
      104 |
      105 |

      at Object.get error [as error] (../node_modules/zod/v3/types.cjs:45:31)
      at ZodArray.parse (../node_modules/zod/v3/types.cjs:120:22)
      at fetchJson (../apps/web/src/lib/serverFetch.ts:102:17)
      at Object.<anonymous> (unit/gateways/enrollments.gateway.spec.ts:27:18)

PASS tests/unit/schemas.assignment.spec.ts
PASS tests/unit/api.submissions.list.pagination.spec.ts
{"level":30,"time":1755692161150,"pid":20,"hostname":"b479b09165e0","requestId":"1848013d-428f-48d3-a917-76adb0686fb3","ms":1,"msg":"route_success"}
{"level":30,"time":1755692161435,"pid":20,"hostname":"b479b09165e0","requestId":"426ab95b-b6ec-4d6f-984b-4f93b946664b","ms":1,"msg":"route_success"}
PASS tests/unit/api.runtime.checkpoint.roundtrip.spec.ts
PASS tests/unit/api.submissions.grade.spec.ts
PASS tests/unit/ui/StudentUpcomingLessons.spec.tsx
{"level":30,"time":1755692161771,"pid":20,"hostname":"b479b09165e0","requestId":"b7c6bfae-cba9-4f8e-b479-0d48dfce7767","ms":0,"msg":"route_success"}
{"level":30,"time":1755692161771,"pid":20,"hostname":"b479b09165e0","requestId":"1e04a214-a4b6-42ed-8246-fbf861111531","ms":0,"msg":"route_success"}
{"level":30,"time":1755692161772,"pid":20,"hostname":"b479b09165e0","requestId":"5846c0ab-3053-4cdf-88d7-f966d58ccf59","ms":0,"msg":"route_success"}
PASS tests/unit/ui/SystemObserver.spec.tsx
FAIL tests/unit/lib.runtimeAuth.clockskew.spec.ts
  ‚óè runtimeAuth clock skew tolerance ‚Ä∫ accepts tokens within tolerance window (dev HS256 path mocked)

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      12 |     const req = new Request('http://localhost/api/runtime/progress', { headers: { authorization: 'Bearer X', origin: 'https://wcgyhwvugdnzhegwiiam.lovable.app' } as any } as any);
      13 |     const out: any = await (verifyRuntimeAuthorization as any)(req as any, ['progress.write']);
    > 14 |     expect(out.ok).toBe(true);
         |                    ^
      15 |   });
      16 | });
      17 |

      at Object.<anonymous> (unit/lib.runtimeAuth.clockskew.spec.ts:14:20)

PASS tests/unit/ui/TeacherCourseInsights.spec.tsx
FAIL tests/unit/ui/SystemHealthHistory.spec.tsx
  ‚óè System Health History (labs) ‚Ä∫ renders delta stats and timestamps with jitter

    ReferenceError: fetch is not defined

      72 |   }
      73 |   const started = Date.now();
    > 74 |   const res = await fetch(url, { cache: "no-store", ...init, headers: hdrs });
         |               ^
      75 |   try {
      76 |     const ms = Date.now() - started;
      77 |     // eslint-disable-next-line no-console

      at serverFetch (../apps/web/src/lib/serverFetch.ts:74:15)
      at fetchJson (../apps/web/src/lib/serverFetch.ts:88:21)
      at Object.get (../apps/web/src/lib/data/health.ts:14:23)
      at takeSamples (../apps/web/src/app/labs/system/health-history/page.tsx:11:47)
      at HealthHistoryPage (../apps/web/src/app/labs/system/health-history/page.tsx:34:25)
      at Object.<anonymous> (unit/ui/SystemHealthHistory.spec.tsx:15:39)

PASS tests/unit/lib.rateLimit.redis-fallback.spec.ts
FAIL tests/unit/api.runtime.outcomes.iss-aud.negatives.spec.ts
  ‚óè runtime outcomes provider JWT iss/aud negatives ‚Ä∫ invalid issuer/audience format yields 403 when present

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 403]

      10 |     // Without a real JWT, this exercises the code path expectation only; actual 401/403 depends on signature verify
      11 |     const res = await (OutcomesPOST as any)(post(body, { authorization: 'Bearer bad.token.value' }));
    > 12 |     expect([401,403]).toContain(res.status);
         |                       ^
      13 |   });
      14 | });
      15 |

      at Object.<anonymous> (unit/api.runtime.outcomes.iss-aud.negatives.spec.ts:12:23)

{"level":30,"time":1755692164551,"pid":20,"hostname":"b479b09165e0","requestId":"ffb366c0-8340-47a0-901e-a0abd1510731","ms":1,"msg":"route_success"}
PASS tests/unit/ui/SystemLatencySampler.spec.tsx
PASS tests/unit/lib.csp.frame-src-allow.spec.ts
PASS tests/unit/api.dashboard.spec.ts
{"level":30,"time":1755692165391,"pid":20,"hostname":"b479b09165e0","requestId":"21dde196-a8b5-4b25-aa89-2435cb0f6946","ms":1,"msg":"route_success"}
{"level":20,"time":1755692165391,"pid":20,"hostname":"b479b09165e0","ms":0,"msg":"dash_teacher_widgets"}
{"level":30,"time":1755692165392,"pid":20,"hostname":"b479b09165e0","requestId":"594fa212-5e03-40f1-9a6e-0f277ff0a882","ms":1,"msg":"route_success"}
{"level":30,"time":1755692165616,"pid":20,"hostname":"b479b09165e0","requestId":"07d3a15b-cac8-4f9f-a447-78f6053ac528","ms":0,"msg":"route_success"}
{"level":30,"time":1755692165617,"pid":20,"hostname":"b479b09165e0","requestId":"287d7918-f2e1-4fed-89a0-6e53e2adeb54","ms":0,"msg":"route_success"}
PASS tests/unit/api.submissions.grade.validation.spec.ts
PASS tests/unit/db.rls.messages.negative.spec.ts
{"level":30,"time":1755692166118,"pid":20,"hostname":"b479b09165e0","requestId":"f3d56158-0107-467f-b522-5bab876063ee","ms":1,"msg":"route_success"}
{"level":30,"time":1755692166119,"pid":20,"hostname":"b479b09165e0","requestId":"b7a7fecc-6915-49eb-b64c-f9d105ab0fc5","ms":1,"msg":"route_success"}
{"level":30,"time":1755692166365,"pid":20,"hostname":"b479b09165e0","requestId":"e0f7a72e-0732-4c4c-9a52-82fad1a169e5","ms":0,"msg":"route_success"}
PASS tests/unit/api.problem.envelope.codes.spec.ts
PASS tests/unit/schemas.files.spec.ts
PASS tests/unit/api.messages.patch-negatives.spec.ts
{"level":30,"time":1755692166632,"pid":20,"hostname":"b479b09165e0","requestId":"m-p1","ms":0,"msg":"route_success"}
{"level":30,"time":1755692166633,"pid":20,"hostname":"b479b09165e0","requestId":"200534f2-2982-49fa-9a18-2426ce2fe4a1","ms":0,"msg":"route_success"}
{"level":30,"time":1755692166846,"pid":20,"hostname":"b479b09165e0","requestId":"b3ad23d5-e27c-4acd-8c1d-faa1fe5aaa3c","ms":0,"msg":"route_success"}
PASS tests/unit/api.reports.grade-distribution.empty.spec.ts
PASS tests/unit/lib.serverFetch.baseurl.spec.ts
FAIL tests/unit/ui/SystemUptimeTile.spec.tsx
  ‚óè System Uptime Tile (labs) ‚Ä∫ renders ok and ts fields under jitter

    Unable to find an element by: [data-testid="uptime-ok"]

    Ignored nodes: comments, script, style
    [36m<body>[39m
      [36m<div>[39m
        [36m<main[39m
          [33mclass[39m=[32m"p-6"[39m
        [36m>[39m
          [36m<h1[39m
            [33mclass[39m=[32m"text-xl font-semibold"[39m
          [36m>[39m
            [0mSystem uptime[0m
          [36m</h1>[39m
          [36m<p[39m
            [33mclass[39m=[32m"text-gray-700"[39m
          [36m>[39m
            [0mUnable to load uptime.[0m
          [36m</p>[39m
        [36m</main>[39m
      [36m</div>[39m
    [36m</body>[39m

      16 |     const ui = await UptimeTilePage();
      17 |     render(ui);
    > 18 |     await screen.findByTestId('uptime-ok');
         |                  ^
      19 |     await screen.findByTestId('uptime-ts-iso');
      20 |     await screen.findByTestId('uptime-ts-human');
      21 |   });

      at waitForWrapper (../node_modules/@testing-library/dom/dist/wait-for.js:163:27)
      at ../node_modules/@testing-library/dom/dist/query-helpers.js:86:33
      at Object.<anonymous> (unit/ui/SystemUptimeTile.spec.tsx:18:18)

FAIL tests/unit/ui/StudentProfile.spec.tsx
  ‚óè Student Profile (labs) ‚Ä∫ renders email and role when authenticated

    Unable to find an element by: [data-testid="profile-email"]

    Ignored nodes: comments, script, style
    [36m<body>[39m
      [36m<div>[39m
        [36m<main[39m
          [33mclass[39m=[32m"p-6 space-y-3"[39m
        [36m>[39m
          [36m<h1[39m
            [33mclass[39m=[32m"text-xl font-semibold"[39m
            [33mdata-testid[39m=[32m"profile-title"[39m
          [36m>[39m
            [0mStudent Profile[0m
          [36m</h1>[39m
          [36m<p[39m
            [33mclass[39m=[32m"text-gray-700"[39m
            [33mdata-testid[39m=[32m"signin-prompt"[39m
          [36m>[39m
            [0mYou are not signed in[0m
          [36m</p>[39m
          [36m<a[39m
            [33mclass[39m=[32m"underline"[39m
            [33mdata-testid[39m=[32m"signin-link"[39m
            [33mhref[39m=[32m"/login"[39m
          [36m>[39m
            [0mGo to login[0m
          [36m</a>[39m
        [36m</main>[39m
      [36m</div>[39m
    [36m</body>[39m

      15 |     const ui = await StudentProfilePage();
      16 |     render(ui);
    > 17 |     expect(await screen.findByTestId('profile-email')).toHaveTextContent('s@example.com');
         |                         ^
      18 |     expect(await screen.findByTestId('profile-role')).toHaveTextContent('student');
      19 |   });
      20 | });

      at waitForWrapper (../node_modules/@testing-library/dom/dist/wait-for.js:163:27)
      at ../node_modules/@testing-library/dom/dist/query-helpers.js:86:33
      at Object.<anonymous> (unit/ui/StudentProfile.spec.tsx:17:25)

PASS tests/unit/modules.update.spec.ts
PASS tests/unit/services.assignments.producer.spec.ts
PASS tests/unit/api.reports.engagement.headers.spec.ts
PASS tests/unit/ui/StudentPlanner.spec.tsx
{"level":30,"time":1755692170367,"pid":20,"hostname":"b479b09165e0","requestId":"a0861eab-691d-4897-864a-f5cc361b7d6e","ms":1,"msg":"route_success"}
PASS tests/unit/server.scheduler.spec.ts
PASS tests/unit/api.runtime.outcomes.preflight.spec.ts
FAIL tests/unit/ui/AdminReports.spec.tsx
  ‚óè Admin Reports (dashboard) ‚Ä∫ renders reports tiles

    TypeError: cc.getAll is not a function

       6 | 	const hh = headers();
       7 | 	const cc = cookies();
    >  8 | 	const cookie = hh.get("cookie") ?? cc.getAll().map(x => `${x.name}=${x.value}`).join("; ");
         | 	                                      ^
       9 | 	const ta = hh.get("x-test-auth") ?? cc.get("x-test-auth")?.value;
      10 | 	const gw = createReportsGateway();
      11 | 	const [engagement, grades, dau, activity] = await Promise.all([

      at AdminReportsPage (../apps/web/src/app/dashboard/admin/reports/page.tsx:8:40)
      at Object.<anonymous> (unit/ui/AdminReports.spec.tsx:18:38)

FAIL tests/unit/ui/SystemRoleBadge.spec.tsx
  ‚óè System Role Badge (labs) ‚Ä∫ renders role and test mode

    ReferenceError: fetch is not defined

      72 |   }
      73 |   const started = Date.now();
    > 74 |   const res = await fetch(url, { cache: "no-store", ...init, headers: hdrs });
         |               ^
      75 |   try {
      76 |     const ms = Date.now() - started;
      77 |     // eslint-disable-next-line no-console

      at serverFetch (../apps/web/src/lib/serverFetch.ts:74:15)
      at fetchJson (../apps/web/src/lib/serverFetch.ts:88:21)
      at Object.get (../apps/web/src/lib/data/health.ts:14:23)
      at SystemRoleBadgePage (../apps/web/src/app/labs/system/role-badge/page.tsx:10:44)
      at Object.<anonymous> (unit/ui/SystemRoleBadge.spec.tsx:15:41)

FAIL tests/unit/ui/SystemAuthCheck.spec.tsx
  ‚óè System Auth Check (labs) ‚Ä∫ renders email and role when authenticated

    TypeError: cookieStore.getAll is not a function

      14 |
      15 |   const cookieHeader = incomingHeaders.get("cookie") ?? cookieStore
    > 16 |     .getAll()
         |      ^
      17 |     .map((c) => `${c.name}=${c.value}`)
      18 |     .join("; ");
      19 |   const testAuthHeader = incomingHeaders.get("x-test-auth") ?? "";

      at AuthCheckPage (../apps/web/src/app/labs/system/auth-check/page.tsx:16:6)
      at Object.<anonymous> (unit/ui/SystemAuthCheck.spec.tsx:15:35)

PASS tests/unit/api.pagination.params.spec.ts
{"level":30,"time":1755692172984,"pid":20,"hostname":"b479b09165e0","requestId":"601d7681-ee69-4028-b514-5e2f05b78c09","ms":1,"msg":"route_success"}
{"level":30,"time":1755692173327,"pid":20,"hostname":"b479b09165e0","requestId":"cecf52fb-0de3-4594-9998-e5674a59f1fc","ms":1,"msg":"route_success"}
{"level":30,"time":1755692173333,"pid":20,"hostname":"b479b09165e0","requestId":"942eea2b-9142-430e-aa8e-f473d79835a7","ms":5,"msg":"route_success"}
FAIL tests/unit/api.parent.progress.api.spec.ts
  ‚óè API /api/parent/progress (TEST_MODE) ‚Ä∫ parent linked to student gets data

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 403

      15 |     globalThis.__TEST_HEADERS_STORE__?.cookies?.set?.('x-test-auth', 'parent');
      16 |     const res = await (ParentProgressGET as any)(makeGet('http://localhost/api/parent/progress?student_id=22222222-2222-2222-2222-222222222222'));
    > 17 |     expect(res.status).toBe(200);
         |                        ^
      18 |   });
      19 | });
      20 |

      at Object.<anonymous> (unit/api.parent.progress.api.spec.ts:17:24)

PASS tests/unit/api.files.upload-url.content-type.spec.ts
{"level":30,"time":1755692173640,"pid":20,"hostname":"b479b09165e0","requestId":"c04e84c5-ae9b-49e1-bf50-2190be3951bd","ms":1,"msg":"route_success"}
FAIL tests/unit/ui/ParentChildrenReport.spec.tsx
  ‚óè Parent Children Report (labs) ‚Ä∫ renders total and items

    TypeError: c.getAll is not a function

       8 |   const h = headers();
       9 |   const c = cookies();
    > 10 |   const cookieHeader = h.get("cookie") ?? c.getAll().map(x => `${x.name}=${x.value}`).join("; ");
         |                                             ^
      11 |   const testAuth = h.get("x-test-auth") ?? c.get("x-test-auth")?.value;
      12 |
      13 |   let rows: ParentLink[] = [];

      at ParentChildrenReportPage (../apps/web/src/app/labs/parent/children-report/page.tsx:10:45)
      at Object.<anonymous> (unit/ui/ParentChildrenReport.spec.tsx:17:46)

PASS tests/unit/services.notifications.spec.ts
FAIL tests/unit/ui/SystemOkCard.spec.tsx
  ‚óè System OK Card (labs) ‚Ä∫ renders ok and ts (human) on success

    TypeError: cookieStore.getAll is not a function

      22 |
      23 |   const cookieHeader = cookieStore
    > 24 |     .getAll()
         |      ^
      25 |     .map((c) => `${c.name}=${c.value}`)
      26 |     .join("; ");
      27 |   const xTestAuth = incomingHeaders.get("x-test-auth") ?? cookieStore.get("x-test-auth")?.value;

      at SystemOkCardPage (../apps/web/src/app/labs/system/ok-card/page.tsx:24:6)
      at Object.<anonymous> (unit/ui/SystemOkCard.spec.tsx:16:38)

PASS tests/unit/api.reports.grade-distribution.headers.spec.ts
PASS tests/unit/lib.logger.redaction.extended.spec.ts
{"level":30,"time":1755692175041,"pid":20,"hostname":"b479b09165e0","requestId":"cffa0103-3769-4162-8dc1-50b7a0ab6164","ms":1,"msg":"route_success"}
PASS tests/unit/services.submissions.spec.ts
PASS tests/unit/api.runtime.asset.sign-url.preflight.spec.ts
PASS tests/unit/gateways/announcements.gateway.spec.ts
  ‚óè Console

    console.debug
      [serverFetch] 200 http://web:3022/api/announcements 0ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:78:13)

FAIL tests/unit/ui/SystemRequestId.spec.tsx
  ‚óè System Request ID (labs) ‚Ä∫ renders request-id from response headers when present

    expect(element).toHaveTextContent()

    Expected element to have text content:
      req-123
    Received:
      generated-1755692175865

      17 |     const ui = await RequestIdPage();
      18 |     render(ui);
    > 19 |     expect(await screen.findByTestId('request-id')).toHaveTextContent('req-123');
         |                                                     ^
      20 |   });
      21 | });
      22 |

      at Object.<anonymous> (unit/ui/SystemRequestId.spec.tsx:19:53)

PASS tests/unit/sdk.fetchJson.spec.ts
  ‚óè Console

    console.debug
      [serverFetch] 400 http://web:3022/x 0ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:78:13)

    console.debug
      [serverFetch] 200 http://web:3022/y 0ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:78:13)

PASS tests/unit/schemas.progress.spec.ts
FAIL tests/unit/api.runtime.outcomes.iss-aud.strict.spec.ts
  ‚óè runtime outcomes strict iss/aud enforcement ‚Ä∫ issuer/audience mismatch against provider domain yields 403 (path exercise)

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 403]

       9 |     const body = { courseId: 'c1', userId: 'u1', event: { type: 'progress', pct: 10 } };
      10 |     const res = await (OutcomesPOST as any)(post(body, { authorization: 'Bearer bad.token.value' }));
    > 11 |     expect([401,403]).toContain(res.status);
         |                       ^
      12 |   });
      13 | });
      14 |

      at Object.<anonymous> (unit/api.runtime.outcomes.iss-aud.strict.spec.ts:11:23)

{"level":30,"time":1755692176381,"pid":20,"hostname":"b479b09165e0","requestId":"a2b62880-050e-47d9-8565-34727cd7374a","ms":1,"msg":"route_success"}
{"level":30,"time":1755692176645,"pid":20,"hostname":"b479b09165e0","requestId":"n1","ms":1,"msg":"route_success"}
PASS tests/unit/api.notifications.guard.spec.ts
PASS tests/unit/ui/TeacherCourseCardsWithCounts.spec.tsx
PASS tests/unit/api.runtime.events.preflight.spec.ts
PASS tests/unit/api.routeTiming.spec.ts
PASS tests/unit/ui/TeacherPrintPages.spec.tsx
{"level":30,"time":1755692177251,"pid":20,"hostname":"b479b09165e0","requestId":"rq-1","ms":1,"msg":"route_success"}
{"level":50,"time":1755692177251,"pid":20,"hostname":"b479b09165e0","requestId":"rq-2","ms":0,"err":"boom","msg":"route_error"}
PASS tests/unit/api.runtime.grade.cors.preflight.spec.ts
PASS tests/unit/ui/NotificationsInboxPage.spec.tsx
PASS tests/unit/ui/DropdownMenu.spec.tsx
PASS tests/unit/api.submissions.get-required.spec.ts
{"level":30,"time":1755692178148,"pid":20,"hostname":"b479b09165e0","requestId":"18ccde12-1f1e-4aad-a9a3-a74d6504e7ac","ms":1,"msg":"route_success"}
{"level":30,"time":1755692178148,"pid":20,"hostname":"b479b09165e0","requestId":"66bb99d3-51db-4ee4-b942-ac64bf3c469e","ms":0,"msg":"route_success"}
{"level":30,"time":1755692178437,"pid":20,"hostname":"b479b09165e0","requestId":"408a94fa-cf6d-4b2b-b709-a4c1216ac35c","ms":1,"msg":"route_success"}
{"level":30,"time":1755692178437,"pid":20,"hostname":"b479b09165e0","requestId":"52202f5a-97e7-4913-aabf-e537546897b3","ms":0,"msg":"route_success"}
PASS tests/unit/api.internal.metrics.auth.spec.ts
FAIL tests/unit/ui/ParentChildren.spec.tsx
  ‚óè Parent Children (labs) ‚Ä∫ renders list with one linked student

    TypeError: c.getAll is not a function

       9 | 	const h = headers();
      10 | 	const c = cookies();
    > 11 | 	const cookieHeader = h.get("cookie") ?? c.getAll().map(x => `${x.name}=${x.value}`).join("; ");
         | 	                                          ^
      12 | 	const testAuth = h.get("x-test-auth") ?? c.get("x-test-auth")?.value;
      13 |
      14 | 	let links: ParentLink[] = [];

      at ParentChildrenListPage (../apps/web/src/app/labs/parent/children/page.tsx:11:44)
      at Object.<anonymous> (unit/ui/ParentChildren.spec.tsx:15:44)

PASS tests/unit/api.messages.list.pagination.params.spec.ts
{"level":30,"time":1755692179229,"pid":20,"hostname":"b479b09165e0","requestId":"4d15a51e-d836-4339-865c-8b314939c9a6","ms":1,"msg":"route_success"}
{"level":30,"time":1755692179465,"pid":20,"hostname":"b479b09165e0","requestId":"1808f4ca-3769-401a-9bbb-666e929f08f9","ms":0,"msg":"route_success"}
PASS tests/unit/api.runtime.context.dto-requestid.spec.ts
PASS tests/unit/api.internal.metrics.content-type.spec.ts
{"level":30,"time":1755692179661,"pid":20,"hostname":"b479b09165e0","requestId":"cc2bc3ba-d993-40f0-af55-e0655bed689f","ms":0,"msg":"route_success"}
{"level":30,"time":1755692179893,"pid":20,"hostname":"b479b09165e0","requestId":"9132674f-3fcd-44e3-9bdd-aecb5211dbd7","ms":0,"msg":"route_success"}
FAIL tests/unit/api.runtime.outcomes.alg-kid-iss-aud.spec.ts
  ‚óè runtime outcomes JWKS/JWT rotation and alg/aud/iss enforcement ‚Ä∫ rejects non-RS256 tokens

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 403]

       8 |   test('rejects non-RS256 tokens', async () => {
       9 |     const res = await (OutcomesPOST as any)(post({ courseId: 'c1', userId: 'u1', event: { type: 'progress', pct: 10 } }, { authorization: 'Bearer header.payload.sig' }));
    > 10 |     expect([401,403]).toContain(res.status);
         |                       ^
      11 |   });
      12 | });
      13 |

      at Object.<anonymous> (unit/api.runtime.outcomes.alg-kid-iss-aud.spec.ts:10:23)

PASS tests/unit/api.messages.threads.pagination.params.spec.ts
{"level":30,"time":1755692180134,"pid":20,"hostname":"b479b09165e0","requestId":"da5da087-b7a3-4b5f-803e-47d1ed51769b","ms":1,"msg":"route_success"}
PASS tests/unit/schemas.quiz.extend2.spec.ts
PASS tests/unit/ui/TeacherAnalyticsLab.spec.tsx
PASS tests/unit/api.dashboard.teacher-kpis.spec.ts
{"level":20,"time":1755692180673,"pid":20,"hostname":"b479b09165e0","ms":0,"msg":"dash_teacher_widgets"}
{"level":30,"time":1755692180673,"pid":20,"hostname":"b479b09165e0","requestId":"rq-99","ms":1,"msg":"route_success"}
{"level":30,"time":1755692180911,"pid":20,"hostname":"b479b09165e0","requestId":"48550f70-f673-448e-80dd-e9a748b37632","ms":1,"msg":"route_success"}
PASS tests/unit/api.providers.list.dto.spec.ts
PASS tests/unit/services.parentLinks.spec.ts
PASS tests/unit/schemas.strictness.spec.ts
PASS tests/unit/schemas.auth.spec.ts
PASS tests/unit/api.reports.export.headers.spec.ts
{"level":30,"time":1755692181745,"pid":20,"hostname":"b479b09165e0","requestId":"1b4c62d0-e7e4-4852-9bae-059748d8216f","ms":0,"msg":"route_success"}
{"level":30,"time":1755692181985,"pid":20,"hostname":"b479b09165e0","requestId":"pid-1","ms":0,"msg":"route_success"}
{"level":30,"time":1755692181986,"pid":20,"hostname":"b479b09165e0","requestId":"pid-1","ms":0,"msg":"route_success"}
PASS tests/unit/api.progress.request-id.spec.ts
PASS tests/unit/ui/DarkModeToggle.spec.tsx
PASS tests/unit/api.user.role.headers.spec.ts
{"level":30,"time":1755692182386,"pid":20,"hostname":"b479b09165e0","requestId":"90837d47-4950-4125-94ec-88bc995b61e8","ms":1,"msg":"route_success"}
{"level":30,"time":1755692182609,"pid":20,"hostname":"b479b09165e0","requestId":"3cf6d0ca-3aa4-4032-9843-7dba50d4ede4","ms":1,"msg":"route_success"}
{"level":30,"time":1755692182610,"pid":20,"hostname":"b479b09165e0","requestId":"61fad2e3-4b6c-49d7-900e-c739916f0324","ms":1,"msg":"route_success"}
PASS tests/unit/api.files.download-url.spec.ts
FAIL tests/unit/api.messages.read-all-thread.spec.ts
  ‚óè messages read-all by thread id ‚Ä∫ student marks thread as read in test-mode

    expect(received).toContain(expected) // indexOf

    Expected value: 500
    Received array: [200, 401]

      10 |     globalThis.__TEST_HEADERS_STORE__?.cookies?.set?.('x-test-auth', 'student');
      11 |     const res = await (ReadAllThreadPATCH as any)(patch('http://localhost/api/messages/threads/11111111-1111-1111-1111-111111111111/read-all'));
    > 12 |     expect([200,401]).toContain(res.status);
         |                       ^
      13 |   });
      14 | });
      15 |

      at Object.<anonymous> (unit/api.messages.read-all-thread.spec.ts:12:23)

{"level":50,"time":1755692182830,"pid":20,"hostname":"b479b09165e0","requestId":"555bc5da-7fc8-4930-bc8e-65a87fc4e878","issues":[{"path":"updated","message":"Required"}],"msg":"dto_response_validation_failed"}
{"level":30,"time":1755692182830,"pid":20,"hostname":"b479b09165e0","requestId":"07793344-1c31-4ccd-a949-7d50cc3ab331","ms":0,"msg":"route_success"}
PASS tests/unit/schemas.parentLink.spec.ts
FAIL tests/unit/lib.testMode.spec.ts
  ‚óè testMode ‚Ä∫ isTestMode false otherwise

    expect(received).toBe(expected) // Object.is equality

    Expected: false
    Received: true

      22 |     delete (process.env as any).TEST_MODE;
      23 |     delete (process.env as any).PLAYWRIGHT;
    > 24 |     expect(isTestMode()).toBe(false);
         |                          ^
      25 |   });
      26 | });
      27 |

      at Object.<anonymous> (unit/lib.testMode.spec.ts:24:26)

PASS tests/unit/api.assignments.patch-missing-id.spec.ts
{"level":30,"time":1755692183371,"pid":20,"hostname":"b479b09165e0","requestId":"a-p1","ms":1,"msg":"route_success"}
{"level":30,"time":1755692183611,"pid":20,"hostname":"b479b09165e0","requestId":"74e5f27e-0d6f-4191-bd5e-ebff33cc09fa","ms":1,"msg":"route_success"}
PASS tests/unit/api.user.profile.headers.spec.ts
PASS tests/unit/api.progress.teacher-counts.spec.ts
{"level":30,"time":1755692183852,"pid":20,"hostname":"b479b09165e0","requestId":"be1d9e8e-2090-4934-a51d-741d2a2b93c0","ms":0,"msg":"route_success"}
PASS tests/unit/schemas.event.spec.ts
FAIL tests/unit/api.messages.guard.spec.ts
  ‚óè api.messages guard (MVP_PROD_GUARD) ‚Ä∫ guard enforced in production-like (non test-mode)

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 501]

      11 |     const res = await (MessagesGET as any)(makeReq('http://localhost/api/messages?thread_id=th1', { 'x-test-auth': 'student' }));
      12 |     // In non test-mode, auth may fail or MVP guard may block; accept 401 or 501
    > 13 |     expect([401, 501]).toContain(res.status);
         |                        ^
      14 |   });
      15 | });
      16 |

      at Object.<anonymous> (unit/api.messages.guard.spec.ts:13:24)

{"level":30,"time":1755692184269,"pid":20,"hostname":"b479b09165e0","requestId":"caf23176-f547-493e-99a0-1b4efbb0d1b6","ms":1,"msg":"route_success"}
PASS tests/unit/ui/telemetry.spec.tsx
PASS tests/unit/api.messages.missing-thread.spec.ts
{"level":30,"time":1755692184646,"pid":20,"hostname":"b479b09165e0","requestId":"m1","ms":1,"msg":"route_success"}
{"level":30,"time":1755692184883,"pid":20,"hostname":"b479b09165e0","requestId":"d435d687-14e3-45c1-a6ec-78fa11c456b2","ms":0,"msg":"route_success"}
PASS tests/unit/api.registry.versions.dto.spec.ts
PASS tests/unit/api.assignments.list.spec.ts
{"level":30,"time":1755692185115,"pid":20,"hostname":"b479b09165e0","requestId":"125698a8-dfe7-4ca9-a99c-f8bb7683a3d9","ms":1,"msg":"route_success"}
{"level":30,"time":1755692185115,"pid":20,"hostname":"b479b09165e0","requestId":"f00d0571-8f4f-4bf2-b2ba-29375cc99471","ms":0,"msg":"route_success"}
{"level":30,"time":1755692185352,"pid":20,"hostname":"b479b09165e0","requestId":"ap-eb","ms":1,"msg":"route_success"}
PASS tests/unit/api.assignments.patch-empty-body.spec.ts
PASS tests/unit/schemas.env.numeric-bounds.spec.ts
PASS tests/unit/lib.paginate.edgecases.spec.ts
PASS tests/unit/lib.zodQuery.spec.ts
FAIL tests/unit/api.notifications.read-all.spec.ts
  ‚óè notifications read-all ‚Ä∫ marks all read in test-mode

    TypeError: schema.safeParse is not a function

      18 |   const { requestId } = opts;
      19 |   const status = typeof opts.status === 'number' ? opts.status : 200;
    > 20 |   const parsed = (schema as any).safeParse(data);
         |                                  ^
      21 |   if (!parsed.success) {
      22 |     try { getRequestLogger(requestId).error({ issues: redactIssues(parsed.error.issues) }, 'dto_response_validation_failed'); } catch {}
      23 |     return NextResponse.json({ error: { code: 'INTERNAL', message: 'Invalid response shape' }, requestId }, { status: 500, headers: { 'x-request-id': requestId } });

      at jsonDto (../apps/web/src/lib/jsonDto.ts:20:34)
      at PATCH (../apps/web/src/app/api/notifications/read-all/route.ts:14:19)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.notifications.read-all.spec.ts:13:17)

PASS tests/unit/ui/SettingsPage.spec.tsx
{"level":50,"time":1755692185863,"pid":20,"hostname":"b479b09165e0","requestId":"322192db-436a-40dd-a85a-0f753ff79b3c","ms":1,"err":"schema.safeParse is not a function","msg":"route_error"}
PASS tests/unit/schemas.enrollment.spec.ts
PASS tests/unit/lib.rateLimit.spec.ts
PASS tests/unit/services.courses.spec.ts
PASS tests/unit/lib.idempotency.ttl.spec.ts
PASS tests/unit/api.assignments.query-strict.spec.ts
{"level":30,"time":1755692186636,"pid":20,"hostname":"b479b09165e0","requestId":"38dfd4b7-e5d9-4a61-a3a3-b868eabebb4b","ms":1,"msg":"route_success"}
PASS tests/unit/schemas.env.spec.ts
PASS tests/unit/ui/TeacherCoursesGrid.spec.tsx
PASS tests/unit/api.request-id.on.success.spec.ts
PASS tests/unit/gateways/users.gateway.spec.ts
  ‚óè Console

    console.debug
      [serverFetch] 200 http://web:3022/api/user/role 0ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:78:13)

{"level":30,"time":1755692187106,"pid":20,"hostname":"b479b09165e0","requestId":"65e2e440-b154-4dee-ad55-8ec2f6cf7c15","ms":0,"msg":"route_success"}
PASS tests/unit/schemas.problem.spec.ts
PASS tests/unit/api.auth.logout.spec.ts
PASS tests/unit/ui/StudentEnrollmentsGrid.spec.tsx
{"level":30,"time":1755692187641,"pid":20,"hostname":"b479b09165e0","requestId":"b1ee9da6-247f-4613-b289-04c28872bd36","ms":0,"msg":"route_success"}
{"level":30,"time":1755692187641,"pid":20,"hostname":"b479b09165e0","requestId":"90d70b47-184d-4d30-9064-cba08fdccae5","ms":0,"msg":"route_success"}
PASS tests/unit/services.files.signing.spec.ts
PASS tests/unit/gateways/flags.gateway.spec.ts
  ‚óè Console

    console.debug
      [serverFetch] 200 http://web:3022/api/flags 1ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:78:13)

PASS tests/unit/schemas.notification.spec.ts
PASS tests/unit/schemas.course.spec.ts
FAIL tests/unit/lib.metrics.inflight.spec.ts
  ‚óè metrics in-flight tracking ‚Ä∫ increments and decrements per route

    expect(received).toBe(expected) // Object.is equality

    Expected: 2
    Received: 0

       9 |     incrInFlight(route);
      10 |     let s1 = snapshot();
    > 11 |     expect((s1[route]?.in_flight || 0)).toBe(before + 2);
         |                                         ^
      12 |     decrInFlight(route);
      13 |     decrInFlight(route);
      14 |     s1 = snapshot();

      at Object.<anonymous> (unit/lib.metrics.inflight.spec.ts:11:41)

PASS tests/unit/api.runtime.gating.spec.ts
{"level":30,"time":1755692188530,"pid":20,"hostname":"b479b09165e0","requestId":"995c8b5f-77d7-4d57-aacf-6f7e4c02262d","ms":0,"msg":"route_success"}
PASS tests/unit/schemas.quiz.extend.spec.ts
PASS tests/unit/api.dashboard.dto.spec.ts
{"level":20,"time":1755692188957,"pid":20,"hostname":"b479b09165e0","ms":0,"msg":"dash_teacher_widgets"}
PASS tests/unit/ui/SystemHealth.spec.tsx
PASS tests/unit/lib.metrics.cardinality.spec.ts
PASS tests/unit/db.rls.notifications.negative.spec.ts
{"level":30,"time":1755692189514,"pid":20,"hostname":"b479b09165e0","requestId":"12a255cc-8878-4743-b129-685650d9f008","ms":0,"msg":"route_success"}
{"level":30,"time":1755692189835,"pid":20,"hostname":"b479b09165e0","lessonId":"11111111-1111-1111-1111-111111111111","userId":"test-student-id","ms":0,"msg":"progress_marked"}
PASS tests/unit/services.progress.spec.ts
PASS tests/unit/api.parent.progress.ui.spec.tsx
PASS tests/unit/lib.csp.headers.spec.ts
PASS tests/unit/runtime.headers.vary.origin.spec.ts
PASS tests/unit/api.runtime.checkpoint.spec.ts
PASS tests/unit/api.runtime.jwks.rotation.positive.spec.ts
PASS tests/unit/db.rls.interactive_attempts.negative.spec.ts
{"level":30,"time":1755692191128,"pid":20,"hostname":"b479b09165e0","requestId":"8cab2a7f-6c9a-45b9-aa2c-1291f962f51e","ms":1,"msg":"route_success"}
PASS tests/unit/services.users.spec.ts
PASS tests/unit/db.rls.messages.readall.negative.spec.ts
{"level":30,"time":1755692191564,"pid":20,"hostname":"b479b09165e0","requestId":"7318e84c-af45-45e8-8745-03e202012787","ms":1,"msg":"route_success"}
PASS tests/unit/schemas.dashboard.parent.spec.ts
PASS tests/unit/future.analytics.spec.ts
PASS tests/unit/future.access-control.spec.ts
PASS tests/unit/schemas.assignment.extend.spec.ts
PASS tests/unit/api.runtime.asset-sign-url.spec.ts
PASS tests/unit/future.profile-avatar.spec.ts
PASS tests/unit/example.spec.ts
PASS tests/unit/api.events.spec.ts

Summary of all failing tests
FAIL unit/future.messaging.spec.ts
  ‚óè Epic E: Messaging (MVP) ‚Ä∫ lists only threads for the current user with unread counts

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      32 |     const rows = await res.json();
      33 |     expect(Array.isArray(rows)).toBe(true);
    > 34 |     expect(rows.every((r: any) => typeof r.unread === 'number')).toBe(true);
         |                                                                  ^
      35 |   });
      36 |
      37 |   test('sends a message into a thread and fans out notifications to participants', async () => {

      at Object.<anonymous> (unit/future.messaging.spec.ts:34:66)

  ‚óè Epic E: Messaging (MVP) ‚Ä∫ marks message as read for the current user and updates unread badge

    TypeError: Cannot read properties of undefined (reading 'unread')

      78 |     const listRes = await threads.GET(new Request('http://localhost/api/messages/threads', { headers: { 'x-test-auth': 'student' } }) as any);
      79 |     const list = await listRes.json();
    > 80 |     expect(list[0].unread).toBe(0);
         |                    ^
      81 |   });
      82 |   test('enforces permissions: unauthenticated yields 401', async () => {
      83 |     // clear test auth

      at Object.<anonymous> (unit/future.messaging.spec.ts:80:20)

  ‚óè Epic E: Messaging (MVP) ‚Ä∫ PATCH /api/messages/threads/[id]/read-all zeroes unread for current user

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

      107 |     globalThis.__TEST_HEADERS_STORE__.cookies.set('x-test-auth', 'student');
      108 |     const patch = await readAll.PATCH(new Request(`http://localhost/api/messages/threads/${thread.id}/read-all`, { method: 'PATCH', headers: { 'x-test-auth': 'student' } }) as any, { params: { id: thread.id } } as any);
    > 109 |     expect(patch.status).toBe(200);
          |                          ^
      110 |     const listRes = await threads.GET(new Request('http://localhost/api/messages/threads', { headers: { 'x-test-auth': 'student' } }) as any);
      111 |     const list = await listRes.json();
      112 |     expect(list[0].unread).toBe(0);

      at Object.<anonymous> (unit/future.messaging.spec.ts:109:26)

  ‚óè Epic E: Messaging (MVP) ‚Ä∫ messages list sorted by created_at and unread increments after new message

    TypeError: Cannot read properties of undefined (reading 'unread')

      138 |     const listThreads = await threads.GET(new Request('http://localhost/api/messages/threads', { headers: { 'x-test-auth': 'student' } }) as any);
      139 |     const ts = await listThreads.json();
    > 140 |     expect(ts[0].unread).toBeGreaterThan(0);
          |                  ^
      141 |   });
      142 |
      143 |   test('PATCH /api/messages without id returns 400 and unknown id returns 404', async () => {

      at Object.<anonymous> (unit/future.messaging.spec.ts:140:18)

FAIL unit/api.runtime.v2.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.runtime.v2.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.runtime.v2.spec.ts:3:1)

FAIL unit/api.flags.providers.users.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.flags.providers.users.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.flags.providers.users.spec.ts:6:1)

FAIL unit/future.notifications.spec.ts
  ‚óè Epic F: Notifications (MVP) ‚Ä∫ marks all notifications as read

    TypeError: schema.safeParse is not a function

      18 |   const { requestId } = opts;
      19 |   const status = typeof opts.status === 'number' ? opts.status : 200;
    > 20 |   const parsed = (schema as any).safeParse(data);
         |                                  ^
      21 |   if (!parsed.success) {
      22 |     try { getRequestLogger(requestId).error({ issues: redactIssues(parsed.error.issues) }, 'dto_response_validation_failed'); } catch {}
      23 |     return NextResponse.json({ error: { code: 'INTERNAL', message: 'Invalid response shape' }, requestId }, { status: 500, headers: { 'x-request-id': requestId } });

      at jsonDto (../apps/web/src/lib/jsonDto.ts:20:34)
      at PATCH (../apps/web/src/app/api/notifications/read-all/route.ts:14:19)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/future.notifications.spec.ts:43:17)

FAIL unit/api.registry.mutations.ratelimit.spec.ts
  ‚óè registry mutations rate-limit headers ‚Ä∫ courses POST returns 429 headers when limited

    TypeError: supabase.from(...).insert is not a function

      106 |   if (!parsed.success) return NextResponse.json({ error: { code: "BAD_REQUEST", message: parsed.error.message }, requestId }, { status: 400, headers: { "x-request-id": requestId } });
      107 |   const supabase = getRouteHandlerSupabase();
    > 108 |   const { data, error } = await supabase.from("external_courses").insert(parsed.data as any).select().single();
          |                                                                   ^
      109 |   if (error) return NextResponse.json({ error: { code: "DB_ERROR", message: error.message }, requestId }, { status: 500, headers: { "x-request-id": requestId } });
      110 |   try { await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'registry.external.create', entity_type: 'external_course', entity_id: (data as any).id, details: parsed.data }); } catch {}
      111 |   try { return jsonDto(externalCourse.parse(data as any), externalCourse as any, { requestId, status: 201 }); } catch { return NextResponse.json({ error: { code: 'INTERNAL', message: 'Invalid external course shape' }, requestId }, { status: 500, headers: { 'x-request-id': requestId } }); }

      at POST (../apps/web/src/app/api/registry/courses/route.ts:108:67)
      at Object.POST (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.registry.mutations.ratelimit.spec.ts:16:17)

  ‚óè registry mutations rate-limit headers ‚Ä∫ courses PATCH returns 429 headers when limited

    TypeError: supabase.from(...).update is not a function

      138 |   if (!parsed.success) return NextResponse.json({ error: { code: "BAD_REQUEST", message: parsed.error.message }, requestId }, { status: 400, headers: { "x-request-id": requestId } });
      139 |   const supabase = getRouteHandlerSupabase();
    > 140 |   const { data, error } = await supabase.from("external_courses").update(parsed.data.data as any).eq("id", parsed.data.id).select().single();
          |                                                                   ^
      141 |   if (error) return NextResponse.json({ error: { code: "DB_ERROR", message: error.message }, requestId }, { status: 500, headers: { "x-request-id": requestId } });
      142 |   try { await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'registry.external.update', entity_type: 'external_course', entity_id: parsed.data.id, details: parsed.data.data }); } catch {}
      143 |   try { return jsonDto(externalCourse.parse(data as any), externalCourse as any, { requestId, status: 200 }); } catch { return NextResponse.json({ error: { code: 'INTERNAL', message: 'Invalid external course shape' }, requestId }, { status: 500, headers: { 'x-request-id': requestId } }); }

      at PATCH (../apps/web/src/app/api/registry/courses/route.ts:140:67)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.registry.mutations.ratelimit.spec.ts:25:17)

  ‚óè registry mutations rate-limit headers ‚Ä∫ courses DELETE returns 429 headers when limited

    TypeError: supabase.from(...).delete is not a function

      167 |   try { q = parseQuery(req, idSchema); } catch (e: any) { return NextResponse.json({ error: { code: 'BAD_REQUEST', message: e.message }, requestId }, { status: 400, headers: { 'x-request-id': requestId } }); }
      168 |   const supabase = getRouteHandlerSupabase();
    > 169 |   const { data, error } = await supabase.from("external_courses").delete().eq("id", q.id).select().single();
          |                                                                         ^
      170 |   if (error) return NextResponse.json({ error: { code: "DB_ERROR", message: error.message }, requestId }, { status: 500, headers: { "x-request-id": requestId } });
      171 |   try { await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'registry.external.delete', entity_type: 'external_course', entity_id: q.id, details: {} }); } catch {}
      172 |   const { jsonDto } = await import('@/lib/jsonDto');

      at DELETE (../apps/web/src/app/api/registry/courses/route.ts:169:73)
      at Object.DELETE (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.registry.mutations.ratelimit.spec.ts:34:17)

  ‚óè registry mutations rate-limit headers ‚Ä∫ versions POST returns 429 headers when limited

    TypeError: supabase.from(...).insert is not a function

      77 |   if (!parsed.success) return NextResponse.json({ error: { code: "BAD_REQUEST", message: parsed.error.message }, requestId }, { status: 400, headers: { "x-request-id": requestId } });
      78 |   const supabase = getRouteHandlerSupabase();
    > 79 |   const { data, error } = await supabase.from("course_versions").insert(parsed.data as any).select().single();
         |                                                                  ^
      80 |   if (error) return NextResponse.json({ error: { code: "DB_ERROR", message: error.message }, requestId }, { status: 500, headers: { "x-request-id": requestId } });
      81 |   try { await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'registry.version.create', entity_type: 'course_version', entity_id: (data as any).id, details: parsed.data }); } catch {}
      82 |   try { return jsonDto(courseVersion.parse(data as any), courseVersion as any, { requestId, status: 201 }); } catch { return NextResponse.json({ error: { code: 'INTERNAL', message: 'Invalid course version shape' }, requestId }, { status: 500, headers: { 'x-request-id': requestId } }); }

      at POST (../apps/web/src/app/api/registry/versions/route.ts:79:66)
      at Object.POST (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.registry.mutations.ratelimit.spec.ts:43:17)

  ‚óè registry mutations rate-limit headers ‚Ä∫ versions PATCH returns 429 headers when limited

    TypeError: supabase.from(...).update is not a function

      108 |   if (!parsed.success) return NextResponse.json({ error: { code: "BAD_REQUEST", message: parsed.error.message }, requestId }, { status: 400, headers: { "x-request-id": requestId } });
      109 |   const supabase = getRouteHandlerSupabase();
    > 110 |   const { data, error } = await supabase.from("course_versions").update(parsed.data as any).eq("id", q.id).select().single();
          |                                                                  ^
      111 |   if (error) return NextResponse.json({ error: { code: "DB_ERROR", message: error.message }, requestId }, { status: 500, headers: { "x-request-id": requestId } });
      112 |   try { await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'registry.version.update', entity_type: 'course_version', entity_id: q.id, details: parsed.data }); } catch {}
      113 |   try { return jsonDto(courseVersion.parse(data as any), courseVersion as any, { requestId, status: 200 }); } catch { return NextResponse.json({ error: { code: 'INTERNAL', message: 'Invalid course version shape' }, requestId }, { status: 500, headers: { 'x-request-id': requestId } }); }

      at PATCH (../apps/web/src/app/api/registry/versions/route.ts:110:66)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.registry.mutations.ratelimit.spec.ts:52:17)

FAIL unit/api.runtime.auth.exchange.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.runtime.auth.exchange.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.runtime.auth.exchange.spec.ts:2:1)

FAIL unit/api.parent-links.spec.ts
  ‚óè API /api/parent-links ‚Ä∫ GET unauth ‚Üí 401; missing parent_id ‚Üí 400; non-admin self allowed; non-self forbidden

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 204]

      58 |     globalThis.__TEST_HEADERS_STORE__?.cookies?.set?.('x-test-auth', 'parent');
      59 |     res = await (PLGet as any)(makeGet('http://localhost/api/parent-links?parent_id=test-parent-id'));
    > 60 |     expect([200, 204]).toContain(res.status);
         |                        ^
      61 |     // parent non-self forbidden
      62 |     res = await (PLGet as any)(makeGet('http://localhost/api/parent-links?parent_id=other-parent-id'));
      63 |     expect(res.status).toBe(403);

      at Object.<anonymous> (unit/api.parent-links.spec.ts:60:24)

FAIL unit/ui/NotificationsDropdownClient.spec.tsx
  ‚óè Load more appends items

    expect(received).toBe(expected) // Object.is equality

    Expected: 2
    Received: 20

    Ignored nodes: comments, script, style
    [36m<html>[39m
      [36m<head />[39m
      [36m<body>[39m
        [36m<div>[39m
          [36m<div[39m
            [33mdata-testid[39m=[32m"notif-list"[39m
          [36m>[39m
            [36m<div[39m
              [33mclass[39m=[32m"flex items-center justify-between mb-2"[39m
            [36m>[39m
              [36m<span[39m
                [33mclass[39m=[32m"font-medium"[39m
              [36m>[39m
                [0mNotifications[0m
              [36m</span>[39m
              [36m<button[39m
                [33maria-label[39m=[32m"Mark all notifications as read"[39m
                [33mclass[39m=[32m"underline text-xs"[39m
                [33mdata-testid[39m=[32m"notif-mark-all"[39m
                [33mtitle[39m=[32m"Mark all read"[39m
              [36m>[39m
                [0mMark all[0m
              [36m</button>[39m
            [36m</div>[39m
            [36m<ul[39m
              [33mclass[39m=[32m"space-y-2"[39m
            [36m>[39m
              [36m<li[39m
                [33mclass[39m=[32m"flex items-center justify-between gap-2"[39m
                [33mdata-testid[39m=[32m"notif-item"[39m
              [36m>[39m
                [36m<div[39m
                  [33mclass[39m=[32m""[39m
                [36m>[39m
                  [36m<span>[39m
                    [0msubmission:graded[0m
                  [36m</span>[39m
                  [36m<span[39m
                    [33mclass[39m=[32m"ml-2"[39m
                  [36m>[39m
                    [0mScore: [0m
                    [0m80[0m
                  [36m</span>[39m
                [36m</div>[39m
                [36m<button[39m
                  [33maria-label[39m=[32m"Mark notification no-0000 as read"[39m
                  [33mclass[39m=[32m"underline text-xs"[39m
                  [33mdata-testid[39m=[32m"notif-read-btn"[39m
                [36m>[39m
                  [0mRead[0m
                [36m</button>[39m
              [36m</li>[39m
              [36m<li[39m
                [33mclass[39m=[32m"flex items-center justify-between gap-2"[39m
                [33mdata-testid[39m=[32m"notif-item"[39m
              [36m>[39m
                [36m<div[39m
                  [33mclass[39m=[32m"text-gray-500"[39m
                [36m>[39m
                  [36m<span>[39m
                    [0mmessage:new[0m
                  [36m</span>[39m
                  [36m<a[39m
                    [33mclass[39m=[32m"ml-2 underline"[39m
                    [33mhref[39m=[32m"/labs/system/inbox?thread=th-1"[39m
                  [36m>[39m
                    [0mOpen thread[0m
                  [36m</a>[39m
                [36m</div>[39m
              [36m</li>[39m
              [36m<li[39m
                [33mclass[39m=[32m"flex items-center justify-between gap-2"[39m
                [33mdata-testid[39m=[32m"notif-item"[39m
              [36m>[39m
                [36m<div[39m
                  [33mclass[39m=[32m"text-gray-500"[39m
                [36m>[39m
                  [36m<span>[39m
                    [0mannouncement:published[0m
                  [36m</span>[39m
                [36m</div>[39m
              [36m</li>[39m
              [36m<li[39m
                [33mclass[39m=[32m"flex items-center justify-between gap-2"[39m
                [33mdata-testid[39m=[32m"notif-item"[39m
              [36m>[39m
                [36m<div[39m
                  [33mclass[39m=[32m"text-gray-500"[39m
                [36m>[39m
                  [36m<span>[39m
                    [0msubmission:graded[0m
                  [36m</span>[39m
                  [36m<span[39m
                    [33mclass[39m=[32m"ml-2"[39m
                  [36m>[39m
                    [0mScore: [0m
                    [0m83[0m
                  [36m</span>[39m
                [36m</div>[39m
              [36m</li>[39m
              [36m<li[39m
                [33mclass[39m=[32m"flex items-center justify-between gap-2"[39m
                [33mdata-testid[39m=[32m"notif-item"[39m
              [36m>[39m
                [36m<div[39m
                  [33mclass[39m=[32m"text-gray-500"[39m
                [36m>[39m
                  [36m<span>[39m
                    [0mmessage:new[0m
                  [36m</span>[39m
                  [36m<a[39m
                    [33mclass[39m=[32m"ml-2 underline"[39m
                    [33mhref[39m=[32m"/labs/system/inbox?thread=th-4"[39m
                  [36m>[39m
                    [0mOpen thread[0m
                  [36m</a>[39m
                [36m</div>[39m
              [36m</li>[39m
              [36m<li[39m
                [33mclass[39m=[32m"flex items-center justify-between gap-2"[39m
                [33mdata-testid[39m=[32m"notif-item"[39m
              [36m>[39m
                [36m<div[39m
                  [33mclass[39m=[32m""[39m
                [36m>[39m
                  [36m<span>[39m
                    [0mannouncement:published[0m
                  [36m</span>[39m
                [36m</div>[39m
                [36m<button[39m
                  [33maria-label[39m=[32m"Mark notification no-0005 as read"[39m
                  [33mclass[39m=[32m"underline text-xs"[39m
                  [33mdata-testid[39m=[32m"notif-read-btn"[39m
                [36m>[39m
                  [0mRead[0m
                [36m</button>[39m
              [36m</li>[39m
              [36m<li[39m
                [33mclass[39m=[32m"flex items-center justify-between gap-2"[39m
                [33mdata-testid[39m=[32m"notif-item"[39m
              [36m>[39m
                [36m<div[39m
                  [33mclass[39m=[32m"text-gray-500"[39m
                [36m>[39m
                  [36m<span>[39m
                    [0msubmission:graded[0m
                  [36m</span>[39m
                  [36m<span[39m
                    [33mclass[39m=[32m"ml-2"[39m
                  [36m>[39m
                    [0mScore: [0m
                    [0m86[0m
                  [36m</span>[39m
                [36m</div>[39m
              [36m</li>[39m
              [36m<li[39m
                [33mclass[39m=[32m"flex items-center justify-between gap-2"[39m
                [33mdata-testid[39m=[32m"notif-item"[39m
              [36m>[39m
                [36m<div[39m
                  [33mclass[39m=[32m"text-gray-500"[39m
                [36m>[39m
                  [36m<span>[39m
                    [0mmessage:new[0m
                  [36m</span>[39m
                  [36m<a[39m
                    [33mclass[39m=[32m"ml-2 underline"[39m
                    [33mhref[39m=[32m"/labs/system/inbox?thread=th-7"[39m
                  [36m>[39m
                    [0mOpen thread[0m
                  [36m</a>[39m
                [36m</div>[39m
              [36m</li>[39m
              [36m<li[39m
                [33mclass[39m=[32m"flex items-center justify-between gap-2"[39m
                [33mdata-testid[39m=[32m"notif-item"[39m
              [36m>[39m
                [36m<div[39m
                  [33mclass[39m=[32m"text-gray-500"[39m
                [36m>[39m
                  [36m<span>[39m
                    [0mannouncement:published[0m
                  [36m</span>[39m
                [36m</div>[39m
              [36m</li>[39m
              [36m<li[39m
                [33mclass[39m=[32m"flex items-center justify-between gap-2"[39m
                [33mdata-testid[39m=[32m"notif-item"[39m
              [36m>[39m
                [36m<div[39m
                  [33mclass[39m=[32m"text-gray-500"[39m
                [36m>[39m
                  [36m<span>[39m
                    [0msubmission:graded[0m
                  [36m</span>[39m
                  [36m<span[39m
                    [33mclass[39m=[32m"ml-2"[39m
                  [36m>[39m
                    [0mScore: [0m
                    [0m89[0m
                  [36m</span>[39m
                [36m</div>[39m
              [36m</li>[39m
              [36m<li[39m
                [33mclass[39m=[32m"flex items-center justify-between gap-2"[39m
                [33mdata-testid[39m=[32m"notif-item"[39m
              [36m>[39m
                [36m<div[39m
                  [33mclass[39m=[32m""[39m
                [36m>[39m
                  [36m<span>[39m
                    [0mmessage:new[0m
                  [36m</span>[39m
                  [36m<a[39m
                    [33mclass[39m=[32m"ml-2 underline"[39m
                    [33mhref[39m=[32m"/labs/system/inbox?thread=th-10"[39m
                  [36m>[39m
                    [0mOpen thread[0m
                  [36m</a>[39m
                [36m</div>[39m
                [36m<button[39m
                  [33maria-label[39m=[32m"Mark notification no-0010 as read"[39m
                  [33mclass[39m=[32m"underline text-xs"[39m
                  [33mdata-testid[39m=[32m"notif-read-btn"[39m
                [36m>[39m
                  [0mRead[0m
                [36m</button>[39m
              [36m</li>[39m
              [36m<li[39m
                [33mclass[39m=[32m"flex items-center justify-between gap-2"[39m
                [33mdata-testid[39m=[32m"notif-item"[39m
              [36m>[39m
                [36m<div[39m
                  [33mclass[39m=[32m"text-gray-500"[39m
                [36m>[39m
                  [36m<span>[39m
                    [0mannouncement:published[0m
                  [36m</span>[39m
                [36m</div>[39m
              [36m</li>[39m
              [36m<li[39m
                [33mclass[39m=[32m"flex items-center justify-between gap-2"[39m
                [33mdata-testid[39m=[32m"notif-item"[39m
              [36m>[39m
                [36m<div[39m
                  [33mclass[39m=[32m"text-gray-500"[39m
                [36m>[39m
                  [36m<span>[39m
                    [0msubmission:graded[0m
                  [36m</span>[39m
                  [36m<span[39m
                    [33mclass[39m=[32m"ml-2"[39m
                  [36m>[39m
                    [0mScore: [0m
                    [0m92[0m
                  [36m</span>[39m
                [36m</div>[39m
              [36m</li>[39m
              [36m<li[39m
                [33mclass[39m=[32m"flex items-center justify-between gap-2"[39m
                [33mdata-testid[39m=[32m"notif-item"[39m
              [36m>[39m
                [36m<div[39m
                  [33mclass[39m=[32m"text-gray-500"[39m
                [36m>[39m
                  [36m<span>[39m
                    [0mmessage:new[0m
                  [36m</span>[39m
                  [36m<a[39m
                    [33mclass[39m=[32m"ml-2 underline"[39m
                    [33mhref[39m=[32m"/labs/system/inbox?thread=th-13"[39m
                  [36m>[39m
                    [0mOpen thread[0m
                  [36m</a>[39m
                [36m</div>[39m
              [36m</li>[39m
              [36m<li[39m
                [33mclass[39m=[32m"flex items-center justify-between gap-2"[39m
                [33mdata-testid[39m=[32m"notif-item"[39m
              [36m>[39m
                [36m<div[39m
                  [33mclass[39m=[32m"text-gray-500"[39m
                [36m>[39m
                  [36m<span>[39m
                    [0mannouncement:published[0m
                  [36m</span>[39m
                [36m</div>[39m
              [36m</li>[39m
              [36m<li[39m
                [33mclass[39m=[32m"flex items-center justify-between gap-2"[39m
                [33mdata-testid[39m=[32m"notif-item"[39m
              [36m>[39m
                [36m<div[39m
                  [33mclass[39m=[32m""[39m
                [36m>[39m
                  [36m<span>[39m
                    [0msubmission:graded[0m
                  [36m</span>[39m
                  [36m<span[39m
                    [33mclass[39m=[32m"ml-2"[39m
                  [36m>[39m
                    [0mScore: [0m
                    [0m95[0m
                  [36m</span>[39m
                [36m</div>[39m
                [36m<button[39m
                  [33maria-label[39m=[32m"Mark notification no-0015 as read"[39m
                  [33mclass[39m=[32m"underline text-xs"[39m
                  [33mdata-testid[39m=[32m"notif-read-btn"[39m
                [36m>[39m
                  [0mRead[0m
                [36m</button>[39m
              [36m</li>[39m
              [36m<li[39m
                [33mclass[39m=[32m"flex items-center justify-between gap-2"[39m
                [33mdata-testid[39m=[32m"notif-item"[39m
              [36m>[39m
                [36m<div[39m
                  [33mclass[39m=[32m"text-gray-500"[39m
                [36m>[39m
                  [36m<span>[39m
                    [0mmessage:new[0m
                  [36m</span>[39m
                  [36m<a[39m
                    [33mclass[39m=[32m"ml-2 underline"[39m
                    [33mhref[39m=[32m"/labs/system/inbox?thread=th-16"[39m
                  [36m>[39m
                    [0mOpen thread[0m
                  [36m</a>[39m
                [36m</div>[39m
              [36m</li>[39m
              [36m<li[39m
                [33mclass[39m=[32m"flex items-center justify-between gap-2"[39m
                [33mdata-testid[39m=[32m"notif-item"[39m
              [36m>[39m
                [36m<div[39m
                  [33mclass[39m=[32m"text-gray-500"[39m
                [36m>[39m
                  [36m<span>[39m
                    [0mannouncement:published[0m
                  [36m</span>[39m
                [36m</div>[39m
              [36m</li>[39m
              [36m<li[39m
                [33mclass[39m=[32m"flex items-center justify-between gap-2"[39m
                [33mdata-testid[39m=[32m"notif-item"[39m
              [36m>[39m
                [36m<div[39m
                  [33mclass[39m=[32m"text-gray-500"[39m
                [36m>[39m
                  [36m<span>[39m
                    [0msubmission:graded[0m
                  [36m</span>[39m
                  [36m<span[39m
                    [33mclass[39m=[32m"ml-2"[39m
                  [36m>[39m
                    [0mScore: [0m
                    [0m98[0m
                  [36m</span>[39m
                [36m</div>[39m
              [36m</li>[39m
              [36m<li[39m
                [33mclass[39m=[32m"flex items-center justify-between gap-2"[39m
                [33mdata-testid[39m=[32m"notif-item"[39m
              [36m>[39m
                [36m<div[39m
                  [33mclass[39m=[32m"text-gray-500"[39m
                [36m>[39m
                  [36m<span>[39m
                    [0mmessage:new[0m
                  [36m</span>[39m
                  [36m<a[39m
                    [33mclass[39m=[32m"ml-2 underline"[39m
                    [33mhref[39m=[32m"/labs/system/inbox?thread=th-19"[39m
                  [36m>[39m
                    [0mOpen thread[0m
                  [36m</a>[39m
                [36m</div>[39m
              [36m</li>[39m
            [36m</ul>[39m
            [36m<div[39m
              [33mclass[39m=[32m"mt-2 flex justify-end"[39m
            [36m>[39m
              [36m<button[39m
                [33mclass[39m=[32m"underline text-xs"[39m
                [33mdata-testid[39m=[32m"notif-load-more"[39m
              [36m>[39m
                [0mLoad more[0m
              [36m</button>[39m
            [36m</div>[39m
          [36m</div>[39m
        [36m</div>[39m
      [36m</body>[39m
    [36m</html>[39m

      55 |   render(<NotificationsDropdownClient initial={[]} />);
      56 |   await user.click(screen.getByTestId('notif-load-more'));
    > 57 |   await waitFor(() => expect(screen.getAllByTestId('notif-item').length).toBe(2));
         |                                                                          ^
      58 |   restore();
      59 | });
      60 |

      at unit/ui/NotificationsDropdownClient.spec.tsx:57:74
      at runWithExpensiveErrorDiagnosticsDisabled (../node_modules/@testing-library/dom/dist/config.js:47:12)
      at checkCallback (../node_modules/@testing-library/dom/dist/wait-for.js:124:77)
      at checkRealTimersCallback (../node_modules/@testing-library/dom/dist/wait-for.js:118:16)
      at Timeout.task [as _onTimeout] (../node_modules/jsdom/lib/jsdom/browser/Window.js:579:19)

FAIL unit/api.runtime.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.runtime.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.runtime.spec.ts:5:1)

FAIL unit/api.runtime.outcomes.jwks.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.runtime.outcomes.jwks.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.runtime.outcomes.jwks.spec.ts:2:1)

FAIL unit/future.files.spec.ts
  ‚óè Epic H: Files and Media ‚Ä∫ issues an upload URL for a given owner and content type

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

       6 |     globalThis.__TEST_HEADERS_STORE__.cookies.set('x-test-auth', 'teacher');
       7 |     const res = await mod.POST(new Request('http://localhost/api/files/upload-url', { method: 'POST', headers: { 'content-type': 'application/json', 'x-test-auth': 'teacher' }, body: JSON.stringify({ owner_type: 'assignment', owner_id: 'a1', content_type: 'text/plain' }) }) as any);
    >  8 |     expect(res.status).toBe(200);
         |                        ^
       9 |     const json = await res.json();
      10 |     expect(json.url).toContain('/api/files/upload-url');
      11 |   });

      at Object.<anonymous> (unit/future.files.spec.ts:8:24)

  ‚óè Epic H: Files and Media ‚Ä∫ accepts PUT upload and returns a public download URL, then serves bytes

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

      17 |     globalThis.__TEST_HEADERS_STORE__.cookies.set('x-test-auth', 'teacher');
      18 |     const res = await mod.PUT(new Request('http://localhost/api/files/upload-url?owner_type=assignment&owner_id=a1&content_type=text/plain', { method: 'PUT', headers: { 'x-test-auth': 'teacher' }, body: new TextEncoder().encode('hello') }) as any);
    > 19 |     expect(res.status).toBe(200);
         |                        ^
      20 |     const { id, url } = await res.json();
      21 |     expect(id).toBeTruthy();
      22 |     const dl = await import('../../apps/web/src/app/api/files/download-url/route');

      at Object.<anonymous> (unit/future.files.spec.ts:19:24)

FAIL unit/api.runtime.checkpoint.scopes.spec.ts
  ‚óè runtime checkpoint scopes ‚Ä∫ save requires progress.write; load requires progress.read

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 201, 204]

      35 |     token = makeJwt(['progress.write']);
      36 |     res = await (SavePOST as any)(post('http://localhost/api/runtime/checkpoint/save', { key: 'k', state: { a: 1 } }, { authorization: `Bearer ${token}` }));
    > 37 |     expect([200,201,204]).toContain(res.status);
         |                           ^
      38 |     // Load without scope -> 403
      39 |     token = makeJwt([]);
      40 |     res = await (LoadGET as any)(get('http://localhost/api/runtime/checkpoint/load?key=k', { authorization: `Bearer ${token}` }));

      at Object.<anonymous> (unit/api.runtime.checkpoint.scopes.spec.ts:37:27)

FAIL unit/api.messages.threads-and-messages.spec.ts
  ‚óè messages threads and messages (TEST_MODE) ‚Ä∫ thread create has unique participants; unread counts adjust with read

    expect(received).toContain(expected) // indexOf

    Expected value: undefined
    Received array: [0, 1]

      30 |     const teacherThreads = await listTeacherThreads.json();
      31 |     const tRow = teacherThreads.find((x: any) => x.id === thread.id);
    > 32 |     expect([0,1]).toContain(tRow.unread);
         |                   ^
      33 |
      34 |     // mark student's message read as teacher
      35 |     const msgsList = await (MessagesGET as any)(getUrl(`http://localhost/api/messages?thread_id=${thread.id}`, { 'x-test-auth': 'teacher' }));

      at Object.<anonymous> (unit/api.messages.threads-and-messages.spec.ts:32:19)

FAIL unit/api.runtime.events.scopes.spec.ts
  ‚óè runtime events scopes ‚Ä∫ course.progress requires progress.write; course.attempt.completed requires attempts.write

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 201, 204]

      31 |     token = makeJwt(['progress.write']);
      32 |     res = await (EventsPOST as any)(post('http://localhost/api/runtime/events', { type: 'course.progress', pct: 10 }, { authorization: `Bearer ${token}` }));
    > 33 |     expect([200,201,204]).toContain(res.status);
         |                           ^
      34 |     // Missing attempts.write for attempt.completed -> 403
      35 |     token = makeJwt([]);
      36 |     res = await (EventsPOST as any)(post('http://localhost/api/runtime/events', { type: 'course.attempt.completed', score: 1, max: 1, passed: true }, { authorization: `Bearer ${token}` }));

      at Object.<anonymous> (unit/api.runtime.events.scopes.spec.ts:33:27)

FAIL unit/api.files.download-url.permissions.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.files.download-url.permissions.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.files.download-url.permissions.spec.ts:2:1)

FAIL unit/api.assignments.crud.spec.ts
  ‚óè Assignments CRUD API ‚Ä∫ DELETE role checks

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

      43 |     expect(res.status).toBe(403);
      44 |     res = await (AssignDELETE as any)(makeDelete('http://localhost/api/assignments?id=aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa', { 'x-test-auth': 'teacher' }));
    > 45 |     expect(res.status).toBe(200);
         |                        ^
      46 |   });
      47 | });
      48 |

      at Object.<anonymous> (unit/api.assignments.crud.spec.ts:45:24)

FAIL unit/api.role.guard.matrix.extended.spec.ts
  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'admin/audit-logs',
  url: 'http://localhost/api/admin/audit-logs',
  handler: [AsyncFunction (anonymous)],
  role: 'student'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'admin/audit-logs',
  url: 'http://localhost/api/admin/audit-logs',
  handler: [AsyncFunction (anonymous)],
  role: 'teacher'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'admin/audit-logs',
  url: 'http://localhost/api/admin/audit-logs',
  handler: [AsyncFunction (anonymous)],
  role: 'parent'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'admin/audit-logs',
  url: 'http://localhost/api/admin/audit-logs',
  handler: [AsyncFunction (anonymous)],
  role: 'admin'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'admin/export',
  url: 'http://localhost/api/admin/export',
  handler: [AsyncFunction (anonymous)],
  role: 'student'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'admin/export',
  url: 'http://localhost/api/admin/export',
  handler: [AsyncFunction (anonymous)],
  role: 'teacher'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'admin/export',
  url: 'http://localhost/api/admin/export',
  handler: [AsyncFunction (anonymous)],
  role: 'parent'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'admin/export',
  url: 'http://localhost/api/admin/export',
  handler: [AsyncFunction (anonymous)],
  role: 'admin'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'admin/metrics',
  url: 'http://localhost/api/admin/metrics',
  handler: [AsyncFunction (anonymous)],
  role: 'student'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'admin/metrics',
  url: 'http://localhost/api/admin/metrics',
  handler: [AsyncFunction (anonymous)],
  role: 'teacher'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'admin/metrics',
  url: 'http://localhost/api/admin/metrics',
  handler: [AsyncFunction (anonymous)],
  role: 'parent'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'admin/metrics',
  url: 'http://localhost/api/admin/metrics',
  handler: [AsyncFunction (anonymous)],
  role: 'admin'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'admin/quotas',
  url: 'http://localhost/api/admin/quotas',
  handler: [AsyncFunction (anonymous)],
  role: 'student'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'admin/quotas',
  url: 'http://localhost/api/admin/quotas',
  handler: [AsyncFunction (anonymous)],
  role: 'teacher'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'admin/quotas',
  url: 'http://localhost/api/admin/quotas',
  handler: [AsyncFunction (anonymous)],
  role: 'parent'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'admin/quotas',
  url: 'http://localhost/api/admin/quotas',
  handler: [AsyncFunction (anonymous)],
  role: 'admin'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'users',
  url: 'http://localhost/api/users',
  handler: [AsyncFunction (anonymous)],
  role: 'student'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'users',
  url: 'http://localhost/api/users',
  handler: [AsyncFunction (anonymous)],
  role: 'teacher'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'users',
  url: 'http://localhost/api/users',
  handler: [AsyncFunction (anonymous)],
  role: 'parent'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'users',
  url: 'http://localhost/api/users',
  handler: [AsyncFunction (anonymous)],
  role: 'admin'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'providers/health',
  url: 'http://localhost/api/providers/health',
  handler: [AsyncFunction (anonymous)],
  role: 'student'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'providers/health',
  url: 'http://localhost/api/providers/health',
  handler: [AsyncFunction (anonymous)],
  role: 'teacher'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'providers/health',
  url: 'http://localhost/api/providers/health',
  handler: [AsyncFunction (anonymous)],
  role: 'parent'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'providers/health',
  url: 'http://localhost/api/providers/health',
  handler: [AsyncFunction (anonymous)],
  role: 'admin'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'registry/courses',
  url: 'http://localhost/api/registry/courses',
  handler: [AsyncFunction (anonymous)],
  role: 'student'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'registry/courses',
  url: 'http://localhost/api/registry/courses',
  handler: [AsyncFunction (anonymous)],
  role: 'teacher'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'registry/courses',
  url: 'http://localhost/api/registry/courses',
  handler: [AsyncFunction (anonymous)],
  role: 'parent'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ‚óè admin/registry/users role guard matrix ‚Ä∫ {
  name: 'registry/courses',
  url: 'http://localhost/api/registry/courses',
  handler: [AsyncFunction (anonymous)],
  role: 'admin'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

FAIL unit/api.providers.ratelimit.spec.ts
  ‚óè providers create/update/delete rate-limit headers ‚Ä∫ POST returns 429 with standard headers when limited

    TypeError: supabase.from(...).insert is not a function

      69 |   }
      70 |   const supabase = getRouteHandlerSupabase();
    > 71 |   const { data, error } = await supabase.from('course_providers').insert({ name, jwks_url, domain }).select().single();
         |                                                                   ^
      72 |   if (error) return NextResponse.json({ error: { code: 'DB_ERROR', message: error.message }, requestId }, { status: 500, headers: { 'x-request-id': requestId } });
      73 |   try {
      74 |     await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'provider.create', entity_type: 'provider', entity_id: (data as any).id, details: { name, domain } });

      at POST (../apps/web/src/app/api/providers/route.ts:71:67)
      at Object.POST (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.providers.ratelimit.spec.ts:17:17)

  ‚óè providers create/update/delete rate-limit headers ‚Ä∫ PATCH returns 429 with standard headers when limited

    TypeError: supabase.from(...).update is not a function

      138 |   if (Object.keys(patch).length === 0) return NextResponse.json({ error: { code: 'BAD_REQUEST', message: 'no fields to update' }, requestId }, { status: 400, headers: { 'x-request-id': requestId } });
      139 |   const supabase = getRouteHandlerSupabase();
    > 140 |   const { data, error } = await supabase.from('course_providers').update(patch).eq('id', q.id).select().single();
          |                                                                   ^
      141 |   if (error) return NextResponse.json({ error: { code: 'DB_ERROR', message: error.message }, requestId }, { status: 500, headers: { 'x-request-id': requestId } });
      142 |   try {
      143 |     await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'provider.update', entity_type: 'provider', entity_id: q.id, details: patch });

      at PATCH (../apps/web/src/app/api/providers/route.ts:140:67)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.providers.ratelimit.spec.ts:27:17)

  ‚óè providers create/update/delete rate-limit headers ‚Ä∫ DELETE returns 429 with standard headers when limited

    TypeError: supabase.from(...).delete is not a function

      174 |   try { q = parseQuery(req, idSchema); } catch (e: any) { return NextResponse.json({ error: { code: 'BAD_REQUEST', message: e.message }, requestId }, { status: 400, headers: { 'x-request-id': requestId } }); }
      175 |   const supabase = getRouteHandlerSupabase();
    > 176 |   const { error } = await supabase.from('course_providers').delete().eq('id', q.id);
          |                                                                   ^
      177 |   if (error) return NextResponse.json({ error: { code: 'DB_ERROR', message: error.message }, requestId }, { status: 500, headers: { 'x-request-id': requestId } });
      178 |   try {
      179 |     await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'provider.delete', entity_type: 'provider', entity_id: q.id, details: {} });

      at DELETE (../apps/web/src/app/api/providers/route.ts:176:67)
      at Object.DELETE (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.providers.ratelimit.spec.ts:36:17)

FAIL unit/api.runtime.asset.sign-url.scope.spec.ts
  ‚óè runtime asset sign-url scope ‚Ä∫ valid scope and content-type ‚Üí 200 with url/key

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200]

      32 |     const token = makeJwt(['files.write']);
      33 |     const res = await (AssetSignPOST as any)(post('http://localhost/api/runtime/asset/sign-url', { content_type: 'image/png' }, { authorization: `Bearer ${token}` }));
    > 34 |     expect([200]).toContain(res.status);
         |                   ^
      35 |     const json = await res.json();
      36 |     expect(json.url).toBeTruthy();
      37 |     expect(json.key).toMatch(/runtime\//);

      at Object.<anonymous> (unit/api.runtime.asset.sign-url.scope.spec.ts:34:19)

  ‚óè runtime asset sign-url scope ‚Ä∫ unsupported content type ‚Üí 400

    expect(received).toBe(expected) // Object.is equality

    Expected: 400
    Received: 403

      41 |     const token = makeJwt(['files.write']);
      42 |     const res = await (AssetSignPOST as any)(post('http://localhost/api/runtime/asset/sign-url', { content_type: 'application/x-foo' }, { authorization: `Bearer ${token}` }));
    > 43 |     expect(res.status).toBe(400);
         |                        ^
      44 |   });
      45 | });
      46 |

      at Object.<anonymous> (unit/api.runtime.asset.sign-url.scope.spec.ts:43:24)

FAIL unit/api.admin.export.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.admin.export.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.admin.export.spec.ts:3:1)

FAIL unit/api.runtime.outcomes.runtime-token.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.runtime.outcomes.runtime-token.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.runtime.outcomes.runtime-token.spec.ts:2:1)

FAIL unit/middleware.cors.disallowed-origin.spec.ts
  ‚óè middleware CSP connect-src allowlist propagation ‚Ä∫ includes origins from RUNTIME_CORS_ALLOW in CSP via guard path

    expect(received).toMatch(expected)

    Expected pattern: /connect-src [^;]*https:\/\/api\.provider1/
    Received string:  ""

      33 |     const res: any = await (middleware as any)(makeReq('http://localhost/api/health'));
      34 |     const csp = res.headers.get('Content-Security-Policy') || '';
    > 35 |     expect(csp).toMatch(/connect-src [^;]*https:\/\/api\.provider1/);
         |                 ^
      36 |     expect(csp).toMatch(/connect-src [^;]*https:\/\/api\.provider2/);
      37 |   });
      38 | });

      at Object.<anonymous> (unit/middleware.cors.disallowed-origin.spec.ts:35:17)

FAIL unit/api.files.attachments.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.files.attachments.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.files.attachments.spec.ts:3:1)

FAIL unit/api.files.finalize.permissions.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.files.finalize.permissions.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.files.finalize.permissions.spec.ts:2:1)

FAIL unit/api.runtime.grade.ratelimit.spec.ts
  ‚óè runtime grade rate-limit headers ‚Ä∫ returns 201 first, then 429 with standard headers

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 201]

      25 |     const h = { authorization: `Bearer ${token}` };
      26 |     let res = await (GradePOST as any)(post({ runtimeAttemptId: 'ra1', score: 1, max: 1, passed: true }, h));
    > 27 |     expect([200,201]).toContain(res.status);
         |                       ^
      28 |     res = await (GradePOST as any)(post({ runtimeAttemptId: 'ra2', score: 1, max: 1, passed: true }, h));
      29 |     expect(res.status).toBe(429);
      30 |     expect(res.headers.get('retry-after')).toBeTruthy();

      at Object.<anonymous> (unit/api.runtime.grade.ratelimit.spec.ts:27:23)

FAIL unit/api.runtime.grade.idempotency.spec.ts
  ‚óè runtime grade idempotency ‚Ä∫ duplicate grade request with same Idempotency-Key returns replayed 200

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 201, 204]

      27 |     const h = { authorization: `Bearer ${token}`, 'Idempotency-Key': 'grade-dup-1' } as Record<string,string>;
      28 |     let res = await (GradePOST as any)(post('http://localhost/api/runtime/grade', { score: 1, max: 1, passed: true }, h));
    > 29 |     expect([200,201,204]).toContain(res.status);
         |                           ^
      30 |     res = await (GradePOST as any)(post('http://localhost/api/runtime/grade', { score: 1, max: 1, passed: true }, h));
      31 |     expect([200]).toContain(res.status);
      32 |     expect(res.headers.get('idempotency-replayed')).toBe('1');

      at Object.<anonymous> (unit/api.runtime.grade.idempotency.spec.ts:29:27)

FAIL unit/api.admin.audit-logs.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.admin.audit-logs.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.admin.audit-logs.spec.ts:3:1)

FAIL unit/api.providers.dto-and-ratelimit.spec.ts
  ‚óè providers endpoints DTO + ratelimit headers ‚Ä∫ rate limit headers present when throttled on provider PATCH

    TypeError: supabase.from(...).update is not a function

      138 |   if (Object.keys(patch).length === 0) return NextResponse.json({ error: { code: 'BAD_REQUEST', message: 'no fields to update' }, requestId }, { status: 400, headers: { 'x-request-id': requestId } });
      139 |   const supabase = getRouteHandlerSupabase();
    > 140 |   const { data, error } = await supabase.from('course_providers').update(patch).eq('id', q.id).select().single();
          |                                                                   ^
      141 |   if (error) return NextResponse.json({ error: { code: 'DB_ERROR', message: error.message }, requestId }, { status: 500, headers: { 'x-request-id': requestId } });
      142 |   try {
      143 |     await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'provider.update', entity_type: 'provider', entity_id: q.id, details: patch });

      at PATCH (../apps/web/src/app/api/providers/route.ts:140:67)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.providers.dto-and-ratelimit.spec.ts:23:16)

FAIL unit/api.runtime.events.ratelimit.spec.ts
  ‚óè runtime events rate-limit headers ‚Ä∫ returns 429 with standard headers on rate limit

    expect(received).toBe(expected) // Object.is equality

    Expected: 429
    Received: 403

      30 |     const token = makeJwt(['progress.write']);
      31 |     const res = await (EventsPOST as any)(post({ type: 'course.progress', pct: 10 }, { authorization: `Bearer ${token}` }));
    > 32 |     expect(res.status).toBe(429);
         |                        ^
      33 |     expect(res.headers.get('retry-after')).toBeTruthy();
      34 |     expect(res.headers.get('x-rate-limit-reset')).toBeTruthy();
      35 |     expect(res.headers.get('x-rate-limit-remaining')).toBe('0');

      at Object.<anonymous> (unit/api.runtime.events.ratelimit.spec.ts:32:24)

FAIL unit/api.files.roundtrip.spec.ts
  ‚óè files round-trip ‚Ä∫ upload-url ‚Üí PUT bytes ‚Üí download-url

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 400

      24 |     const blob = new Blob([new TextEncoder().encode('hello')], { type: 'text/plain' });
      25 |     const put = await (UploadPUT as any)(makePut(`http://localhost${url}`, blob, { 'x-test-auth': 'student' }));
    > 26 |     expect(put.status).toBe(200);
         |                        ^
      27 |     const { id, url: publicUrl } = await put.json();
      28 |     expect(id).toBeTruthy();
      29 |     const dl = await (DownloadGET as any)(makeGet(`http://localhost/api/files/download-url?id=${encodeURIComponent(id)}`, { 'x-test-auth': 'student' }));

      at Object.<anonymous> (unit/api.files.roundtrip.spec.ts:26:24)

FAIL unit/api.runtime.idempotency.spec.ts
  ‚óè runtime progress idempotency ‚Ä∫ duplicate request with same Idempotency-Key is replayed 200 with header

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 201, 204]

      25 |     const h = { authorization: `Bearer ${token}`, 'Idempotency-Key': 'dup-1' } as Record<string,string>;
      26 |     let res = await (ProgressPOST as any)(post('http://localhost/api/runtime/progress', h));
    > 27 |     expect([200,201,204]).toContain(res.status);
         |                           ^
      28 |     res = await (ProgressPOST as any)(post('http://localhost/api/runtime/progress', h));
      29 |     expect([200]).toContain(res.status);
      30 |     expect(res.headers.get('idempotency-replayed')).toBe('1');

      at Object.<anonymous> (unit/api.runtime.idempotency.spec.ts:27:27)

FAIL unit/api.runtime.cors.headers.spec.ts
  ‚óè runtime CORS headers for allowed origin ‚Ä∫ includes access-control-allow-origin when origin is allowed

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 201, 204, 400]

      25 |     const res = await (ProgressPOST as any)(post({ authorization: `Bearer ${token}` }));
      26 |     // success or preflight OK
    > 27 |     expect([200,201,204,400]).toContain(res.status);
         |                               ^
      28 |     // @ts-ignore NextResponse-like headers
      29 |     const h = res.headers as Headers;
      30 |     expect(h.get('access-control-allow-origin')).toBe('https://provider.example');

      at Object.<anonymous> (unit/api.runtime.cors.headers.spec.ts:27:31)

FAIL unit/db.rls.negative.spec.ts
  ‚óè DB RLS negative cases (policy guards) ‚Ä∫ student cannot read other students notifications

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/db.rls.negative.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/db.rls.negative.spec.ts:5:18
      at Object.<anonymous> (unit/db.rls.negative.spec.ts:5:18)

  ‚óè DB RLS negative cases (policy guards) ‚Ä∫ non-owner cannot finalize someone else file (RLS and route guard)

    TypeError: supabase.from(...).select(...).eq is not a function

      14 |   try { body = finalizeSchema.parse(await req.json()); } catch (e: any) { return NextResponse.json({ error: { code: 'BAD_REQUEST', message: String(e?.message || e) }, requestId }, { status: 400, headers: { 'x-request-id': requestId } }); }
      15 |   const supabase = getRouteHandlerSupabase();
    > 16 |   const { data: att } = await supabase.from('attachments').select('id,owner_type,owner_id,size_bytes').eq('object_key', body.key).single();
         |                                                                                                        ^
      17 |   if (!att) return NextResponse.json({ error: { code: 'NOT_FOUND', message: 'not found' }, requestId }, { status: 404, headers: { 'x-request-id': requestId } });
      18 |   // Permission: owner or teacher/admin for domain types (reuse delete semantics where possible)
      19 |   const ownerType = (att as any).owner_type as string;

      at POST (../apps/web/src/app/api/files/finalize/route.ts:16:104)
      at Object.POST (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/db.rls.negative.spec.ts:24:17)

  ‚óè DB RLS negative cases (policy guards) ‚Ä∫ student cannot list submissions for other assignment without auth as teacher

    expect(received).toContain(expected) // indexOf

    Expected value: 200
    Received array: [401, 403]

      29 |     const route = await import('../../apps/web/src/app/api/submissions/route');
      30 |     const res = await route.GET(new Request('http://localhost/api/submissions?assignment_id=00000000-0000-0000-0000-000000000999', { headers: { 'x-test-auth': 'student' } } as any) as any);
    > 31 |     expect([401,403]).toContain(res.status);
         |                       ^
      32 |   });
      33 | });
      34 |

      at Object.<anonymous> (unit/db.rls.negative.spec.ts:31:23)

FAIL unit/middleware.security-headers.more.spec.ts
  ‚óè middleware additional security headers ‚Ä∫ sets Referrer-Policy, X-Content-Type-Options, COOP, CORP, Permissions-Policy

    TypeError: server_1.NextResponse.next is not a function

      84 |     }
      85 |   } catch {}
    > 86 |   const res = NextResponse.next({ request: { headers } });
         |                            ^
      87 |   res.headers.set("x-request-id", requestId);
      88 |   res.headers.set("Content-Security-Policy", csp);
      89 |   if (process.env.NODE_ENV === 'production') {

      at Object.middleware (../apps/web/middleware.ts:86:28)
      at Object.<anonymous> (unit/middleware.security-headers.more.spec.ts:25:29)

  ‚óè middleware additional security headers ‚Ä∫ sets HSTS only in production

    TypeError: server_1.NextResponse.next is not a function

      84 |     }
      85 |   } catch {}
    > 86 |   const res = NextResponse.next({ request: { headers } });
         |                            ^
      87 |   res.headers.set("x-request-id", requestId);
      88 |   res.headers.set("Content-Security-Policy", csp);
      89 |   if (process.env.NODE_ENV === 'production') {

      at Object.middleware (../apps/web/middleware.ts:86:28)
      at Object.<anonymous> (unit/middleware.security-headers.more.spec.ts:36:32)

FAIL unit/api.runtime.outcomes.rate-limit.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.runtime.outcomes.rate-limit.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.runtime.outcomes.rate-limit.spec.ts:2:1)

FAIL unit/api.enrollments.spec.ts
  ‚óè API /api/enrollments ‚Ä∫ POST unauth ‚Üí 401; non-student ‚Üí 403; student ‚Üí 201 with own student_id

    expect(received).toBe(expected) // Object.is equality

    Expected: "test-student-id"
    Received: "22222222-2222-2222-2222-222222222222"

      28 | 		expect(res.status).toBe(201);
      29 | 		const json = await res.json();
    > 30 | 		expect(json.student_id).toBe('test-student-id');
         | 		                        ^
      31 | 	});
      32 |
      33 | 	test('GET unauth ‚Üí 401; echoes x-request-id', async () => {

      at Object.<anonymous> (unit/api.enrollments.spec.ts:30:27)

FAIL unit/api.providers.health.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.providers.health.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.providers.health.spec.ts:2:1)

FAIL unit/api.notifications.rate-limit.spec.ts
  ‚óè notifications rate-limit headers ‚Ä∫ GET list returns 429 with standard headers when limited

    expect(received).toBe(expected) // Object.is equality

    Expected: 429
    Received: 200

      18 |   test('GET list returns 429 with standard headers when limited', async () => {
      19 |     const res = await (NotifGET as any)(get('http://localhost/api/notifications'));
    > 20 |     expect(res.status).toBe(429);
         |                        ^
      21 |     expect(res.headers.get('retry-after')).toBeTruthy();
      22 |     expect(res.headers.get('x-rate-limit-remaining')).toBe('0');
      23 |     expect(res.headers.get('x-rate-limit-reset')).toBeTruthy();

      at Object.<anonymous> (unit/api.notifications.rate-limit.spec.ts:20:24)

FAIL unit/api.assignments.post.csrf.spec.ts
  ‚óè assignments POST CSRF double-submit ‚Ä∫ 403 missing/mismatched tokens; 201 when matched

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [200, 201]

      26 |     // Match
      27 |     res = await (AssignmentsPOST as any)(post(payload, { origin: 'http://localhost', referer: 'http://localhost/x', cookie: 'csrf_token=t', 'x-csrf-token': 't' }));
    > 28 |     expect([200,201]).toContain(res.status);
         |                       ^
      29 |   });
      30 | });
      31 |

      at Object.<anonymous> (unit/api.assignments.post.csrf.spec.ts:28:23)

FAIL unit/api.quizzes.ratelimit.spec.ts
  ‚óè quizzes rate-limit headers on PATCH/DELETE ‚Ä∫ PATCH returns 429 with standard headers when limited

    ZodError: [
      {
        "code": "too_small",
        "minimum": 3,
        "type": "string",
        "inclusive": true,
        "exact": false,
        "message": "String must contain at least 3 character(s)",
        "path": [
          "title"
        ]
      }
    ]

      93 |   } catch {}
      94 |   const body = await req.json();
    > 95 |   const parsed = quizUpdateRequest.parse(body);
         |                                    ^
      96 |   const out = await updateQuizApi(q.id, parsed);
      97 |   try {
      98 |     const dto = quizDto.parse(out);

      at Object.get error [as error] (../node_modules/zod/v3/types.cjs:45:31)
      at ZodEffects.parse (../node_modules/zod/v3/types.cjs:120:22)
      at PATCH (../apps/web/src/app/api/quizzes/route.ts:95:36)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.quizzes.ratelimit.spec.ts:15:17)

FAIL unit/future.observability.logs.spec.ts
  ‚óè observability logs (services) ‚Ä∫ dash_teacher_widgets and dash_student_widgets include ms

    TypeError: Cannot set properties of undefined (setting 'length')

      23 |   test('dash_teacher_widgets and dash_student_widgets include ms', async () => {
      24 |     const logs: any[] = (loggerMod as any).__TEST_LOGS__;
    > 25 |     logs.length = 0;
         |                ^
      26 |     await dashboardSvc.getDashboardForUser('test-teacher-id', 'teacher');
      27 |     await dashboardSvc.getDashboardForUser('test-student-id', 'student');
      28 |     expect(logs.some(l => l.msg === 'dash_teacher_widgets' && typeof l.obj?.ms === 'number')).toBe(true);

      at Object.<anonymous> (unit/future.observability.logs.spec.ts:25:16)

  ‚óè observability logs (services) ‚Ä∫ progress_marked counter emitted on completion

    TypeError: Cannot set properties of undefined (setting 'length')

      32 |   test('progress_marked counter emitted on completion', async () => {
      33 |     const logs: any[] = (loggerMod as any).__TEST_LOGS__;
    > 34 |     logs.length = 0;
         |                ^
      35 |     const out = await progressSvc.markLessonComplete('u1', '00000000-0000-0000-0000-000000000001');
      36 |     expect(out.lessonId).toBeTruthy();
      37 |     expect(logs.some(l => l.msg === 'progress_marked' && typeof l.obj?.ms === 'number')).toBe(true);

      at Object.<anonymous> (unit/future.observability.logs.spec.ts:34:16)

FAIL unit/api.progress.errors.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.progress.errors.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.progress.errors.spec.ts:3:1)

FAIL unit/api.events.behavior.spec.ts
  ‚óè Events API behavior ‚Ä∫ test-mode: POST 201 and GET lists event; 401 unauth

    expect(received).toContain(expected) // indexOf

    Expected value: 500
    Received array: [201, 204]

      22 |     jest.spyOn(supa, 'getCurrentUserInRoute').mockResolvedValue({ id: 'u', user_metadata: { role: 'teacher' } } as any);
      23 |     res = await (EventsPOST as any)(post('http://localhost/api/events', { event_type: 'x', entity_type: 'y', entity_id: 'e1', meta: {} }));
    > 24 |     expect([201,204]).toContain(res.status); // test-mode -> 201
         |                       ^
      25 |     const list = await (EventsGET as any)(get('http://localhost/api/events'));
      26 |     expect(list.status).toBe(200);
      27 |   });

      at Object.<anonymous> (unit/api.events.behavior.spec.ts:24:23)

FAIL unit/api.teacher.grading-queue.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.teacher.grading-queue.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.teacher.grading-queue.spec.ts:3:19
      at Object.<anonymous> (../apps/web/src/app/api/teacher/grading-queue/route.ts:4:1)
      at Object.<anonymous> (unit/api.teacher.grading-queue.spec.ts:8:1)

FAIL unit/server.withRouteTiming.runtime-csrf-skip.spec.ts
  ‚óè withRouteTiming skips CSRF on /api/runtime/* ‚Ä∫ cross-origin POST to runtime path passes without same-origin or double-submit

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 403

      23 |     const handler = withRouteTiming(async () => new Response(JSON.stringify({ ok: true }), { status: 200 }));
      24 |     const res = await (handler as any)(mkReq('http://localhost/api/runtime/progress', 'POST', { origin: 'http://evil.example', referer: 'http://evil.example/p' }) as any);
    > 25 |     expect(res.status).toBe(200);
         |                        ^
      26 |     expect(res.headers.get('x-request-id')).toBeTruthy();
      27 |   });
      28 | });

      at Object.<anonymous> (unit/server.withRouteTiming.runtime-csrf-skip.spec.ts:25:24)

FAIL unit/middleware.csrf-cookie.spec.ts
  ‚óè middleware CSRF cookie issuance ‚Ä∫ sets csrf_token cookie when missing

    TypeError: server_1.NextResponse.next is not a function

      84 |     }
      85 |   } catch {}
    > 86 |   const res = NextResponse.next({ request: { headers } });
         |                            ^
      87 |   res.headers.set("x-request-id", requestId);
      88 |   res.headers.set("Content-Security-Policy", csp);
      89 |   if (process.env.NODE_ENV === 'production') {

      at Object.middleware (../apps/web/middleware.ts:86:28)
      at Object.<anonymous> (unit/middleware.csrf-cookie.spec.ts:38:29)

FAIL unit/api.files.content-type-default.spec.ts
  ‚óè files default content_type ‚Ä∫ defaults to application/octet-stream when omitted

    expect(received).toBe(expected) // Object.is equality

    Expected: "application/octet-stream"
    Received: "application/json"

      22 |     const { id } = await put.json();
      23 |     const dl = await (DownloadGET as any)(getUrl(`http://localhost/api/files/download-url?id=${id}`, { 'x-test-auth': 'student' }));
    > 24 |     expect(dl.headers.get('content-type')).toBe('application/octet-stream');
         |                                            ^
      25 |   });
      26 | });
      27 |

      at Object.<anonymous> (unit/api.files.content-type-default.spec.ts:24:44)

FAIL unit/api.progress.access.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.progress.access.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.progress.access.spec.ts:3:1)

FAIL unit/api.runtime.teacher.outcomes.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.runtime.teacher.outcomes.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.runtime.teacher.outcomes.spec.ts:2:1)

FAIL unit/api.messages.read-all.spec.ts
  ‚óè API /api/messages/threads/[id]/read-all ‚Ä∫ marks all messages as read for participant; non-participant remains unaffected (TEST_MODE)

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

      24 |     globalThis.__TEST_HEADERS_STORE__?.cookies?.set?.('x-test-auth', 'student');
      25 |     const res = await (ReadAllPATCH as any)(makePatch(`http://localhost/api/messages/threads/${th.id}/read-all`), { params: { id: th.id } } as any);
    > 26 |     expect(res.status).toBe(200);
         |                        ^
      27 |     const json = await res.json();
      28 |     expect(json.ok).toBe(true);
      29 |   });

      at Object.<anonymous> (unit/api.messages.read-all.spec.ts:26:24)

FAIL unit/api.files.resolve.spec.ts
  ‚óè API /api/files/resolve ‚Ä∫ test-mode: returns mapping for keys with signed download-url

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

      22 |   test('test-mode: returns mapping for keys with signed download-url', async () => {
      23 |     const res = await (ResolvePOST as any)(makePost({ keys: ['abc', 'x y', 'z/1'] }, { 'x-test-auth': 'student' }));
    > 24 |     expect(res.status).toBe(200);
         |                        ^
      25 |     const json = await res.json();
      26 |     expect(json['abc'].url).toBe('/api/files/download-url?id=abc');
      27 |     expect(json['x y'].url).toBe('/api/files/download-url?id=x%20y');

      at Object.<anonymous> (unit/api.files.resolve.spec.ts:24:24)

FAIL unit/middleware.security-headers.spec.ts
  ‚óè middleware security headers ‚Ä∫ sets X-Frame-Options: DENY and CSP frame-ancestors none

    TypeError: server_1.NextResponse.next is not a function

      84 |     }
      85 |   } catch {}
    > 86 |   const res = NextResponse.next({ request: { headers } });
         |                            ^
      87 |   res.headers.set("x-request-id", requestId);
      88 |   res.headers.set("Content-Security-Policy", csp);
      89 |   if (process.env.NODE_ENV === 'production') {

      at Object.middleware (../apps/web/middleware.ts:86:28)
      at Object.<anonymous> (unit/middleware.security-headers.spec.ts:30:29)

FAIL unit/api.runtime.outcomes.jwks.rotation.spec.ts
  ‚óè runtime outcomes JWKS rotation ‚Ä∫ refreshes JWKS on verify failure

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 201]

      21 |     const req = new Request('http://localhost/api/runtime/outcomes', { method: 'POST', headers: { 'content-type': 'application/json', authorization: 'Bearer PROVIDERJWT' } as any, body: JSON.stringify({ courseId: 'c1', userId: 'u1', event: { type: 'attempt.completed', runtimeAttemptId: 'ra1', score: 1, max: 1, passed: true } }) } as any);
      22 |     const res = await route.POST(req as any);
    > 23 |     expect([200,201]).toContain(res.status);
         |                       ^
      24 |   });
      25 | });
      26 |

      at Object.<anonymous> (unit/api.runtime.outcomes.jwks.rotation.spec.ts:23:23)

FAIL unit/api.courses.transfer-owner.audit.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.courses.transfer-owner.audit.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.courses.transfer-owner.audit.spec.ts:3:1)

FAIL unit/api.health.requiredEnvs.spec.ts
  ‚óè api.health requiredEnvs snapshot ‚Ä∫ includes Supabase keys and runtime keys when RUNTIME_API_V2=1

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: undefined

      19 |     expect(json.requiredEnvs.NEXT_PUBLIC_SUPABASE_URL).toBe(true);
      20 |     expect(json.requiredEnvs.NEXT_PUBLIC_SUPABASE_ANON_KEY).toBe(true);
    > 21 |     expect(json.requiredEnvs.NEXT_RUNTIME_PUBLIC_KEY).toBe(true);
         |                                                       ^
      22 |     expect(json.requiredEnvs.NEXT_RUNTIME_PRIVATE_KEY).toBe(true);
      23 |     expect(json.requiredEnvs.NEXT_RUNTIME_KEY_ID).toBe(true);
      24 |   });

      at Object.<anonymous> (unit/api.health.requiredEnvs.spec.ts:21:55)

FAIL unit/db.rls.assignments.negative.spec.ts
  ‚óè Assignments RLS/authorization negatives ‚Ä∫ student cannot create assignment

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 403]

      4 |     const req = new Request('http://localhost/api/assignments', { method: 'POST', headers: { 'content-type': 'application/json', 'x-test-auth': 'student' } as any, body: JSON.stringify({ course_id: 'c1', title: 'X', points: 10, due_at: null }) } as any);
      5 |     const res = await route.POST(req as any);
    > 6 |     expect([401,403]).toContain(res.status);
        |                       ^
      7 |   });
      8 |
      9 |   test('student cannot update assignment', async () => {

      at Object.<anonymous> (unit/db.rls.assignments.negative.spec.ts:6:23)

FAIL unit/api.providers.get.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.providers.get.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.providers.get.spec.ts:3:1)

FAIL unit/api.headers.security.spec.ts
  ‚óè security headers (CSP frame-ancestors + X-Frame-Options) ‚Ä∫ middleware sets CSP frame-ancestors none and X-Frame-Options DENY

    TypeError: server_1.NextResponse.next is not a function

      84 |     }
      85 |   } catch {}
    > 86 |   const res = NextResponse.next({ request: { headers } });
         |                            ^
      87 |   res.headers.set("x-request-id", requestId);
      88 |   res.headers.set("Content-Security-Policy", csp);
      89 |   if (process.env.NODE_ENV === 'production') {

      at Object.middleware (../apps/web/middleware.ts:86:28)
      at Object.<anonymous> (unit/api.headers.security.spec.ts:29:29)

FAIL unit/api.events.producers.spec.ts
  ‚óè Event producers (TEST_MODE) ‚Ä∫ lesson complete records event

    expect(received).toBeTruthy()

    Received: undefined

       9 |     await markLessonComplete('22222222-2222-2222-2222-222222222222', 'aaaaaaaa-aaaa-aaaa-aaaa-000000000111');
      10 |     const ev = getInMemoryEvents().find(e => e.event_type === 'lesson.complete');
    > 11 |     expect(ev).toBeTruthy();
         |                ^
      12 |   });
      13 |
      14 |   test('submission create and grade records events', async () => {

      at Object.<anonymous> (unit/api.events.producers.spec.ts:11:16)

  ‚óè Event producers (TEST_MODE) ‚Ä∫ submission create and grade records events

    expect(received).toBeTruthy()

    Received: undefined

      17 |     const sub = await createSubmissionApi({ assignment_id: 'aaaaaaaa-aaaa-aaaa-aaaa-000000000222', text: '' } as any, '22222222-2222-2222-2222-222222222222');
      18 |     const createEv = getInMemoryEvents().find(e => e.event_type === 'assignment.submit');
    > 19 |     expect(createEv).toBeTruthy();
         |                      ^
      20 |     await gradeSubmissionApi(sub.id, { score: 95 }, '11111111-1111-1111-1111-111111111111');
      21 |     const gradeEv = getInMemoryEvents().find(e => e.event_type === 'assignment.graded');
      22 |     expect(gradeEv).toBeTruthy();

      at Object.<anonymous> (unit/api.events.producers.spec.ts:19:22)

FAIL unit/api.files.upload-url.quota.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.files.upload-url.quota.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.files.upload-url.quota.spec.ts:2:1)

FAIL unit/api.reports.dto.spec.ts
  ‚óè reports endpoints headers and DTO-like responses ‚Ä∫ GET /api/reports/grade-distribution CSV includes header and x-request-id

    expect(received).toBeTruthy()

    Received: false

      20 |     expect(res.headers.get('x-request-id')).toBeTruthy();
      21 |     const ct = res.headers.get('content-type') || '';
    > 22 |     expect(ct.includes('text/csv')).toBeTruthy();
         |                                     ^
      23 |   });
      24 | });
      25 |

      at Object.<anonymous> (unit/api.reports.dto.spec.ts:22:37)

FAIL unit/api.notifications.patch.csrf.spec.ts
  ‚óè notifications preferences PATCH respects CSRF double-submit ‚Ä∫ 403 when tokens missing or mismatched; 200 when matched

    expect(received).toContain(expected) // indexOf

    Expected value: 401
    Received array: [200]

      17 |     // Match -> 200
      18 |     res = await (NotifPrefsPATCH as any)(patch({ origin: 'http://localhost', referer: 'http://localhost/p', cookie: 'csrf_token=t', 'x-csrf-token': 't', 'content-type': 'application/json' }));
    > 19 |     expect([200]).toContain(res.status);
         |                   ^
      20 |   });
      21 | });
      22 |

      at Object.<anonymous> (unit/api.notifications.patch.csrf.spec.ts:19:19)

FAIL unit/ui/TeacherAnnouncements.spec.tsx
  ‚óè Teacher Announcements (labs) ‚Ä∫ renders course count and announcement list with jitter

    TypeError: c.getAll is not a function

      11 |   const h = headers();
      12 |   const c = cookies();
    > 13 |   const cookieHeader = h.get("cookie") ?? c.getAll().map(x => `${x.name}=${x.value}`).join("; ");
         |                                             ^
      14 |   const testAuth = h.get("x-test-auth") ?? c.get("x-test-auth")?.value;
      15 |
      16 |   const baseHeaders = { ...(cookieHeader ? { cookie: cookieHeader } : {}), ...(testAuth ? { "x-test-auth": testAuth } : {}) } as HeadersInit;

      at TeacherAnnouncementsPage (../apps/web/src/app/labs/teacher/announcements/page.tsx:13:45)
      at Object.<anonymous> (unit/ui/TeacherAnnouncements.spec.tsx:25:46)

FAIL unit/api.user-profile.put.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.user-profile.put.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.user-profile.put.spec.ts:3:1)

FAIL unit/ui/TeacherCourseInsightsAdvanced.spec.tsx
  ‚óè Teacher Course Insights (Advanced) ‚Ä∫ renders table and totals with jitter

    TypeError: cookieStore.getAll is not a function

      15 |   const cookieStore = cookies();
      16 |   const incoming = headers();
    > 17 |   const cookieHeader = cookieStore.getAll().map(c => `${c.name}=${c.value}`).join("; ");
         |                                    ^
      18 |   const xTestAuth = incoming.get("x-test-auth") ?? cookieStore.get("x-test-auth")?.value;
      19 |
      20 |   const baseHeaders: HeadersInit = {

      at TeacherCourseInsightsAdvancedPage (../apps/web/src/app/labs/teacher/course-insights-advanced/page.tsx:17:36)
      at Object.<anonymous> (unit/ui/TeacherCourseInsightsAdvanced.spec.tsx:27:55)

FAIL unit/api.files.download-url.dev-namespace.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.files.download-url.dev-namespace.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.files.download-url.dev-namespace.spec.ts:3:1)

FAIL unit/api.providers.create.negatives.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.providers.create.negatives.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.providers.create.negatives.spec.ts:3:1)

FAIL unit/api.providers.create.happy-path.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.providers.create.happy-path.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.providers.create.happy-path.spec.ts:3:1)

FAIL unit/api.messages.post.ratelimit.spec.ts
  ‚óè messages POST rate limit headers ‚Ä∫ returns 429 with standard headers when rate-limited

    expect(received).toBe(expected) // Object.is equality

    Expected: 429
    Received: 201

      19 |   test('returns 429 with standard headers when rate-limited', async () => {
      20 |     const res = await (MessagesPOST as any)(post({ thread_id: '00000000-0000-0000-0000-000000000001', body: 'hello' }));
    > 21 |     expect(res.status).toBe(429);
         |                        ^
      22 |     expect(res.headers.get('retry-after')).toBeTruthy();
      23 |     expect(res.headers.get('x-rate-limit-reset')).toBeTruthy();
      24 |     expect(res.headers.get('x-rate-limit-remaining')).toBe('0');

      at Object.<anonymous> (unit/api.messages.post.ratelimit.spec.ts:21:24)

FAIL unit/api.providers.health.ratelimit.spec.ts
  ‚óè providers health rate-limit headers ‚Ä∫ 429 includes retry-after and x-rate-limit-* headers

    TypeError: supabase.from(...).select(...).eq is not a function

      33 |
      34 |   const supabase = getRouteHandlerSupabase();
    > 35 |   const { data: row, error } = await supabase.from('course_providers').select('id,name,jwks_url,domain').eq('id', q.id).single();
         |                                                                                                          ^
      36 |   if (error) return NextResponse.json({ error: { code: 'DB_ERROR', message: error.message }, requestId }, { status: 500, headers: { 'x-request-id': requestId } });
      37 |   if (!row) return NextResponse.json({ error: { code: 'NOT_FOUND', message: 'Provider not found' }, requestId }, { status: 404, headers: { 'x-request-id': requestId } });
      38 |

      at GET (../apps/web/src/app/api/providers/health/route.ts:35:106)
      at Object.GET (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.providers.health.ratelimit.spec.ts:17:15)

FAIL unit/api.files.quota.enforcement.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.files.quota.enforcement.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.files.quota.enforcement.spec.ts:2:1)

FAIL unit/api.enrollments.launch-token.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.enrollments.launch-token.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.enrollments.launch-token.spec.ts:3:1)

FAIL unit/gateways/reports.gateway.spec.ts
  ‚óè ReportsGateway ‚Ä∫ engagement returns counters (course scoped)

    expect(received).toBe(expected) // Object.is equality

    Expected: 3
    Received: 12

      15 |     }));
      16 |     const out = await createReportsGateway().engagement('c-1');
    > 17 |     expect(out.lessons).toBe(3);
         |                         ^
      18 |     expect(out.assignments).toBe(2);
      19 |   });
      20 |

      at Object.<anonymous> (unit/gateways/reports.gateway.spec.ts:17:25)

  ‚óè ReportsGateway ‚Ä∫ gradeDistribution returns shape (admin/global)

    expect(received).toBe(expected) // Object.is equality

    Expected: 10
    Received: 42

      28 |     }));
      29 |     const out = await createReportsGateway().gradeDistribution();
    > 30 |     expect(out.total).toBe(10);
         |                       ^
      31 |     expect(out.dist[0].bucket).toBe('80-89');
      32 |   });
      33 | });

      at Object.<anonymous> (unit/gateways/reports.gateway.spec.ts:30:23)

FAIL unit/api.files.av-and-quota.negatives.spec.ts
  ‚óè files AV stub and quota exceed ‚Ä∫ EICAR-like content rejected

    expect(received).toContain(expected) // indexOf

    Expected value: 500
    Received array: [400, 200]

      14 |     const id = encodeURIComponent(j.key || 'k');
      15 |     const res = await (UploadPUT as any)(put(`?owner_type=user&owner_id=u1&content_type=text/plain`, `X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*`));
    > 16 |     expect([400,200]).toContain(res.status);
         |                       ^
      17 |   });
      18 | });
      19 |

      at Object.<anonymous> (unit/api.files.av-and-quota.negatives.spec.ts:16:23)

FAIL unit/middleware.coep.flag.spec.ts
  ‚óè middleware COEP flag ‚Ä∫ sets Cross-Origin-Embedder-Policy when COEP=1

    TypeError: server_1.NextResponse.next is not a function

      84 |     }
      85 |   } catch {}
    > 86 |   const res = NextResponse.next({ request: { headers } });
         |                            ^
      87 |   res.headers.set("x-request-id", requestId);
      88 |   res.headers.set("Content-Security-Policy", csp);
      89 |   if (process.env.NODE_ENV === 'production') {

      at Object.middleware (../apps/web/middleware.ts:86:28)
      at Object.<anonymous> (unit/middleware.coep.flag.spec.ts:29:29)

FAIL unit/api.flags.spec.ts
  ‚óè Feature flags API (test-mode) ‚Ä∫ GET requires auth, returns list; PATCH validates key

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

      16 |     // PATCH toggle a flag
      17 |     const ok = await route.PATCH(new Request('http://localhost/api/flags', { method: 'PATCH', headers: { 'content-type': 'application/json', 'x-test-auth': 'admin' }, body: JSON.stringify({ key: 'reports.enabled', value: true }) }) as any);
    > 18 |     expect(ok.status).toBe(200);
         |                       ^
      19 |   });
      20 | });
      21 |

      at Object.<anonymous> (unit/api.flags.spec.ts:18:23)

FAIL unit/api.runtime.jwks.rotation.spec.ts
  ‚óè runtime JWKS rotation (kid refresh) ‚Ä∫ on verify failure, JWKS cache clears and a subsequent verify can succeed

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 403]

      10 |     const body = { courseId: 'c1', userId: 'u1', event: { type: 'progress', pct: 10 } };
      11 |     const bad = await (OutcomesPOST as any)(post(body, { authorization: 'Bearer bad.token.value' }));
    > 12 |     expect([401,403]).toContain(bad.status);
         |                       ^
      13 |     // Clear cache hook (simulated by env toggle) and retry
      14 |     (process as any).env.JWKS_TTL_MS = '1';
      15 |     const again = await (OutcomesPOST as any)(post(body, { authorization: 'Bearer bad.token.value' }));

      at Object.<anonymous> (unit/api.runtime.jwks.rotation.spec.ts:12:23)

FAIL unit/api.reports.activity-retention.spec.ts
  ‚óè API /api/reports/activity & /api/reports/retention (TEST_MODE) ‚Ä∫ retention returns array of { day, dau } when authed

    TypeError: supabase.from(...).select(...).order is not a function

      15 |   try { q = parseQuery(req, qSchema); } catch (e: any) { return NextResponse.json({ error: { code: 'BAD_REQUEST', message: e.message }, requestId }, { status: 400, headers: { 'x-request-id': requestId } }); }
      16 |   const supabase = getRouteHandlerSupabase();
    > 17 |   let builder: any = supabase.from('daily_active_users').select('day,dau').order('day', { ascending: true });
         |                                                                            ^
      18 |   if (q.from) builder = builder.gte('day', q.from);
      19 |   if (q.to) builder = builder.lte('day', q.to);
      20 |   const { data, error } = await builder;

      at GET (../apps/web/src/app/api/reports/retention/route.ts:17:76)
      at Object.GET (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.reports.activity-retention.spec.ts:22:17)

FAIL unit/api.files.upload-url.spec.ts
  ‚óè api.files.upload-url ‚Ä∫ returns signed fields in test-mode

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 403

      18 |     globalThis.__TEST_HEADERS_STORE__.cookies.set('x-test-auth', 'student');
      19 |     const res = await (UploadPOST as any)(makeReq({ owner_type: 'user', owner_id: 'test-student-id', content_type: 'text/plain' }, { 'x-test-auth': 'student' }));
    > 20 |     expect(res.status).toBe(200);
         |                        ^
      21 |     const json = await res.json();
      22 |     expect(json.url).toContain('/api/files/upload-url');
      23 |     expect(json.fields).toBeDefined();

      at Object.<anonymous> (unit/api.files.upload-url.spec.ts:20:24)

FAIL unit/api.courses.transfer-owner.ratelimit.spec.ts
  ‚óè courses transfer-owner rate-limit headers ‚Ä∫ returns 429 with standard headers when limited

    TypeError: supabase.from(...).select(...).eq is not a function

      38 |   // Only current teacher owner or admin can transfer
      39 |   if (role !== 'admin') {
    > 40 |     const { data: course } = await supabase.from('courses').select('id,teacher_id').eq('id', params.id).single();
         |                                                                                     ^
      41 |     if (!course || (course as any).teacher_id !== user.id) {
      42 |       return NextResponse.json({ error: { code: 'FORBIDDEN', message: 'Not allowed' }, requestId }, { status: 403, headers: { 'x-request-id': requestId } });
      43 |     }

      at PATCH (../apps/web/src/app/api/courses/[id]/transfer-owner/route.ts:40:85)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.courses.transfer-owner.ratelimit.spec.ts:12:17)

FAIL unit/api.files.download-url.dev-namespace.guard.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.files.download-url.dev-namespace.guard.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.files.download-url.dev-namespace.guard.spec.ts:2:1)

FAIL unit/api.files.upload-url.ratelimit.spec.ts
  ‚óè files upload-url rate limit headers ‚Ä∫ 429 includes rate limit headers

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 401]

      15 |     const payload = { owner_type: 'user', owner_id: 'test-student-id', content_type: 'text/plain' };
      16 |     const res1 = await (UploadPOST as any)(req(payload));
    > 17 |     expect([200,401]).toContain(res1.status);
         |                       ^
      18 |     const res2 = await (UploadPOST as any)(req(payload));
      19 |     if (res2.status === 429) {
      20 |       expect(res2.headers.get('retry-after')).toBeTruthy();

      at Object.<anonymous> (unit/api.files.upload-url.ratelimit.spec.ts:17:23)

FAIL unit/api.attachments.delete.permissions.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.attachments.delete.permissions.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.attachments.delete.permissions.spec.ts:3:1)

FAIL unit/api.user.role.audit.spec.ts
  ‚óè Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.user.role.audit.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.user.role.audit.spec.ts:2:1)

FAIL unit/api.admin.quotas.ratelimit.spec.ts
  ‚óè admin quotas PATCH rate-limit headers ‚Ä∫ returns 429 and retry-after header when limited

    TypeError: supabase.from(...).upsert is not a function

      52 |   if (typeof body.max_bytes === 'number') row.max_bytes = body.max_bytes;
      53 |   if (typeof body.used_bytes === 'number') row.used_bytes = body.used_bytes;
    > 54 |   const { error } = await supabase.from('user_storage_quotas').upsert(row, { onConflict: 'user_id' } as any);
         |                                                                ^
      55 |   if (error) return NextResponse.json({ error: { code: 'DB_ERROR', message: error.message }, requestId }, { status: 500, headers: { 'x-request-id': requestId } });
      56 |   return jsonDto({ ok: true } as any, z.object({ ok: z.boolean() }) as any, { requestId, status: 200 });
      57 | });

      at PATCH (../apps/web/src/app/api/admin/quotas/route.ts:54:64)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.admin.quotas.ratelimit.spec.ts:14:17)

FAIL unit/gateways/enrollments.gateway.spec.ts
  ‚óè EnrollmentsGateway.list ‚Ä∫ returns enrollments array

    ZodError: [
      {
        "validation": "uuid",
        "code": "invalid_string",
        "message": "Invalid uuid",
        "path": [
          0,
          "id"
        ]
      },
      {
        "validation": "uuid",
        "code": "invalid_string",
        "message": "Invalid uuid",
        "path": [
          0,
          "course_id"
        ]
      },
      {
        "validation": "uuid",
        "code": "invalid_string",
        "message": "Invalid uuid",
        "path": [
          1,
          "id"
        ]
      },
      {
        "validation": "uuid",
        "code": "invalid_string",
        "message": "Invalid uuid",
        "path": [
          1,
          "course_id"
        ]
      }
    ]

      100 |     throw new Error(`${code}: ${message}`);
      101 |   }
    > 102 |   return schema.parse(json) as T;
          |                 ^
      103 | }
      104 |
      105 |

      at Object.get error [as error] (../node_modules/zod/v3/types.cjs:45:31)
      at ZodArray.parse (../node_modules/zod/v3/types.cjs:120:22)
      at fetchJson (../apps/web/src/lib/serverFetch.ts:102:17)
      at Object.<anonymous> (unit/gateways/enrollments.gateway.spec.ts:27:18)

FAIL unit/lib.runtimeAuth.clockskew.spec.ts
  ‚óè runtimeAuth clock skew tolerance ‚Ä∫ accepts tokens within tolerance window (dev HS256 path mocked)

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      12 |     const req = new Request('http://localhost/api/runtime/progress', { headers: { authorization: 'Bearer X', origin: 'https://wcgyhwvugdnzhegwiiam.lovable.app' } as any } as any);
      13 |     const out: any = await (verifyRuntimeAuthorization as any)(req as any, ['progress.write']);
    > 14 |     expect(out.ok).toBe(true);
         |                    ^
      15 |   });
      16 | });
      17 |

      at Object.<anonymous> (unit/lib.runtimeAuth.clockskew.spec.ts:14:20)

FAIL unit/ui/SystemHealthHistory.spec.tsx
  ‚óè System Health History (labs) ‚Ä∫ renders delta stats and timestamps with jitter

    ReferenceError: fetch is not defined

      72 |   }
      73 |   const started = Date.now();
    > 74 |   const res = await fetch(url, { cache: "no-store", ...init, headers: hdrs });
         |               ^
      75 |   try {
      76 |     const ms = Date.now() - started;
      77 |     // eslint-disable-next-line no-console

      at serverFetch (../apps/web/src/lib/serverFetch.ts:74:15)
      at fetchJson (../apps/web/src/lib/serverFetch.ts:88:21)
      at Object.get (../apps/web/src/lib/data/health.ts:14:23)
      at takeSamples (../apps/web/src/app/labs/system/health-history/page.tsx:11:47)
      at HealthHistoryPage (../apps/web/src/app/labs/system/health-history/page.tsx:34:25)
      at Object.<anonymous> (unit/ui/SystemHealthHistory.spec.tsx:15:39)

FAIL unit/api.runtime.outcomes.iss-aud.negatives.spec.ts
  ‚óè runtime outcomes provider JWT iss/aud negatives ‚Ä∫ invalid issuer/audience format yields 403 when present

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 403]

      10 |     // Without a real JWT, this exercises the code path expectation only; actual 401/403 depends on signature verify
      11 |     const res = await (OutcomesPOST as any)(post(body, { authorization: 'Bearer bad.token.value' }));
    > 12 |     expect([401,403]).toContain(res.status);
         |                       ^
      13 |   });
      14 | });
      15 |

      at Object.<anonymous> (unit/api.runtime.outcomes.iss-aud.negatives.spec.ts:12:23)

FAIL unit/ui/SystemUptimeTile.spec.tsx
  ‚óè System Uptime Tile (labs) ‚Ä∫ renders ok and ts fields under jitter

    Unable to find an element by: [data-testid="uptime-ok"]

    Ignored nodes: comments, script, style
    [36m<body>[39m
      [36m<div>[39m
        [36m<main[39m
          [33mclass[39m=[32m"p-6"[39m
        [36m>[39m
          [36m<h1[39m
            [33mclass[39m=[32m"text-xl font-semibold"[39m
          [36m>[39m
            [0mSystem uptime[0m
          [36m</h1>[39m
          [36m<p[39m
            [33mclass[39m=[32m"text-gray-700"[39m
          [36m>[39m
            [0mUnable to load uptime.[0m
          [36m</p>[39m
        [36m</main>[39m
      [36m</div>[39m
    [36m</body>[39m

      16 |     const ui = await UptimeTilePage();
      17 |     render(ui);
    > 18 |     await screen.findByTestId('uptime-ok');
         |                  ^
      19 |     await screen.findByTestId('uptime-ts-iso');
      20 |     await screen.findByTestId('uptime-ts-human');
      21 |   });

      at waitForWrapper (../node_modules/@testing-library/dom/dist/wait-for.js:163:27)
      at ../node_modules/@testing-library/dom/dist/query-helpers.js:86:33
      at Object.<anonymous> (unit/ui/SystemUptimeTile.spec.tsx:18:18)

FAIL unit/ui/StudentProfile.spec.tsx
  ‚óè Student Profile (labs) ‚Ä∫ renders email and role when authenticated

    Unable to find an element by: [data-testid="profile-email"]

    Ignored nodes: comments, script, style
    [36m<body>[39m
      [36m<div>[39m
        [36m<main[39m
          [33mclass[39m=[32m"p-6 space-y-3"[39m
        [36m>[39m
          [36m<h1[39m
            [33mclass[39m=[32m"text-xl font-semibold"[39m
            [33mdata-testid[39m=[32m"profile-title"[39m
          [36m>[39m
            [0mStudent Profile[0m
          [36m</h1>[39m
          [36m<p[39m
            [33mclass[39m=[32m"text-gray-700"[39m
            [33mdata-testid[39m=[32m"signin-prompt"[39m
          [36m>[39m
            [0mYou are not signed in[0m
          [36m</p>[39m
          [36m<a[39m
            [33mclass[39m=[32m"underline"[39m
            [33mdata-testid[39m=[32m"signin-link"[39m
            [33mhref[39m=[32m"/login"[39m
          [36m>[39m
            [0mGo to login[0m
          [36m</a>[39m
        [36m</main>[39m
      [36m</div>[39m
    [36m</body>[39m

      15 |     const ui = await StudentProfilePage();
      16 |     render(ui);
    > 17 |     expect(await screen.findByTestId('profile-email')).toHaveTextContent('s@example.com');
         |                         ^
      18 |     expect(await screen.findByTestId('profile-role')).toHaveTextContent('student');
      19 |   });
      20 | });

      at waitForWrapper (../node_modules/@testing-library/dom/dist/wait-for.js:163:27)
      at ../node_modules/@testing-library/dom/dist/query-helpers.js:86:33
      at Object.<anonymous> (unit/ui/StudentProfile.spec.tsx:17:25)

FAIL unit/ui/AdminReports.spec.tsx
  ‚óè Admin Reports (dashboard) ‚Ä∫ renders reports tiles

    TypeError: cc.getAll is not a function

       6 | 	const hh = headers();
       7 | 	const cc = cookies();
    >  8 | 	const cookie = hh.get("cookie") ?? cc.getAll().map(x => `${x.name}=${x.value}`).join("; ");
         | 	                                      ^
       9 | 	const ta = hh.get("x-test-auth") ?? cc.get("x-test-auth")?.value;
      10 | 	const gw = createReportsGateway();
      11 | 	const [engagement, grades, dau, activity] = await Promise.all([

      at AdminReportsPage (../apps/web/src/app/dashboard/admin/reports/page.tsx:8:40)
      at Object.<anonymous> (unit/ui/AdminReports.spec.tsx:18:38)

FAIL unit/ui/SystemRoleBadge.spec.tsx
  ‚óè System Role Badge (labs) ‚Ä∫ renders role and test mode

    ReferenceError: fetch is not defined

      72 |   }
      73 |   const started = Date.now();
    > 74 |   const res = await fetch(url, { cache: "no-store", ...init, headers: hdrs });
         |               ^
      75 |   try {
      76 |     const ms = Date.now() - started;
      77 |     // eslint-disable-next-line no-console

      at serverFetch (../apps/web/src/lib/serverFetch.ts:74:15)
      at fetchJson (../apps/web/src/lib/serverFetch.ts:88:21)
      at Object.get (../apps/web/src/lib/data/health.ts:14:23)
      at SystemRoleBadgePage (../apps/web/src/app/labs/system/role-badge/page.tsx:10:44)
      at Object.<anonymous> (unit/ui/SystemRoleBadge.spec.tsx:15:41)

FAIL unit/ui/SystemAuthCheck.spec.tsx
  ‚óè System Auth Check (labs) ‚Ä∫ renders email and role when authenticated

    TypeError: cookieStore.getAll is not a function

      14 |
      15 |   const cookieHeader = incomingHeaders.get("cookie") ?? cookieStore
    > 16 |     .getAll()
         |      ^
      17 |     .map((c) => `${c.name}=${c.value}`)
      18 |     .join("; ");
      19 |   const testAuthHeader = incomingHeaders.get("x-test-auth") ?? "";

      at AuthCheckPage (../apps/web/src/app/labs/system/auth-check/page.tsx:16:6)
      at Object.<anonymous> (unit/ui/SystemAuthCheck.spec.tsx:15:35)

FAIL unit/api.parent.progress.api.spec.ts
  ‚óè API /api/parent/progress (TEST_MODE) ‚Ä∫ parent linked to student gets data

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 403

      15 |     globalThis.__TEST_HEADERS_STORE__?.cookies?.set?.('x-test-auth', 'parent');
      16 |     const res = await (ParentProgressGET as any)(makeGet('http://localhost/api/parent/progress?student_id=22222222-2222-2222-2222-222222222222'));
    > 17 |     expect(res.status).toBe(200);
         |                        ^
      18 |   });
      19 | });
      20 |

      at Object.<anonymous> (unit/api.parent.progress.api.spec.ts:17:24)

FAIL unit/ui/ParentChildrenReport.spec.tsx
  ‚óè Parent Children Report (labs) ‚Ä∫ renders total and items

    TypeError: c.getAll is not a function

       8 |   const h = headers();
       9 |   const c = cookies();
    > 10 |   const cookieHeader = h.get("cookie") ?? c.getAll().map(x => `${x.name}=${x.value}`).join("; ");
         |                                             ^
      11 |   const testAuth = h.get("x-test-auth") ?? c.get("x-test-auth")?.value;
      12 |
      13 |   let rows: ParentLink[] = [];

      at ParentChildrenReportPage (../apps/web/src/app/labs/parent/children-report/page.tsx:10:45)
      at Object.<anonymous> (unit/ui/ParentChildrenReport.spec.tsx:17:46)

FAIL unit/ui/SystemOkCard.spec.tsx
  ‚óè System OK Card (labs) ‚Ä∫ renders ok and ts (human) on success

    TypeError: cookieStore.getAll is not a function

      22 |
      23 |   const cookieHeader = cookieStore
    > 24 |     .getAll()
         |      ^
      25 |     .map((c) => `${c.name}=${c.value}`)
      26 |     .join("; ");
      27 |   const xTestAuth = incomingHeaders.get("x-test-auth") ?? cookieStore.get("x-test-auth")?.value;

      at SystemOkCardPage (../apps/web/src/app/labs/system/ok-card/page.tsx:24:6)
      at Object.<anonymous> (unit/ui/SystemOkCard.spec.tsx:16:38)

FAIL unit/ui/SystemRequestId.spec.tsx
  ‚óè System Request ID (labs) ‚Ä∫ renders request-id from response headers when present

    expect(element).toHaveTextContent()

    Expected element to have text content:
      req-123
    Received:
      generated-1755692175865

      17 |     const ui = await RequestIdPage();
      18 |     render(ui);
    > 19 |     expect(await screen.findByTestId('request-id')).toHaveTextContent('req-123');
         |                                                     ^
      20 |   });
      21 | });
      22 |

      at Object.<anonymous> (unit/ui/SystemRequestId.spec.tsx:19:53)

FAIL unit/api.runtime.outcomes.iss-aud.strict.spec.ts
  ‚óè runtime outcomes strict iss/aud enforcement ‚Ä∫ issuer/audience mismatch against provider domain yields 403 (path exercise)

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 403]

       9 |     const body = { courseId: 'c1', userId: 'u1', event: { type: 'progress', pct: 10 } };
      10 |     const res = await (OutcomesPOST as any)(post(body, { authorization: 'Bearer bad.token.value' }));
    > 11 |     expect([401,403]).toContain(res.status);
         |                       ^
      12 |   });
      13 | });
      14 |

      at Object.<anonymous> (unit/api.runtime.outcomes.iss-aud.strict.spec.ts:11:23)

FAIL unit/ui/ParentChildren.spec.tsx
  ‚óè Parent Children (labs) ‚Ä∫ renders list with one linked student

    TypeError: c.getAll is not a function

       9 | 	const h = headers();
      10 | 	const c = cookies();
    > 11 | 	const cookieHeader = h.get("cookie") ?? c.getAll().map(x => `${x.name}=${x.value}`).join("; ");
         | 	                                          ^
      12 | 	const testAuth = h.get("x-test-auth") ?? c.get("x-test-auth")?.value;
      13 |
      14 | 	let links: ParentLink[] = [];

      at ParentChildrenListPage (../apps/web/src/app/labs/parent/children/page.tsx:11:44)
      at Object.<anonymous> (unit/ui/ParentChildren.spec.tsx:15:44)

FAIL unit/api.runtime.outcomes.alg-kid-iss-aud.spec.ts
  ‚óè runtime outcomes JWKS/JWT rotation and alg/aud/iss enforcement ‚Ä∫ rejects non-RS256 tokens

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 403]

       8 |   test('rejects non-RS256 tokens', async () => {
       9 |     const res = await (OutcomesPOST as any)(post({ courseId: 'c1', userId: 'u1', event: { type: 'progress', pct: 10 } }, { authorization: 'Bearer header.payload.sig' }));
    > 10 |     expect([401,403]).toContain(res.status);
         |                       ^
      11 |   });
      12 | });
      13 |

      at Object.<anonymous> (unit/api.runtime.outcomes.alg-kid-iss-aud.spec.ts:10:23)

FAIL unit/api.messages.read-all-thread.spec.ts
  ‚óè messages read-all by thread id ‚Ä∫ student marks thread as read in test-mode

    expect(received).toContain(expected) // indexOf

    Expected value: 500
    Received array: [200, 401]

      10 |     globalThis.__TEST_HEADERS_STORE__?.cookies?.set?.('x-test-auth', 'student');
      11 |     const res = await (ReadAllThreadPATCH as any)(patch('http://localhost/api/messages/threads/11111111-1111-1111-1111-111111111111/read-all'));
    > 12 |     expect([200,401]).toContain(res.status);
         |                       ^
      13 |   });
      14 | });
      15 |

      at Object.<anonymous> (unit/api.messages.read-all-thread.spec.ts:12:23)

FAIL unit/lib.testMode.spec.ts
  ‚óè testMode ‚Ä∫ isTestMode false otherwise

    expect(received).toBe(expected) // Object.is equality

    Expected: false
    Received: true

      22 |     delete (process.env as any).TEST_MODE;
      23 |     delete (process.env as any).PLAYWRIGHT;
    > 24 |     expect(isTestMode()).toBe(false);
         |                          ^
      25 |   });
      26 | });
      27 |

      at Object.<anonymous> (unit/lib.testMode.spec.ts:24:26)

FAIL unit/api.messages.guard.spec.ts
  ‚óè api.messages guard (MVP_PROD_GUARD) ‚Ä∫ guard enforced in production-like (non test-mode)

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 501]

      11 |     const res = await (MessagesGET as any)(makeReq('http://localhost/api/messages?thread_id=th1', { 'x-test-auth': 'student' }));
      12 |     // In non test-mode, auth may fail or MVP guard may block; accept 401 or 501
    > 13 |     expect([401, 501]).toContain(res.status);
         |                        ^
      14 |   });
      15 | });
      16 |

      at Object.<anonymous> (unit/api.messages.guard.spec.ts:13:24)

FAIL unit/api.notifications.read-all.spec.ts
  ‚óè notifications read-all ‚Ä∫ marks all read in test-mode

    TypeError: schema.safeParse is not a function

      18 |   const { requestId } = opts;
      19 |   const status = typeof opts.status === 'number' ? opts.status : 200;
    > 20 |   const parsed = (schema as any).safeParse(data);
         |                                  ^
      21 |   if (!parsed.success) {
      22 |     try { getRequestLogger(requestId).error({ issues: redactIssues(parsed.error.issues) }, 'dto_response_validation_failed'); } catch {}
      23 |     return NextResponse.json({ error: { code: 'INTERNAL', message: 'Invalid response shape' }, requestId }, { status: 500, headers: { 'x-request-id': requestId } });

      at jsonDto (../apps/web/src/lib/jsonDto.ts:20:34)
      at PATCH (../apps/web/src/app/api/notifications/read-all/route.ts:14:19)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.notifications.read-all.spec.ts:13:17)

FAIL unit/lib.metrics.inflight.spec.ts
  ‚óè metrics in-flight tracking ‚Ä∫ increments and decrements per route

    expect(received).toBe(expected) // Object.is equality

    Expected: 2
    Received: 0

       9 |     incrInFlight(route);
      10 |     let s1 = snapshot();
    > 11 |     expect((s1[route]?.in_flight || 0)).toBe(before + 2);
         |                                         ^
      12 |     decrInFlight(route);
      13 |     decrInFlight(route);
      14 |     s1 = snapshot();

      at Object.<anonymous> (unit/lib.metrics.inflight.spec.ts:11:41)


Test Suites: 106 failed, 233 passed, 339 total
Tests:       121 failed, 1 skipped, 14 todo, 441 passed, 577 total
Snapshots:   0 total
Time:        97.161 s
Ran all test suites.

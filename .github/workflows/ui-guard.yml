name: UI Guard
on:
  pull_request_target:
    branches: [ main ]

jobs:
  guard:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Determine changed files
        id: diff
        run: |
          base_sha="${{ github.event.pull_request.base.sha }}"
          head_sha="${{ github.event.pull_request.head.sha }}"
          echo "Base: $base_sha"
          echo "Head: $head_sha"
          git diff --name-only "$base_sha" "$head_sha" > changed.txt
          cat changed.txt
          echo "changed=$(tr '\n' ',' < changed.txt)" >> $GITHUB_OUTPUT
      - name: Fail if bot touches non-UI paths
        if: github.actor == 'lovable-dev[bot]'
        run: |
          if git diff --name-only "${{ github.event.pull_request.base.sha }}" "${{ github.event.pull_request.head.sha }}" | grep -vE '^packages/expertfolio-ui/'; then
            echo 'Bot PR modifies files outside packages/expertfolio-ui. Closing.'
            exit 1
          fi
  storybook:
    runs-on: ubuntu-latest
    if: contains(steps.diff.outputs.changed, 'packages/expertfolio-ui/')
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - name: Install deps
        run: npm install --ignore-scripts --legacy-peer-deps
      - name: Build UI storybook (dry)
        working-directory: packages/expertfolio-ui
        run: |
          npm ci --ignore-scripts --legacy-peer-deps || true
          npm run build-storybook || echo 'storybook build not configured; skipping'

